
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://bayareametro.github.io/tm2py/versioned-docs/api/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.13">
    
    
      
        <title>API Documentation - Travel Model Two Python Package: tm2py</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e411adfe.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="grey">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-documentation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Travel Model Two Python Package: tm2py" class="md-header__button md-logo" aria-label="Travel Model Two Python Package: tm2py" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Travel Model Two Python Package: tm2py
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Documentation
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="grey"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="grey"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/bayareametro/tm2py" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  
    
  


  <li class="md-tabs__item">
    <a href="./" class="md-tabs__link md-tabs__link--active">
      API Documentation
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../architecture/" class="md-tabs__link">
      Architecture
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../starting/" class="md-tabs__link">
      Starting Out
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../contributing/documentation/" class="md-tabs__link">
        Contributing
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Travel Model Two Python Package: tm2py" class="md-nav__button md-logo" aria-label="Travel Model Two Python Package: tm2py" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Travel Model Two Python Package: tm2py
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/bayareametro/tm2py" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          API Documentation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        API Documentation
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#controller" class="md-nav__link">
    Controller
  </a>
  
    <nav class="md-nav" aria-label="Controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.controller" class="md-nav__link">
    controller
  </a>
  
    <nav class="md-nav" aria-label="controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.controller.RunController" class="md-nav__link">
    RunController
  </a>
  
    <nav class="md-nav" aria-label="RunController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.controller.RunController.component" class="md-nav__link">
    component
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.controller.RunController.emme_manager" class="md-nav__link">
    emme_manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.controller.RunController.iteration" class="md-nav__link">
    iteration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.controller.RunController.run_dir" class="md-nav__link">
    run_dir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.controller.RunController.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.controller.RunController.validate_inputs" class="md-nav__link">
    validate_inputs()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#components" class="md-nav__link">
    Components
  </a>
  
    <nav class="md-nav" aria-label="Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#base-component" class="md-nav__link">
    Base Component
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component" class="md-nav__link">
    component
  </a>
  
    <nav class="md-nav" aria-label="component">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component" class="md-nav__link">
    Component
  </a>
  
    <nav class="md-nav" aria-label="Component">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.config" class="md-nav__link">
    config
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.controller" class="md-nav__link">
    controller
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.logger" class="md-nav__link">
    logger
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.top_sheet" class="md-nav__link">
    top_sheet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.trace" class="md-nav__link">
    trace
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.get_abs_path" class="md-nav__link">
    get_abs_path()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.get_emme_scenario" class="md-nav__link">
    get_emme_scenario()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.report_progress" class="md-nav__link">
    report_progress()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.test_component" class="md-nav__link">
    test_component()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.time_period_names" class="md-nav__link">
    time_period_names()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.validate_inputs" class="md-nav__link">
    validate_inputs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.verify" class="md-nav__link">
    verify()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.write_top_sheet" class="md-nav__link">
    write_top_sheet()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demand-components" class="md-nav__link">
    Demand Components
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.demand" class="md-nav__link">
    demand
  </a>
  
    <nav class="md-nav" aria-label="demand">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.demand.demand" class="md-nav__link">
    demand
  </a>
  
    <nav class="md-nav" aria-label="demand">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.demand.demand.PrepareDemand" class="md-nav__link">
    PrepareDemand
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.demand.demand.PrepareHighwayDemand" class="md-nav__link">
    PrepareHighwayDemand
  </a>
  
    <nav class="md-nav" aria-label="PrepareHighwayDemand">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.demand.demand.PrepareHighwayDemand.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-components" class="md-nav__link">
    Network Components
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network" class="md-nav__link">
    network
  </a>
  
    <nav class="md-nav" aria-label="network">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway" class="md-nav__link">
    highway
  </a>
  
    <nav class="md-nav" aria-label="highway">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_assign" class="md-nav__link">
    highway_assign
  </a>
  
    <nav class="md-nav" aria-label="highway_assign">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_assign.AssignmentClass" class="md-nav__link">
    AssignmentClass
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_assign.HighwayAssignment" class="md-nav__link">
    HighwayAssignment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_maz" class="md-nav__link">
    highway_maz
  </a>
  
    <nav class="md-nav" aria-label="highway_maz">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_maz.AssignMAZSPDemand" class="md-nav__link">
    AssignMAZSPDemand
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_maz.SkimMAZCosts" class="md-nav__link">
    SkimMAZCosts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_network" class="md-nav__link">
    highway_network
  </a>
  
    <nav class="md-nav" aria-label="highway_network">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_network.PrepareNetwork" class="md-nav__link">
    PrepareNetwork
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.transit" class="md-nav__link">
    transit
  </a>
  
    <nav class="md-nav" aria-label="transit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.transit.transit_assign" class="md-nav__link">
    transit_assign
  </a>
  
    <nav class="md-nav" aria-label="transit_assign">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.transit.transit_assign.TransitAssignment" class="md-nav__link">
    TransitAssignment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.transit.transit_skim" class="md-nav__link">
    transit_skim
  </a>
  
    <nav class="md-nav" aria-label="transit_skim">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.transit.transit_skim.TransitSkim" class="md-nav__link">
    TransitSkim
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#emme-wrappers" class="md-nav__link">
    Emme Wrappers
  </a>
  
    <nav class="md-nav" aria-label="Emme Wrappers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme" class="md-nav__link">
    emme
  </a>
  
    <nav class="md-nav" aria-label="emme">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager" class="md-nav__link">
    manager
  </a>
  
    <nav class="md-nav" aria-label="manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager" class="md-nav__link">
    EmmeManager
  </a>
  
    <nav class="md-nav" aria-label="EmmeManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.change_emmebank_dimensions" class="md-nav__link">
    change_emmebank_dimensions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.close_all" class="md-nav__link">
    close_all()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.copy_attr_values" class="md-nav__link">
    copy_attr_values()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.create_project" class="md-nav__link">
    create_project()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.emmebank" class="md-nav__link">
    emmebank()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.get_network" class="md-nav__link">
    get_network()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.logbook_trace" class="md-nav__link">
    logbook_trace()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.logbook_write" class="md-nav__link">
    logbook_write()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.modeller" class="md-nav__link">
    modeller()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.project" class="md-nav__link">
    project()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.temp_attributes_and_restore" class="md-nav__link">
    temp_attributes_and_restore()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.tool" class="md-nav__link">
    tool()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix" class="md-nav__link">
    matrix
  </a>
  
    <nav class="md-nav" aria-label="matrix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.MatrixCache" class="md-nav__link">
    MatrixCache
  </a>
  
    <nav class="md-nav" aria-label="MatrixCache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.MatrixCache.clear" class="md-nav__link">
    clear()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.MatrixCache.get_data" class="md-nav__link">
    get_data()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.MatrixCache.set_data" class="md-nav__link">
    set_data()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager" class="md-nav__link">
    OMXManager
  </a>
  
    <nav class="md-nav" aria-label="OMXManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.open" class="md-nav__link">
    open()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.read" class="md-nav__link">
    read()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.read_hdf5" class="md-nav__link">
    read_hdf5()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.write_array" class="md-nav__link">
    write_array()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.write_clipped_array" class="md-nav__link">
    write_clipped_array()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.write_matrices" class="md-nav__link">
    write_matrices()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.write_matrix" class="md-nav__link">
    write_matrix()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.network" class="md-nav__link">
    network
  </a>
  
    <nav class="md-nav" aria-label="network">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.network.NetworkCalculator" class="md-nav__link">
    NetworkCalculator
  </a>
  
    <nav class="md-nav" aria-label="NetworkCalculator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.network.NetworkCalculator.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.network.NetworkCalculator.add_calc" class="md-nav__link">
    add_calc()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.network.NetworkCalculator.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#errata" class="md-nav__link">
    Errata
  </a>
  
    <nav class="md-nav" aria-label="Errata">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.logger" class="md-nav__link">
    logger
  </a>
  
    <nav class="md-nav" aria-label="logger">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.logger.LogStartEnd" class="md-nav__link">
    LogStartEnd
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.logger.Logger" class="md-nav__link">
    Logger
  </a>
  
    <nav class="md-nav" aria-label="Logger">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.logger.Logger.log" class="md-nav__link">
    log()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.logger.Logger.log_end" class="md-nav__link">
    log_end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.logger.Logger.log_start" class="md-nav__link">
    log_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.logger.Logger.log_start_end" class="md-nav__link">
    log_start_end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.logger.Logger.log_time" class="md-nav__link">
    log_time()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.tools" class="md-nav__link">
    tools
  </a>
  
    <nav class="md-nav" aria-label="tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.tools.download_unzip" class="md-nav__link">
    download_unzip()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.tools.parse_num_processors" class="md-nav__link">
    parse_num_processors()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.examples" class="md-nav__link">
    examples
  </a>
  
    <nav class="md-nav" aria-label="examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.examples.get_example" class="md-nav__link">
    get_example()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../starting/" class="md-nav__link">
        Starting Out
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Contributing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Contributing" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Contributing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/documentation/" class="md-nav__link">
        Documentation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#controller" class="md-nav__link">
    Controller
  </a>
  
    <nav class="md-nav" aria-label="Controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.controller" class="md-nav__link">
    controller
  </a>
  
    <nav class="md-nav" aria-label="controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.controller.RunController" class="md-nav__link">
    RunController
  </a>
  
    <nav class="md-nav" aria-label="RunController">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.controller.RunController.component" class="md-nav__link">
    component
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.controller.RunController.emme_manager" class="md-nav__link">
    emme_manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.controller.RunController.iteration" class="md-nav__link">
    iteration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.controller.RunController.run_dir" class="md-nav__link">
    run_dir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.controller.RunController.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.controller.RunController.validate_inputs" class="md-nav__link">
    validate_inputs()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#components" class="md-nav__link">
    Components
  </a>
  
    <nav class="md-nav" aria-label="Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#base-component" class="md-nav__link">
    Base Component
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component" class="md-nav__link">
    component
  </a>
  
    <nav class="md-nav" aria-label="component">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component" class="md-nav__link">
    Component
  </a>
  
    <nav class="md-nav" aria-label="Component">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.config" class="md-nav__link">
    config
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.controller" class="md-nav__link">
    controller
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.logger" class="md-nav__link">
    logger
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.top_sheet" class="md-nav__link">
    top_sheet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.trace" class="md-nav__link">
    trace
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.get_abs_path" class="md-nav__link">
    get_abs_path()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.get_emme_scenario" class="md-nav__link">
    get_emme_scenario()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.report_progress" class="md-nav__link">
    report_progress()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.test_component" class="md-nav__link">
    test_component()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.time_period_names" class="md-nav__link">
    time_period_names()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.validate_inputs" class="md-nav__link">
    validate_inputs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.verify" class="md-nav__link">
    verify()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.component.Component.write_top_sheet" class="md-nav__link">
    write_top_sheet()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demand-components" class="md-nav__link">
    Demand Components
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.demand" class="md-nav__link">
    demand
  </a>
  
    <nav class="md-nav" aria-label="demand">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.demand.demand" class="md-nav__link">
    demand
  </a>
  
    <nav class="md-nav" aria-label="demand">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.demand.demand.PrepareDemand" class="md-nav__link">
    PrepareDemand
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.demand.demand.PrepareHighwayDemand" class="md-nav__link">
    PrepareHighwayDemand
  </a>
  
    <nav class="md-nav" aria-label="PrepareHighwayDemand">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.demand.demand.PrepareHighwayDemand.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-components" class="md-nav__link">
    Network Components
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network" class="md-nav__link">
    network
  </a>
  
    <nav class="md-nav" aria-label="network">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway" class="md-nav__link">
    highway
  </a>
  
    <nav class="md-nav" aria-label="highway">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_assign" class="md-nav__link">
    highway_assign
  </a>
  
    <nav class="md-nav" aria-label="highway_assign">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_assign.AssignmentClass" class="md-nav__link">
    AssignmentClass
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_assign.HighwayAssignment" class="md-nav__link">
    HighwayAssignment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_maz" class="md-nav__link">
    highway_maz
  </a>
  
    <nav class="md-nav" aria-label="highway_maz">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_maz.AssignMAZSPDemand" class="md-nav__link">
    AssignMAZSPDemand
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_maz.SkimMAZCosts" class="md-nav__link">
    SkimMAZCosts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_network" class="md-nav__link">
    highway_network
  </a>
  
    <nav class="md-nav" aria-label="highway_network">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.highway.highway_network.PrepareNetwork" class="md-nav__link">
    PrepareNetwork
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.transit" class="md-nav__link">
    transit
  </a>
  
    <nav class="md-nav" aria-label="transit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.transit.transit_assign" class="md-nav__link">
    transit_assign
  </a>
  
    <nav class="md-nav" aria-label="transit_assign">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.transit.transit_assign.TransitAssignment" class="md-nav__link">
    TransitAssignment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.transit.transit_skim" class="md-nav__link">
    transit_skim
  </a>
  
    <nav class="md-nav" aria-label="transit_skim">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.components.network.transit.transit_skim.TransitSkim" class="md-nav__link">
    TransitSkim
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#emme-wrappers" class="md-nav__link">
    Emme Wrappers
  </a>
  
    <nav class="md-nav" aria-label="Emme Wrappers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme" class="md-nav__link">
    emme
  </a>
  
    <nav class="md-nav" aria-label="emme">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager" class="md-nav__link">
    manager
  </a>
  
    <nav class="md-nav" aria-label="manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager" class="md-nav__link">
    EmmeManager
  </a>
  
    <nav class="md-nav" aria-label="EmmeManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.change_emmebank_dimensions" class="md-nav__link">
    change_emmebank_dimensions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.close_all" class="md-nav__link">
    close_all()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.copy_attr_values" class="md-nav__link">
    copy_attr_values()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.create_project" class="md-nav__link">
    create_project()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.emmebank" class="md-nav__link">
    emmebank()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.get_network" class="md-nav__link">
    get_network()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.logbook_trace" class="md-nav__link">
    logbook_trace()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.logbook_write" class="md-nav__link">
    logbook_write()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.modeller" class="md-nav__link">
    modeller()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.project" class="md-nav__link">
    project()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.temp_attributes_and_restore" class="md-nav__link">
    temp_attributes_and_restore()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.manager.EmmeManager.tool" class="md-nav__link">
    tool()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix" class="md-nav__link">
    matrix
  </a>
  
    <nav class="md-nav" aria-label="matrix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.MatrixCache" class="md-nav__link">
    MatrixCache
  </a>
  
    <nav class="md-nav" aria-label="MatrixCache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.MatrixCache.clear" class="md-nav__link">
    clear()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.MatrixCache.get_data" class="md-nav__link">
    get_data()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.MatrixCache.set_data" class="md-nav__link">
    set_data()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager" class="md-nav__link">
    OMXManager
  </a>
  
    <nav class="md-nav" aria-label="OMXManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.open" class="md-nav__link">
    open()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.read" class="md-nav__link">
    read()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.read_hdf5" class="md-nav__link">
    read_hdf5()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.write_array" class="md-nav__link">
    write_array()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.write_clipped_array" class="md-nav__link">
    write_clipped_array()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.write_matrices" class="md-nav__link">
    write_matrices()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.matrix.OMXManager.write_matrix" class="md-nav__link">
    write_matrix()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.network" class="md-nav__link">
    network
  </a>
  
    <nav class="md-nav" aria-label="network">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.network.NetworkCalculator" class="md-nav__link">
    NetworkCalculator
  </a>
  
    <nav class="md-nav" aria-label="NetworkCalculator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.network.NetworkCalculator.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.network.NetworkCalculator.add_calc" class="md-nav__link">
    add_calc()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.emme.network.NetworkCalculator.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#errata" class="md-nav__link">
    Errata
  </a>
  
    <nav class="md-nav" aria-label="Errata">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.logger" class="md-nav__link">
    logger
  </a>
  
    <nav class="md-nav" aria-label="logger">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.logger.LogStartEnd" class="md-nav__link">
    LogStartEnd
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.logger.Logger" class="md-nav__link">
    Logger
  </a>
  
    <nav class="md-nav" aria-label="Logger">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.logger.Logger.log" class="md-nav__link">
    log()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.logger.Logger.log_end" class="md-nav__link">
    log_end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.logger.Logger.log_start" class="md-nav__link">
    log_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.logger.Logger.log_start_end" class="md-nav__link">
    log_start_end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.logger.Logger.log_time" class="md-nav__link">
    log_time()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.tools" class="md-nav__link">
    tools
  </a>
  
    <nav class="md-nav" aria-label="tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.tools.download_unzip" class="md-nav__link">
    download_unzip()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.tools.parse_num_processors" class="md-nav__link">
    parse_num_processors()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tm2py.examples" class="md-nav__link">
    examples
  </a>
  
    <nav class="md-nav" aria-label="examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tm2py.examples.get_example" class="md-nav__link">
    get_example()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/bayareametro/tm2py/edit/main/docs/api.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="api-documentation">API Documentation<a class="headerlink" href="#api-documentation" title="Permanent link"> ¶</a></h1>
<h2 id="controller">Controller<a class="headerlink" href="#controller" title="Permanent link"> ¶</a></h2>


  <div class="doc doc-object doc-module">



<h3 id="tm2py.controller" class="doc doc-heading">
        <code>tm2py.controller</code>



<a href="#tm2py.controller" class="headerlink" title="Permanent link"> ¶</a></h3>

    <div class="doc doc-contents first">

      <p>RunController - model operation controller.</p>
<p>Main interface to start a TM2PY model run. Provide one or more configuration
files in .toml format (by convention a scenario.toml and a model.toml)</p>
<p>Typical usage example:
  from tm2py.controller import RunController
  controller = RunController(
    [r&rdquo;example_union\scenario.toml&rdquo;, r&rdquo;example_union\model.toml&rdquo;])
  controller.run()</p>
<p>Or from the command-line:
  python <path>\tm2py\tm2py\controller.py –s scenario.toml –m model.toml</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-class">



<h4 id="tm2py.controller.RunController" class="doc doc-heading">
        <code>
RunController        </code>



<a href="#tm2py.controller.RunController" class="headerlink" title="Permanent link"> ¶</a></h4>

    <div class="doc doc-contents ">

      <p>Main operational interface for model runs.</p>
<p>Provide one or more config files in TOML (*.toml) format, and a run directory.
If the run directory is not provided the root directory of the first config_file is used.</p>
<div class="admonition properties">
<p class="admonition-title">Properties</p>
<p>config: root Configuration object
logger: logger object
top_sheet: placeholder for top sheet functionality (not implemented yet)
trace: placeholder for trace functionality (not implemented yet)
run_dir: root run directory for the model run
iteration: current running (or last started) iteration
component: current running (or last started) Component object</p>
<div class="admonition emme_manager">
<p class="admonition-title">EmmeManager object for centralized Emme-related (highway and</p>
<p>transit assignments and skims) utilities.</p>
</div>
<div class="admonition complete_components">
<p class="admonition-title">list of components which have completed, tuple of</p>
<p>(iteration, name, Component object)</p>
</div>
</div>

        <details class="quote">
          <summary>Source code in <code>tm2py/controller.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">RunController</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Main operational interface for model runs.</span>

<span class="sd">    Provide one or more config files in TOML (*.toml) format, and a run directory.</span>
<span class="sd">    If the run directory is not provided the root directory of the first config_file is used.</span>

<span class="sd">    Properties:</span>
<span class="sd">        config: root Configuration object</span>
<span class="sd">        logger: logger object</span>
<span class="sd">        top_sheet: placeholder for top sheet functionality (not implemented yet)</span>
<span class="sd">        trace: placeholder for trace functionality (not implemented yet)</span>
<span class="sd">        run_dir: root run directory for the model run</span>
<span class="sd">        iteration: current running (or last started) iteration</span>
<span class="sd">        component: current running (or last started) Component object</span>
<span class="sd">        emme_manager: EmmeManager object for centralized Emme-related (highway and</span>
<span class="sd">            transit assignments and skims) utilities.</span>
<span class="sd">        complete_components: list of components which have completed, tuple of</span>
<span class="sd">            (iteration, name, Component object)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">config_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">config_file</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">run_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">config_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_dir</span> <span class="o">=</span> <span class="n">run_dir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">load_toml</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_sheet</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completed_components</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># mapping from defined names referenced in config to Component objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_component_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">component_cls_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emme_manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iteration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_component</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queued_components</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue_components</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">run_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The root run directory of the model run&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_dir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Current iteration of model&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iteration</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">component</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Component</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Current component of model&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">emme_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeManager</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cached Emme Manager object&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emme_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_emme_manager</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emme_manager</span>

    <span class="k">def</span> <span class="nf">_init_emme_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize Emme manager, start Emme desktop App, and initialize Modeller&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emme_manager</span> <span class="o">=</span> <span class="n">EmmeManager</span><span class="p">()</span>
        <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emme_manager</span><span class="o">.</span><span class="n">project</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">emme</span><span class="o">.</span><span class="n">project_path</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Initialize Modeller to use Emme assignment tools and other APIs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emme_manager</span><span class="o">.</span><span class="n">modeller</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Main interface to run model&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iteration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_inputs</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queued_components</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iteration</span> <span class="o">!=</span> <span class="n">iteration</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iteration</span> <span class="o">=</span> <span class="n">iteration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_component</span> <span class="o">=</span> <span class="n">component</span>
            <span class="n">component</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">completed_components</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">iteration</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">component</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_queue_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add components per iteration to queue according to input Config&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queued_components</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">start_iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_queued_components</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_map</span><span class="p">[</span><span class="n">c_name</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">initial_components</span>
            <span class="p">]</span>
        <span class="n">iteration_nums</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span>
            <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">start_iteration</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">end_iteration</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">iteration_components</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_component_map</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">global_iteration_components</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queued_components</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span>
                <span class="n">iteration_nums</span><span class="p">,</span>
                <span class="n">iteration_components</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">global_iteration_components</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queued_components</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">end_iteration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_map</span><span class="p">[</span><span class="n">c_name</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">final_components</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">start_component</span><span class="p">:</span>
            <span class="n">start_index</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">idx</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_queued_components</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">start_component</span> <span class="o">==</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_queued_components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queued_components</span><span class="p">[</span><span class="n">start_index</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">validate_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate input state prior to run&quot;&quot;&quot;</span>
        <span class="n">already_validated_components</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queued_components</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">already_validated_components</span><span class="p">:</span>
                <span class="n">component</span><span class="o">.</span><span class="n">validate_inputs</span><span class="p">()</span>
                <span class="n">already_validated_components</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h5 id="tm2py.controller.RunController.component" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">component</span><span class="p">:</span> <span class="n">Component</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a href="#tm2py.controller.RunController.component" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Current component of model</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tm2py.controller.RunController.emme_manager" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">emme_manager</span><span class="p">:</span> <span class="n">EmmeManager</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a href="#tm2py.controller.RunController.emme_manager" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Cached Emme Manager object</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tm2py.controller.RunController.iteration" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a href="#tm2py.controller.RunController.iteration" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Current iteration of model</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tm2py.controller.RunController.run_dir" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a href="#tm2py.controller.RunController.run_dir" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>The root run directory of the model run</p>
    </div>

  </div>







  <div class="doc doc-object doc-method">



<h5 id="tm2py.controller.RunController.run" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.controller.RunController.run" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Main interface to run model</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/controller.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Main interface to run model&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_iteration</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">validate_inputs</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queued_components</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iteration</span> <span class="o">!=</span> <span class="n">iteration</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iteration</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_component</span> <span class="o">=</span> <span class="n">component</span>
        <span class="n">component</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completed_components</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">iteration</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">component</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tm2py.controller.RunController.validate_inputs" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">validate_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.controller.RunController.validate_inputs" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Validate input state prior to run</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/controller.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate input state prior to run&quot;&quot;&quot;</span>
    <span class="n">already_validated_components</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queued_components</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">already_validated_components</span><span class="p">:</span>
            <span class="n">component</span><span class="o">.</span><span class="n">validate_inputs</span><span class="p">()</span>
            <span class="n">already_validated_components</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>

<h2 id="components">Components<a class="headerlink" href="#components" title="Permanent link"> ¶</a></h2>
<h3 id="base-component">Base Component<a class="headerlink" href="#base-component" title="Permanent link"> ¶</a></h3>


  <div class="doc doc-object doc-module">



<h3 id="tm2py.components.component" class="doc doc-heading">
        <code>tm2py.components.component</code>



<a href="#tm2py.components.component" class="headerlink" title="Permanent link"> ¶</a></h3>

    <div class="doc doc-contents first">

      <p>Root component ABC</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="tm2py.components.component.Component" class="doc doc-heading">
        <code>
Component            (<span title="abc.ABC">ABC</span>)
        </code>



<a href="#tm2py.components.component.Component" class="headerlink" title="Permanent link"> ¶</a></h4>

    <div class="doc doc-contents ">

      <p>Base component class for tm2py top-level inheritance.</p>

<p><strong>Examples:</strong></p>
    
      <p>::
    class MyComponent(Component):</p>
<div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code>def __init__(self, controller):
    super().__init__(controller)
    self._parameter = None

def run(self):
    self._step1()
    self._step2()

def _step1(self):
    pass

def _step2(self):
    pass
</code></pre></div></td></tr></table></div>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/component.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Component</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base component class for tm2py top-level inheritance.</span>

<span class="sd">    Example:</span>
<span class="sd">    ::</span>
<span class="sd">        class MyComponent(Component):</span>

<span class="sd">        def __init__(self, controller):</span>
<span class="sd">            super().__init__(controller)</span>
<span class="sd">            self._parameter = None</span>

<span class="sd">        def run(self):</span>
<span class="sd">            self._step1()</span>
<span class="sd">            self._step2()</span>

<span class="sd">        def _step1(self):</span>
<span class="sd">            pass</span>

<span class="sd">        def _step2(self):</span>
<span class="sd">            pass</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">RunController</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="o">=</span> <span class="n">controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">controller</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parent controller&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span>

    <span class="k">def</span> <span class="nf">get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the absolute path from the root run directory given a relative path.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_emme_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emmebank_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">time_period</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeScenario</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the Emme scenario object from the Emmebank at emmebank_path for the time_period ID.</span>

<span class="sd">        Args:</span>
<span class="sd">            emmebank_path: valid Emmebank path, absolute or relative to root run directory</span>
<span class="sd">            time_period: valid time_period ID</span>

<span class="sd">        Returns</span>
<span class="sd">            Emme Scenario object (see Emme API Reference)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">emmebank_path</span><span class="p">):</span>
            <span class="n">emmebank_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">emmebank_path</span><span class="p">)</span>
        <span class="n">emmebank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">emmebank</span><span class="p">(</span><span class="n">emmebank_path</span><span class="p">)</span>
        <span class="n">scenario_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">tp</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">emme_scenario_id</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_periods</span><span class="p">}[</span>
            <span class="n">time_period</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">emmebank</span><span class="o">.</span><span class="n">scenario</span><span class="p">(</span><span class="n">scenario_id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configuration settings loaded from config files&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">config</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">top_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring placeholder for top sheet&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">top_sheet</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring placeholder for logger&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">logger</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring placeholder for trace&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span>

    <span class="k">def</span> <span class="nf">validate_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate inputs are correct at model initiation, fail fast if not&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run model component&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">report_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write progress to log file&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">test_component</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run stand-alone component test&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">write_top_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write key outputs to the model top sheet&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify component outputs / results&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">time_period_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return input time_period name or names and return list of time_period names.</span>

<span class="sd">        Returns: list of string names of time periods</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">time</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_periods</span><span class="p">]</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h5 id="tm2py.components.component.Component.config" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">config</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a href="#tm2py.components.component.Component.config" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Configuration settings loaded from config files</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tm2py.components.component.Component.controller" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">controller</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a href="#tm2py.components.component.Component.controller" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Parent controller</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tm2py.components.component.Component.logger" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">logger</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a href="#tm2py.components.component.Component.logger" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>docstring placeholder for logger</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tm2py.components.component.Component.top_sheet" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">top_sheet</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a href="#tm2py.components.component.Component.top_sheet" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>docstring placeholder for top sheet</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h5 id="tm2py.components.component.Component.trace" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">trace</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a href="#tm2py.components.component.Component.trace" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>docstring placeholder for trace</p>
    </div>

  </div>







  <div class="doc doc-object doc-method">



<h5 id="tm2py.components.component.Component.get_abs_path" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">)</span></code>


<a href="#tm2py.components.component.Component.get_abs_path" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Get the absolute path from the root run directory given a relative path.</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/component.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the absolute path from the root run directory given a relative path.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">rel_path</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tm2py.components.component.Component.get_emme_scenario" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">get_emme_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emmebank_path</span><span class="p">,</span> <span class="n">time_period</span><span class="p">)</span></code>


<a href="#tm2py.components.component.Component.get_emme_scenario" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Get the Emme scenario object from the Emmebank at emmebank_path for the time_period ID.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>emmebank_path</code></td>
        <td><code>str</code></td>
        <td><p>valid Emmebank path, absolute or relative to root run directory</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>time_period</code></td>
        <td><code>str</code></td>
        <td><p>valid time_period ID</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>      <p>Returns
    Emme Scenario object (see Emme API Reference)</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/component.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_emme_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emmebank_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">time_period</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeScenario</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get the Emme scenario object from the Emmebank at emmebank_path for the time_period ID.</span>

<span class="sd">    Args:</span>
<span class="sd">        emmebank_path: valid Emmebank path, absolute or relative to root run directory</span>
<span class="sd">        time_period: valid time_period ID</span>

<span class="sd">    Returns</span>
<span class="sd">        Emme Scenario object (see Emme API Reference)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">emmebank_path</span><span class="p">):</span>
        <span class="n">emmebank_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="n">emmebank_path</span><span class="p">)</span>
    <span class="n">emmebank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">emmebank</span><span class="p">(</span><span class="n">emmebank_path</span><span class="p">)</span>
    <span class="n">scenario_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">tp</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">emme_scenario_id</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_periods</span><span class="p">}[</span>
        <span class="n">time_period</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">emmebank</span><span class="o">.</span><span class="n">scenario</span><span class="p">(</span><span class="n">scenario_id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tm2py.components.component.Component.report_progress" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">report_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.components.component.Component.report_progress" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Write progress to log file</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/component.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">report_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write progress to log file&quot;&quot;&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tm2py.components.component.Component.run" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.components.component.Component.run" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Run model component</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/component.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run model component&quot;&quot;&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tm2py.components.component.Component.test_component" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">test_component</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.components.component.Component.test_component" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Run stand-alone component test</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/component.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">test_component</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run stand-alone component test&quot;&quot;&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tm2py.components.component.Component.time_period_names" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">time_period_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.components.component.Component.time_period_names" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Return input time_period name or names and return list of time_period names.</p>
<p>Returns: list of string names of time periods</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/component.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">time_period_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Return input time_period name or names and return list of time_period names.</span>

<span class="sd">    Returns: list of string names of time periods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">time</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_periods</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tm2py.components.component.Component.validate_inputs" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">validate_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.components.component.Component.validate_inputs" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Validate inputs are correct at model initiation, fail fast if not</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/component.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate inputs are correct at model initiation, fail fast if not&quot;&quot;&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tm2py.components.component.Component.verify" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.components.component.Component.verify" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Verify component outputs / results</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/component.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify component outputs / results&quot;&quot;&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tm2py.components.component.Component.write_top_sheet" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">write_top_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.components.component.Component.write_top_sheet" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Write key outputs to the model top sheet</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/component.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">write_top_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write key outputs to the model top sheet&quot;&quot;&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>

<h3 id="demand-components">Demand Components<a class="headerlink" href="#demand-components" title="Permanent link"> ¶</a></h3>


  <div class="doc doc-object doc-module">



<h3 id="tm2py.components.demand" class="doc doc-heading">
        <code>tm2py.components.demand</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#tm2py.components.demand" class="headerlink" title="Permanent link"> ¶</a></h3>

    <div class="doc doc-contents first">

      <p>Demand components module</p>



  <div class="doc doc-children">












  <div class="doc doc-object doc-module">



<h4 id="tm2py.components.demand.demand" class="doc doc-heading">
        <code>demand</code>



<a href="#tm2py.components.demand.demand" class="headerlink" title="Permanent link"> ¶</a></h4>

    <div class="doc doc-contents ">

      <p>Demand loading from OMX to Emme database</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="tm2py.components.demand.demand.PrepareDemand" class="doc doc-heading">
        <code>
PrepareDemand            (<a class="autorefs autorefs-internal" title="tm2py.components.component.Component" href="#tm2py.components.component.Component">Component</a>, <span title="abc.ABC">ABC</span>)
        </code>



<a href="#tm2py.components.demand.demand.PrepareDemand" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Abstract base class to import and average demand.</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/demand/demand.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">PrepareDemand</span><span class="p">(</span><span class="n">Component</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class to import and average demand.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">RunController</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num_zones</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">OMXManager</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">omx_file</span><span class="p">:</span>
            <span class="n">demand</span> <span class="o">=</span> <span class="n">omx_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">factor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">demand</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">demand</span>
        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redim_demand</span><span class="p">(</span><span class="n">demand</span><span class="p">,</span> <span class="n">num_zones</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">demand</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_redim_demand</span><span class="p">(</span><span class="n">demand</span><span class="p">,</span> <span class="n">num_zones</span><span class="p">):</span>
        <span class="n">_shape</span> <span class="o">=</span> <span class="n">demand</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">_shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">num_zones</span><span class="p">,</span> <span class="n">num_zones</span><span class="p">):</span>
            <span class="n">demand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
                <span class="n">demand</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_zones</span> <span class="o">-</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_zones</span> <span class="o">-</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">demand</span>

    <span class="c1"># Disable too many arguments recommendation</span>
    <span class="c1"># pylint: disable=R0913</span>
    <span class="k">def</span> <span class="nf">_save_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">demand</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">apply_msa</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mf&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="n">msa_iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">iteration</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">apply_msa</span> <span class="ow">or</span> <span class="n">msa_iteration</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">matrix</span><span class="p">:</span>
                <span class="n">ident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank</span><span class="o">.</span><span class="n">available_matrix_identifier</span><span class="p">(</span><span class="s2">&quot;FULL&quot;</span><span class="p">)</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank</span><span class="o">.</span><span class="n">create_matrix</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
                <span class="n">matrix</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">matrix</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">matrix</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error averaging demand: matrix </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>
            <span class="n">prev_demand</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">get_numpy_data</span><span class="p">(</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">demand</span> <span class="o">=</span> <span class="n">prev_demand</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">msa_iteration</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">demand</span> <span class="o">-</span> <span class="n">prev_demand</span><span class="p">)</span>

        <span class="n">matrix</span><span class="o">.</span><span class="n">set_numpy_data</span><span class="p">(</span><span class="n">demand</span><span class="p">,</span> <span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_zero_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">zero_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="s1">&#39;ms&quot;zero&quot;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zero_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank</span><span class="o">.</span><span class="n">available_matrix_identifier</span><span class="p">(</span><span class="s2">&quot;SCALAR&quot;</span><span class="p">)</span>
            <span class="n">zero_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank</span><span class="o">.</span><span class="n">create_matrix</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
            <span class="n">zero_matrix</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;zero&quot;</span>
            <span class="n">zero_matrix</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;zero demand matrix&quot;</span>
        <span class="n">zero_matrix</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">












  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tm2py.components.demand.demand.PrepareHighwayDemand" class="doc doc-heading">
        <code>
PrepareHighwayDemand            (<a class="autorefs autorefs-internal" title="tm2py.components.demand.demand.PrepareDemand" href="#tm2py.components.demand.demand.PrepareDemand">PrepareDemand</a>)
        </code>



<a href="#tm2py.components.demand.demand.PrepareHighwayDemand" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Import and average highway demand.</p>
<p>Demand is imported from OMX files based on reference file paths and OMX
matrix names in highway assignment config (highway.classes).
The demand is average using MSA with the current demand matrices
(in the Emmebank) if the controller.iteration &gt; 1.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>controller</code></td>
        <td><code>RunController</code></td>
        <td><p>parent RunController object</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/components/demand/demand.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">PrepareHighwayDemand</span><span class="p">(</span><span class="n">PrepareDemand</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Import and average highway demand.</span>

<span class="sd">    Demand is imported from OMX files based on reference file paths and OMX</span>
<span class="sd">    matrix names in highway assignment config (highway.classes).</span>
<span class="sd">    The demand is average using MSA with the current demand matrices</span>
<span class="sd">    (in the Emmebank) if the controller.iteration &gt; 1.</span>

<span class="sd">    Args:</span>
<span class="sd">        controller: parent RunController object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">RunController</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank_path</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @LogStartEnd(&quot;prepare highway demand&quot;)</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open combined demand OMX files from demand models and prepare for assignment.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">emme</span><span class="o">.</span><span class="n">highway_database_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">emmebank</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_emmebank_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_zero_matrix</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_period_names</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_demand</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">klass</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">klass</span><span class="o">.</span><span class="n">demand</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_demand</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">demand_config</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]],</span>
        <span class="n">time_period</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load demand from OMX files and save to Emme matrix for highway assignment.</span>

<span class="sd">        Average with previous demand (MSA) if the current iteration &gt; 1</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): the name of the highway assignment class</span>
<span class="sd">            description (str): the description for the highway assignment class</span>
<span class="sd">            demand_config (dict): the list of file cross-reference(s) for the demand to be loaded</span>
<span class="sd">                {&quot;source&quot;: &lt;name of demand model component&gt;,</span>
<span class="sd">                 &quot;name&quot;: &lt;OMX key name&gt;,</span>
<span class="sd">                 &quot;factor&quot;: &lt;factor to apply to demand in this file&gt;}</span>
<span class="sd">            time_period (str): the time time_period ID (name)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scenario</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_emme_scenario</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_emmebank_path</span><span class="p">,</span> <span class="n">time_period</span><span class="p">)</span>
        <span class="n">num_zones</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scenario</span><span class="o">.</span><span class="n">zone_numbers</span><span class="p">)</span>
        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_demand</span><span class="p">(</span><span class="n">demand_config</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">time_period</span><span class="p">,</span> <span class="n">num_zones</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file_config</span> <span class="ow">in</span> <span class="n">demand_config</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">demand</span> <span class="o">=</span> <span class="n">demand</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_demand</span><span class="p">(</span><span class="n">file_config</span><span class="p">,</span> <span class="n">time_period</span><span class="p">,</span> <span class="n">num_zones</span><span class="p">)</span>
        <span class="n">demand_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time_period</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time_period</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2"> demand&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_demand</span><span class="p">(</span><span class="n">demand_name</span><span class="p">,</span> <span class="n">demand</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">apply_msa</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_config</span><span class="p">,</span> <span class="n">time_period</span><span class="p">,</span> <span class="n">num_zones</span><span class="p">):</span>
        <span class="c1"># Load demand from cross-referenced source file,</span>
        <span class="c1"># the named demand model component under the key highway_demand_file</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">file_config</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">file_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">time_period</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">file_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;factor&quot;</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">highway_demand_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">time_period</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">num_zones</span><span class="p">,</span> <span class="n">factor</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h6 id="tm2py.components.demand.demand.PrepareHighwayDemand.run" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.components.demand.demand.PrepareHighwayDemand.run" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Open combined demand OMX files from demand models and prepare for assignment.</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/demand/demand.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Open combined demand OMX files from demand models and prepare for assignment.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">emme</span><span class="o">.</span><span class="n">highway_database_path</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">emmebank</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_emmebank_path</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_create_zero_matrix</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_period_names</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_demand</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">klass</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">klass</span><span class="o">.</span><span class="n">demand</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>







  </div>

    </div>

  </div>

<h3 id="network-components">Network Components<a class="headerlink" href="#network-components" title="Permanent link"> ¶</a></h3>


  <div class="doc doc-object doc-module">



<h3 id="tm2py.components.network" class="doc doc-heading">
        <code>tm2py.components.network</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#tm2py.components.network" class="headerlink" title="Permanent link"> ¶</a></h3>

    <div class="doc doc-contents first">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h4 id="tm2py.components.network.highway" class="doc doc-heading">
        <code>highway</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#tm2py.components.network.highway" class="headerlink" title="Permanent link"> ¶</a></h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h5 id="tm2py.components.network.highway.highway_assign" class="doc doc-heading">
        <code>highway_assign</code>



<a href="#tm2py.components.network.highway.highway_assign" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Highway assignment and skim component.</p>
<p>Performs equilibrium traffic assignment and generates resulting skims.</p>
<p>The assignmend is configured using the &ldquo;highway&rdquo; table in the source config.
See the config documentation for details. The traffic assignment runs according
to the list of assignment classes under highway.classes.</p>
<p>Other relevant parameters from the config are
    emme.num_processors: number of processors as integer or &ldquo;MAX&rdquo; or &ldquo;MAX-N&rdquo;
    time_periods[].emme_scenario_id: Emme scenario number to use for each period
    time_periods[].highway_capacity_factor</p>
<p>The Emme network must have the following attributes available:
    Link:
    - &ldquo;length&rdquo; in feet
    - &ldquo;vdf&rdquo;, volume delay function (volume delay functions must also be setup)
    - &ldquo;@useclass&rdquo;, vehicle-class restrictions classification, auto-only, HOV only
    - &ldquo;@free_flow_time&rdquo;, the free flow time (in minutes)
    - &ldquo;@tollXX_YY&rdquo;, the toll for period XX and class subgroup (see truck
        class) named YY, used together with @tollbooth to generate @bridgetoll_YY
        and @valuetoll_YY
    - &ldquo;@maz_flow&rdquo;, the background traffic MAZ-to-MAZ SP assigned flow from highway_maz,
        if controller.iteration &gt; 0
    - modes: must be set on links and match the specified mode codes in
        the traffic config</p>
<p>Network results:
    - @flow_XX: link PCE flows per class, where XX is the class name in the config
    - timau: auto travel time
    - volau: total assigned flow in PCE</p>
<p>Notes:
    - Output matrices are in miles, minutes, and cents (2010 dollars) and are stored/
    as real values;
    - Intrazonal distance/time is one half the distance/time to the nearest neighbor;
    - Intrazonal bridge and value tolls are assumed to be zero</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h6 id="tm2py.components.network.highway.highway_assign.AssignmentClass" class="doc doc-heading">
        <code>
AssignmentClass        </code>



<a href="#tm2py.components.network.highway.highway_assign.AssignmentClass" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Highway assignment class, represents data from config and conversion to Emme specs</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/highway/highway_assign.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AssignmentClass</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Highway assignment class, represents data from config and conversion to Emme specs&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_config</span><span class="p">,</span> <span class="n">time_period</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_config</span> <span class="o">=</span> <span class="n">class_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_period</span> <span class="o">=</span> <span class="n">time_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">class_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skims</span> <span class="o">=</span> <span class="n">class_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;skims&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">emme_highway_class_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeHighwayClassSpec</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Construct and return Emme traffic assignment class specification</span>

<span class="sd">        Converted from input config (highway.classes), see Emme Help for</span>
<span class="sd">        SOLA traffic assignment for specification details.</span>
<span class="sd">        Adds time_period as part of demand and skim matrix names.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A nested dictionary corresponding to the expected Emme traffic</span>
<span class="sd">            class specification used in the SOLA assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">demand_matrix</span> <span class="o">=</span> <span class="s1">&#39;ms&quot;zero&quot;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">demand_matrix</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;mf&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_period</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">class_spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_config</span><span class="o">.</span><span class="n">mode_code</span><span class="p">,</span>
            <span class="s2">&quot;demand&quot;</span><span class="p">:</span> <span class="n">demand_matrix</span><span class="p">,</span>
            <span class="s2">&quot;generalized_cost&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;link_costs&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;@cost_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># cost in $0.01</span>
                <span class="c1"># $/hr -&gt; min/$0.01</span>
                <span class="s2">&quot;perception_factor&quot;</span><span class="p">:</span> <span class="mf">0.6</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_config</span><span class="o">.</span><span class="n">value_of_time</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;link_volumes&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;@flow_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;od_travel_times&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;shortest_paths&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;mf</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_period</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_time&quot;</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;path_analyses&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">emme_class_analysis</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">class_spec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">emme_class_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">EmmeHighwayAnalysisSpec</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Construct and return a list of path analyses specs which generate the required skims.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of nested dictionaries corresponding to the Emme path analysis</span>
<span class="sd">            (per-class) specification used in the SOLA assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">class_analysis</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skims</span><span class="p">:</span>
            <span class="n">class_analysis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emme_analysis_spec</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;@cost_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                    <span class="sa">f</span><span class="s2">&quot;mf</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_period</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_cost&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">skim_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skims</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">skim_type</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;_&quot;</span> <span class="ow">in</span> <span class="n">skim_type</span><span class="p">:</span>
                <span class="n">skim_type</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="n">skim_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">matrix_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mf</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_period</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">skim_type</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">class_analysis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emme_analysis_spec</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">skim_analysis_link_attribute</span><span class="p">(</span><span class="n">skim_type</span><span class="p">,</span> <span class="n">group</span><span class="p">),</span>
                    <span class="n">matrix_name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">class_analysis</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">skim_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns: List of skim matrix names for this class.&quot;&quot;&quot;</span>
        <span class="n">skim_matrices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skims</span><span class="p">:</span>
            <span class="n">skim_matrices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_period</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_time&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_period</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_cost&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">skim_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skims</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">skim_type</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;_&quot;</span> <span class="ow">in</span> <span class="n">skim_type</span><span class="p">:</span>
                <span class="n">skim_type</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="n">skim_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">skim_matrices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_period</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">skim_type</span><span class="si">}{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">skim_matrices</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">emme_analysis_spec</span><span class="p">(</span><span class="n">link_attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">matrix_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeHighwayAnalysisSpec</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns Emme highway class path analysis spec.</span>

<span class="sd">        See Emme Help for SOLA assignment for full specification details.</span>
<span class="sd">        Args:</span>
<span class="sd">            link_attr: input link attribute for which to sum values along the paths</span>
<span class="sd">            matrix_name: full matrix name to store the result of the path analysis</span>

<span class="sd">        Returns:</span>
<span class="sd">            The nested dictionary specification which will generate the skim</span>
<span class="sd">            of link attribute values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">analysis_spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;link_component&quot;</span><span class="p">:</span> <span class="n">link_attr</span><span class="p">,</span>
            <span class="s2">&quot;turn_component&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span>
            <span class="s2">&quot;selection_threshold&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="s2">&quot;path_to_od_composition&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;considered_paths&quot;</span><span class="p">:</span> <span class="s2">&quot;ALL&quot;</span><span class="p">,</span>
                <span class="s2">&quot;multiply_path_proportions_by&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;analyzed_demand&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;path_value&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;od_values&quot;</span><span class="p">:</span> <span class="n">matrix_name</span><span class="p">,</span>
                <span class="s2">&quot;selected_link_volumes&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;selected_turn_volumes&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">analysis_spec</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">skim_analysis_link_attribute</span><span class="p">(</span><span class="n">skim</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the link attribute name for the specified skim type and group.</span>

<span class="sd">        Args:</span>
<span class="sd">            skim: name of skim requested, one of dist, hovdist, tolldist, freeflowtime,</span>
<span class="sd">                bridgetoll, or valuetoll</span>
<span class="sd">            group: subgroup name for the bridgetoll or valuetoll, corresponds to one of</span>
<span class="sd">                the names from config.highway.tolls.dst_vehicle_group_names</span>
<span class="sd">        Returns:</span>
<span class="sd">            A string of the link attribute name used in the analysis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lookup</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="s2">&quot;length&quot;</span><span class="p">,</span>  <span class="c1"># NOTE: length must be in miles</span>
            <span class="s2">&quot;hovdist&quot;</span><span class="p">:</span> <span class="s2">&quot;@hov_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tolldist&quot;</span><span class="p">:</span> <span class="s2">&quot;@toll_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;freeflowtime&quot;</span><span class="p">:</span> <span class="s2">&quot;@free_flow_time&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bridgetoll&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;@bridgetoll_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;valuetoll&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;@valuetoll_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">lookup</span><span class="p">[</span><span class="n">skim</span><span class="p">]</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h7 id="tm2py.components.network.highway.highway_assign.AssignmentClass.emme_class_analysis" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">emme_class_analysis</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">EmmeHighwayAnalysisSpec</span><span class="p">]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a href="#tm2py.components.network.highway.highway_assign.AssignmentClass.emme_class_analysis" class="headerlink" title="Permanent link"> ¶</a></h7>

    <div class="doc doc-contents ">

      <p>Construct and return a list of path analyses specs which generate the required skims.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[EmmeHighwayAnalysisSpec]</code></td>
      <td><p>A list of nested dictionaries corresponding to the Emme path analysis
(per-class) specification used in the SOLA assignment.</p></td>
    </tr>
  </tbody>
</table>    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h7 id="tm2py.components.network.highway.highway_assign.AssignmentClass.emme_highway_class_spec" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">emme_highway_class_spec</span><span class="p">:</span> <span class="n">EmmeHighwayClassSpec</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a href="#tm2py.components.network.highway.highway_assign.AssignmentClass.emme_highway_class_spec" class="headerlink" title="Permanent link"> ¶</a></h7>

    <div class="doc doc-contents ">

      <p>Construct and return Emme traffic assignment class specification</p>
<p>Converted from input config (highway.classes), see Emme Help for
SOLA traffic assignment for specification details.
Adds time_period as part of demand and skim matrix names.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>EmmeHighwayClassSpec</code></td>
      <td><p>A nested dictionary corresponding to the expected Emme traffic
class specification used in the SOLA assignment.</p></td>
    </tr>
  </tbody>
</table>    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h7 id="tm2py.components.network.highway.highway_assign.AssignmentClass.skim_matrices" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">skim_matrices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

<a href="#tm2py.components.network.highway.highway_assign.AssignmentClass.skim_matrices" class="headerlink" title="Permanent link"> ¶</a></h7>

    <div class="doc doc-contents ">

      
    </div>

  </div>







  <div class="doc doc-object doc-method">



<h7 id="tm2py.components.network.highway.highway_assign.AssignmentClass.emme_analysis_spec" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">emme_analysis_spec</span><span class="p">(</span><span class="n">link_attr</span><span class="p">,</span> <span class="n">matrix_name</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#tm2py.components.network.highway.highway_assign.AssignmentClass.emme_analysis_spec" class="headerlink" title="Permanent link"> ¶</a></h7>

    <div class="doc doc-contents ">

      <p>Returns Emme highway class path analysis spec.</p>
<p>See Emme Help for SOLA assignment for full specification details.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>link_attr</code></td>
        <td><code>str</code></td>
        <td><p>input link attribute for which to sum values along the paths</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>matrix_name</code></td>
        <td><code>str</code></td>
        <td><p>full matrix name to store the result of the path analysis</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>EmmeHighwayAnalysisSpec</code></td>
      <td><p>The nested dictionary specification which will generate the skim
of link attribute values.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/highway/highway_assign.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">emme_analysis_spec</span><span class="p">(</span><span class="n">link_attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">matrix_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeHighwayAnalysisSpec</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Returns Emme highway class path analysis spec.</span>

<span class="sd">    See Emme Help for SOLA assignment for full specification details.</span>
<span class="sd">    Args:</span>
<span class="sd">        link_attr: input link attribute for which to sum values along the paths</span>
<span class="sd">        matrix_name: full matrix name to store the result of the path analysis</span>

<span class="sd">    Returns:</span>
<span class="sd">        The nested dictionary specification which will generate the skim</span>
<span class="sd">        of link attribute values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">analysis_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;link_component&quot;</span><span class="p">:</span> <span class="n">link_attr</span><span class="p">,</span>
        <span class="s2">&quot;turn_component&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span>
        <span class="s2">&quot;selection_threshold&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
        <span class="s2">&quot;path_to_od_composition&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;considered_paths&quot;</span><span class="p">:</span> <span class="s2">&quot;ALL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;multiply_path_proportions_by&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;analyzed_demand&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;path_value&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;od_values&quot;</span><span class="p">:</span> <span class="n">matrix_name</span><span class="p">,</span>
            <span class="s2">&quot;selected_link_volumes&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;selected_turn_volumes&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">analysis_spec</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tm2py.components.network.highway.highway_assign.AssignmentClass.skim_analysis_link_attribute" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">skim_analysis_link_attribute</span><span class="p">(</span><span class="n">skim</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#tm2py.components.network.highway.highway_assign.AssignmentClass.skim_analysis_link_attribute" class="headerlink" title="Permanent link"> ¶</a></h7>

    <div class="doc doc-contents ">

      <p>Return the link attribute name for the specified skim type and group.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>skim</code></td>
        <td><code>str</code></td>
        <td><p>name of skim requested, one of dist, hovdist, tolldist, freeflowtime,
bridgetoll, or valuetoll</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>group</code></td>
        <td><code>str</code></td>
        <td><p>subgroup name for the bridgetoll or valuetoll, corresponds to one of
the names from config.highway.tolls.dst_vehicle_group_names</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>str</code></td>
      <td><p>A string of the link attribute name used in the analysis.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/highway/highway_assign.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">skim_analysis_link_attribute</span><span class="p">(</span><span class="n">skim</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the link attribute name for the specified skim type and group.</span>

<span class="sd">    Args:</span>
<span class="sd">        skim: name of skim requested, one of dist, hovdist, tolldist, freeflowtime,</span>
<span class="sd">            bridgetoll, or valuetoll</span>
<span class="sd">        group: subgroup name for the bridgetoll or valuetoll, corresponds to one of</span>
<span class="sd">            the names from config.highway.tolls.dst_vehicle_group_names</span>
<span class="sd">    Returns:</span>
<span class="sd">        A string of the link attribute name used in the analysis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lookup</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="s2">&quot;length&quot;</span><span class="p">,</span>  <span class="c1"># NOTE: length must be in miles</span>
        <span class="s2">&quot;hovdist&quot;</span><span class="p">:</span> <span class="s2">&quot;@hov_length&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tolldist&quot;</span><span class="p">:</span> <span class="s2">&quot;@toll_length&quot;</span><span class="p">,</span>
        <span class="s2">&quot;freeflowtime&quot;</span><span class="p">:</span> <span class="s2">&quot;@free_flow_time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bridgetoll&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;@bridgetoll_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;valuetoll&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;@valuetoll_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">lookup</span><span class="p">[</span><span class="n">skim</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h6 id="tm2py.components.network.highway.highway_assign.HighwayAssignment" class="doc doc-heading">
        <code>
HighwayAssignment            (<a class="autorefs autorefs-internal" title="tm2py.components.component.Component" href="#tm2py.components.component.Component">Component</a>)
        </code>



<a href="#tm2py.components.network.highway.highway_assign.HighwayAssignment" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Highway assignment and skims.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>controller</code></td>
        <td><code>RunController</code></td>
        <td><p>parent RunController object</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/highway/highway_assign.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">HighwayAssignment</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Highway assignment and skims.</span>
<span class="sd">    Args:</span>
<span class="sd">        controller: parent RunController object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">RunController</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_processors</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">parse_num_processors</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">emme</span><span class="o">.</span><span class="n">num_processors</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skim_matrices</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@LogStartEnd</span><span class="p">(</span><span class="s2">&quot;Highway assignment and skims&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;STATUS&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run highway assignment&quot;&quot;&quot;</span>
        <span class="n">demand</span> <span class="o">=</span> <span class="n">PrepareHighwayDemand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="p">)</span>
        <span class="n">demand</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_period_names</span><span class="p">():</span>
            <span class="n">scenario</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_emme_scenario</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">emme</span><span class="o">.</span><span class="n">highway_database_path</span><span class="p">,</span> <span class="n">time</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
                <span class="n">iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">iteration</span>
                <span class="n">assign_classes</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">AssignmentClass</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">classes</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_copy_maz_flow</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reset_background_traffic</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_skim_matrices</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">assign_classes</span><span class="p">)</span>
                <span class="n">assign_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_assignment_spec</span><span class="p">(</span><span class="n">assign_classes</span><span class="p">)</span>
                <span class="c1"># self.logger.log_dict(assign_spec, level=&quot;DEBUG&quot;)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_start_end</span><span class="p">(</span>
                    <span class="s2">&quot;Run SOLA assignment with path analyses&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span>
                <span class="p">):</span>
                    <span class="n">assign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
                        <span class="s2">&quot;inro.emme.traffic_assignment.sola_traffic_assignment&quot;</span>
                    <span class="p">)</span>
                    <span class="n">assign</span><span class="p">(</span><span class="n">assign_spec</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">chart_log_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Subtract non-time costs from gen cost to get the raw travel time</span>
                <span class="k">for</span> <span class="n">emme_class_spec</span> <span class="ow">in</span> <span class="n">assign_spec</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_calc_time_skim</span><span class="p">(</span><span class="n">emme_class_spec</span><span class="p">)</span>
                <span class="c1"># Set intra-zonal for time and dist to be 1/2 nearest neighbour</span>
                <span class="k">for</span> <span class="n">class_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_intrazonal_values</span><span class="p">(</span>
                        <span class="n">time</span><span class="p">,</span>
                        <span class="n">class_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                        <span class="n">class_config</span><span class="p">[</span><span class="s2">&quot;skims&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_export_skims</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>

    <span class="nd">@_context</span>
    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">EmmeScenario</span><span class="p">,</span> <span class="n">time_period</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup and teardown for Emme Matrix cache and list of skim matrices</span>

<span class="sd">        Args:</span>
<span class="sd">            scenario: Emme scenario object</span>
<span class="sd">            time_period: time period name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_cache</span> <span class="o">=</span> <span class="n">MatrixCache</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skim_matrices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Highway assignment for period </span><span class="si">{</span><span class="n">time_period</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_start_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;STATUS&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_cache</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_skim_matrices</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_copy_maz_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">EmmeScenario</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy maz_flow from MAZ demand assignment to ul1 for background traffic.</span>

<span class="sd">        Args:</span>
<span class="sd">            scenario: Emme scenario object&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_time</span><span class="p">(</span>
            <span class="s2">&quot;Copy @maz_flow to ul1 for background traffic&quot;</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;DETAIL&quot;</span>
        <span class="p">)</span>
        <span class="n">net_calc</span> <span class="o">=</span> <span class="n">NetworkCalculator</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
        <span class="n">net_calc</span><span class="p">(</span><span class="s2">&quot;ul1&quot;</span><span class="p">,</span> <span class="s2">&quot;@maz_flow&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reset_background_traffic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">EmmeScenario</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set ul1 for background traffic to 0 (no maz-maz flow)</span>

<span class="sd">        Args:</span>
<span class="sd">            scenario: Emme scenario object&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_time</span><span class="p">(</span>
            <span class="s2">&quot;Set ul1 to 0 for background traffic&quot;</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;DETAIL&quot;</span>
        <span class="p">)</span>
        <span class="n">net_calc</span> <span class="o">=</span> <span class="n">NetworkCalculator</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
        <span class="n">net_calc</span><span class="p">(</span><span class="s2">&quot;ul1&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_skim_matrices</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">EmmeScenario</span><span class="p">,</span> <span class="n">assign_classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">AssignmentClass</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create matrices to store skim results in Emme database.</span>

<span class="sd">        Also add the matrices to list of self._skim_matrices.</span>

<span class="sd">        Args:</span>
<span class="sd">            scenario: Emme scenario object</span>
<span class="sd">            assign_classes: list of AssignmentClass objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">create_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
            <span class="s2">&quot;inro.emme.data.matrix.create_matrix&quot;</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_start_end</span><span class="p">(</span><span class="s2">&quot;Creating skim matrices&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;DETAIL&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="n">assign_classes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">matrix_name</span> <span class="ow">in</span> <span class="n">klass</span><span class="o">.</span><span class="n">skim_matrices</span><span class="p">:</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">emmebank</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mf&quot;</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">matrix</span><span class="p">:</span>
                        <span class="n">matrix</span> <span class="o">=</span> <span class="n">create_matrix</span><span class="p">(</span>
                            <span class="s2">&quot;mf&quot;</span><span class="p">,</span> <span class="n">matrix_name</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Create matrix name: </span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s2">, id: </span><span class="si">{</span><span class="n">matrix</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_skim_matrices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_assignment_spec</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">assign_classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">AssignmentClass</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeTrafficAssignmentSpec</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate template Emme SOLA assignment specification</span>

<span class="sd">        Args:</span>
<span class="sd">            assign_classes: list of AssignmentClass objects</span>

<span class="sd">        Returns</span>
<span class="sd">            Emme specification for SOLA traffic assignment</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">relative_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">relative_gap</span>
        <span class="n">max_iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">max_iterations</span>
        <span class="c1"># NOTE: mazmazvol as background traffic in link.data1 (&quot;ul1&quot;)</span>
        <span class="n">base_spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;SOLA_TRAFFIC_ASSIGNMENT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;background_traffic&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;link_component&quot;</span><span class="p">:</span> <span class="s2">&quot;ul1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;turn_component&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;add_transit_vehicles&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">klass</span><span class="o">.</span><span class="n">emme_highway_class_spec</span> <span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="n">assign_classes</span><span class="p">],</span>
            <span class="s2">&quot;stopping_criteria&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;max_iterations&quot;</span><span class="p">:</span> <span class="n">max_iterations</span><span class="p">,</span>
                <span class="s2">&quot;best_relative_gap&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;relative_gap&quot;</span><span class="p">:</span> <span class="n">relative_gap</span><span class="p">,</span>
                <span class="s2">&quot;normalized_gap&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;performance_settings&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;number_of_processors&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_processors</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">base_spec</span>

    <span class="k">def</span> <span class="nf">_calc_time_skim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emme_class_spec</span><span class="p">:</span> <span class="n">EmmeHighwayClassSpec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the real time skim =gen_cost-per_fac*link_costs.</span>

<span class="sd">        Args:</span>
<span class="sd">            emme_class_spec: dictionary of the per-class spec sub-section from the</span>
<span class="sd">                Emme SOLA assignment spec, classes list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">od_travel_times</span> <span class="o">=</span> <span class="n">emme_class_spec</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="s2">&quot;od_travel_times&quot;</span><span class="p">][</span>
            <span class="s2">&quot;shortest_paths&quot;</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">od_travel_times</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Total link costs is always the first analysis</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">emme_class_spec</span><span class="p">[</span><span class="s2">&quot;path_analyses&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="s2">&quot;od_values&quot;</span><span class="p">]</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">emme_class_spec</span><span class="p">[</span><span class="s2">&quot;generalized_cost&quot;</span><span class="p">][</span><span class="s2">&quot;perception_factor&quot;</span><span class="p">]</span>
            <span class="n">gencost_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_cache</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">od_travel_times</span><span class="p">)</span>
            <span class="n">cost_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_cache</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
            <span class="n">time_data</span> <span class="o">=</span> <span class="n">gencost_data</span> <span class="o">-</span> <span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="n">cost_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_cache</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">od_travel_times</span><span class="p">,</span> <span class="n">time_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_intrazonal_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">time_period</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">class_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">skims</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the intrazonal values to 1/2 nearest neighbour for time and distance skims.</span>

<span class="sd">        Args:</span>
<span class="sd">            time_period: time period name (from config)</span>
<span class="sd">            class_name: highway class name (from config)</span>
<span class="sd">            skims: list of requested skims (from config)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">skim_name</span> <span class="ow">in</span> <span class="n">skims</span><span class="p">:</span>
            <span class="n">matrix_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mf</span><span class="si">{</span><span class="n">time_period</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">skim_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">skim_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;distance&quot;</span><span class="p">,</span> <span class="s2">&quot;freeflowtime&quot;</span><span class="p">,</span> <span class="s2">&quot;hovdist&quot;</span><span class="p">,</span> <span class="s2">&quot;tolldist&quot;</span><span class="p">]:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_cache</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">matrix_name</span><span class="p">)</span>
                <span class="c1"># NOTE: sets values for external zones as well</span>
                <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">diag_indices_from</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_cache</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">matrix_name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_export_skims</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">EmmeScenario</span><span class="p">,</span> <span class="n">time_period</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export skims to OMX files by period.</span>

<span class="sd">        Args:</span>
<span class="sd">            scenario: Emme scenario object</span>
<span class="sd">            time_period: time period name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: skims in separate file by period</span>
        <span class="n">omx_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">output_skim_path</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">time_period</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">omx_file_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">OMXManager</span><span class="p">(</span>
            <span class="n">omx_file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">matrix_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_matrix_cache</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">omx_file</span><span class="p">:</span>
            <span class="n">omx_file</span><span class="o">.</span><span class="n">write_matrices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_skim_matrices</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h7 id="tm2py.components.network.highway.highway_assign.HighwayAssignment.run" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.components.network.highway.highway_assign.HighwayAssignment.run" class="headerlink" title="Permanent link"> ¶</a></h7>

    <div class="doc doc-contents ">

      <p>Run highway assignment</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/highway/highway_assign.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@LogStartEnd</span><span class="p">(</span><span class="s2">&quot;Highway assignment and skims&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;STATUS&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run highway assignment&quot;&quot;&quot;</span>
    <span class="n">demand</span> <span class="o">=</span> <span class="n">PrepareHighwayDemand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="p">)</span>
    <span class="n">demand</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_period_names</span><span class="p">():</span>
        <span class="n">scenario</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_emme_scenario</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">emme</span><span class="o">.</span><span class="n">highway_database_path</span><span class="p">,</span> <span class="n">time</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
            <span class="n">iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">iteration</span>
            <span class="n">assign_classes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">AssignmentClass</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">classes</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_copy_maz_flow</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reset_background_traffic</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_skim_matrices</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">assign_classes</span><span class="p">)</span>
            <span class="n">assign_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_assignment_spec</span><span class="p">(</span><span class="n">assign_classes</span><span class="p">)</span>
            <span class="c1"># self.logger.log_dict(assign_spec, level=&quot;DEBUG&quot;)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_start_end</span><span class="p">(</span>
                <span class="s2">&quot;Run SOLA assignment with path analyses&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span>
            <span class="p">):</span>
                <span class="n">assign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
                    <span class="s2">&quot;inro.emme.traffic_assignment.sola_traffic_assignment&quot;</span>
                <span class="p">)</span>
                <span class="n">assign</span><span class="p">(</span><span class="n">assign_spec</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">chart_log_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Subtract non-time costs from gen cost to get the raw travel time</span>
            <span class="k">for</span> <span class="n">emme_class_spec</span> <span class="ow">in</span> <span class="n">assign_spec</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calc_time_skim</span><span class="p">(</span><span class="n">emme_class_spec</span><span class="p">)</span>
            <span class="c1"># Set intra-zonal for time and dist to be 1/2 nearest neighbour</span>
            <span class="k">for</span> <span class="n">class_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_intrazonal_values</span><span class="p">(</span>
                    <span class="n">time</span><span class="p">,</span>
                    <span class="n">class_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                    <span class="n">class_config</span><span class="p">[</span><span class="s2">&quot;skims&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_export_skims</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h5 id="tm2py.components.network.highway.highway_maz" class="doc doc-heading">
        <code>highway_maz</code>



<a href="#tm2py.components.network.highway.highway_maz" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Assigns and skims MAZ-to-MAZ demand along shortest generalized cost path.</p>
<p>MAZ to MAZ demand is read in from separate OMX matrices as defined under
the config table highway.maz_to_maz.demand_county_groups,</p>
<p>The demand is expected to be short distance (e.g. &lt;0.5 miles), or within the
same TAZ. The demand is grouped into bins of origin -&gt; all destinations, by
distance (straight-line) to furthest destination. This limits the size of the
shortest path calculated to the minimum required.
The bin edges have been predefined after testing as (in miles):
    [0.0, 0.9, 1.2, 1.8, 2.5, 5.0, 10.0, max_dist]</p>
<p>Input:
Emme network with:
    Link attributes:
        - time attribute, either timau (resulting VDF congested time)
          or @free_flow_time
    Node attributes: @maz_id, x, y, and #node_county
Demand matrices under highway.maz_to_maz.demand_file,
and can have a placeholder
    auto_{period}<em>MAZ_AUTO</em>{number}_{period}.omx</p>
<p>Output:
The resulting MAZ-MAZ flows are saved in link @maz_flow which is
used as background traffic in the equilibrium Highway assignment.</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-class">



<h6 id="tm2py.components.network.highway.highway_maz.AssignMAZSPDemand" class="doc doc-heading">
        <code>
AssignMAZSPDemand            (<a class="autorefs autorefs-internal" title="tm2py.components.component.Component" href="#tm2py.components.component.Component">Component</a>)
        </code>



<a href="#tm2py.components.network.highway.highway_maz.AssignMAZSPDemand" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>MAZ-to-MAZ shortest-path highway assignment.</p>
<p>Calculates shortest path between MAZs with demand in the Emme network
and assigns flow.</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/highway/highway_maz.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AssignMAZSPDemand</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MAZ-to-MAZ shortest-path highway assignment.</span>

<span class="sd">    Calculates shortest path between MAZs with demand in the Emme network</span>
<span class="sd">    and assigns flow.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># skip Too many instance attributes recommendation, it is OK as is</span>
    <span class="c1"># pylint: disable=R0902</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">RunController</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;MAZ-to-MAZ shortest-path highway assignment.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller: parent Controller object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># bins: performance parameter: crow-fly distance bins</span>
        <span class="c1">#       to limit shortest path calculation by origin to furthest destination</span>
        <span class="c1">#       semi-exposed for performance testing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bin_edges</span> <span class="o">=</span> <span class="n">_default_bin_edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Internal attributes to track data through the sequence of steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eb_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mazs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_demand</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_dist</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_leaf_index</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@LogStartEnd</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run MAZ-to-MAZ shortest path assignment.&quot;&quot;&quot;</span>
        <span class="n">emme_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span>
        <span class="n">emmebank</span> <span class="o">=</span> <span class="n">emme_manager</span><span class="o">.</span><span class="n">emmebank</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">emme</span><span class="o">.</span><span class="n">highway_database_path</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eb_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">emmebank</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">county_groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">demand_county_groups</span><span class="p">:</span>
            <span class="n">county_groups</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">counties</span>
        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_period_names</span><span class="p">():</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_start_end</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;period </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_emme_scenario</span><span class="p">(</span><span class="n">emmebank</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_network</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">county_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">maz_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_county_mazs</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">maz_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;warning: no mazs for counties </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_process_demand</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">maz_ids</span><span class="p">)</span>
                    <span class="n">demand_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_demand</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">demand_group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">demand_bins</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_find_roots_and_leaves</span><span class="p">(</span><span class="n">demand_group</span><span class="p">[</span><span class="s2">&quot;demand&quot;</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_set_link_cost_maz</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_run_shortest_path</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">demand_group</span><span class="p">[</span><span class="s2">&quot;dist&quot;</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_flow</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">demand_group</span><span class="p">[</span><span class="s2">&quot;demand&quot;</span><span class="p">])</span>

    <span class="nd">@_context</span>
    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Context setup / teardown, initializes internal attributes.</span>

<span class="sd">        Args:</span>
<span class="sd">            time: name of the time period</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mazs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_demand</span> <span class="o">=</span> <span class="n">_defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_dist</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_leaf_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;LINK&quot;</span><span class="p">,</span> <span class="s2">&quot;@link_cost&quot;</span><span class="p">,</span> <span class="s2">&quot;total cost MAZ-MAZ&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;LINK&quot;</span><span class="p">,</span> <span class="s2">&quot;@link_cost_maz&quot;</span><span class="p">,</span> <span class="s2">&quot;cost MAZ-MAZ, unused MAZs blocked&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;NODE&quot;</span><span class="p">,</span> <span class="s2">&quot;@maz_root&quot;</span><span class="p">,</span> <span class="s2">&quot;Flag for MAZs which are roots&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;NODE&quot;</span><span class="p">,</span> <span class="s2">&quot;@maz_leaf&quot;</span><span class="p">,</span> <span class="s2">&quot;Flag for MAZs which are leaves&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">temp_attributes_and_restore</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">,</span> <span class="n">attributes</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mazs</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_demand</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_network</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_root_index</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_leaf_index</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># delete sp path files</span>
                    <span class="k">for</span> <span class="n">bin_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_edges</span><span class="p">)):</span>
                        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_eb_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sp_</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bin_no</span><span class="si">}</span><span class="s2">.ebp&quot;</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate link cost (travel time + bridge tolls + operating cost) and load network.</span>

<span class="sd">        Reads Emme network from disk for later node lookups. Optimized to only load</span>
<span class="sd">        attribute values of interest, additional attributes must be added in</span>
<span class="sd">        order to be read from disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="o">.</span><span class="n">has_traffic_results</span><span class="p">:</span>
            <span class="n">time_attr</span> <span class="o">=</span> <span class="s2">&quot;(@free_flow_time.max.timau)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time_attr</span> <span class="o">=</span> <span class="s2">&quot;@free_flow_time&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating link costs using time </span><span class="si">{</span><span class="n">time_attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">)</span>
        <span class="n">vot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">value_of_time</span>
        <span class="n">op_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">operating_cost_per_mile</span>
        <span class="n">net_calc</span> <span class="o">=</span> <span class="n">NetworkCalculator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">)</span>
        <span class="n">net_calc</span><span class="p">(</span><span class="s2">&quot;@link_cost&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time_attr</span><span class="si">}</span><span class="s2"> + 0.6 / </span><span class="si">{</span><span class="n">vot</span><span class="si">}</span><span class="s2"> * (length * </span><span class="si">{</span><span class="n">op_cost</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">get_network</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;NODE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;@maz_id&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;#node_county&quot;</span><span class="p">],</span> <span class="s2">&quot;LINK&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="o">.</span><span class="n">create_attribute</span><span class="p">(</span><span class="s2">&quot;LINK&quot;</span><span class="p">,</span> <span class="s2">&quot;temp_flow&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_county_mazs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">counties</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">EmmeNode</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all MAZ nodes which are located in one of these counties.</span>

<span class="sd">        Used the node attribute #node_county to identify the node location.</span>
<span class="sd">        Name must be an exact match. Catches a mapping of the county names</span>
<span class="sd">        to nodes so nodes are processed only once.</span>

<span class="sd">        Args:</span>
<span class="sd">            counties: list of county names</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of MAZ nodes (Emme Node) which are in these counties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network</span>
        <span class="c1"># NOTE: every maz must have a valid #node_county</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mazs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mazs</span> <span class="o">=</span> <span class="n">_defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;@maz_id&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mazs</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s2">&quot;#node_county&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">mazs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">county</span> <span class="ow">in</span> <span class="n">counties</span><span class="p">:</span>
            <span class="n">mazs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mazs</span><span class="p">[</span><span class="n">county</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mazs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">n</span><span class="p">[</span><span class="s2">&quot;@maz_id&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_process_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">maz_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">EmmeNode</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Loads the demand from file and groups by origin node.</span>

<span class="sd">        Sets the demand to self._demand for later processing, grouping the demand in</span>
<span class="sd">        a dictionary by origin node (Emme Node object) to list of dictionaries</span>
<span class="sd">        {&quot;orig&quot;: orig_node, &quot;dest&quot;: dest_node, &quot;dem&quot;: demand, &quot;dist&quot;: dist}</span>

<span class="sd">        Args:</span>
<span class="sd">            time: time period name</span>
<span class="sd">            index: group index of the demand file, used to find the file by name</span>
<span class="sd">            maz_ids: indexed list of MAZ ID nodes for the county group</span>
<span class="sd">                (active counties for this demand file)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_demand_array</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">origins</span><span class="p">,</span> <span class="n">destinations</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">origins</span><span class="p">,</span> <span class="n">destinations</span><span class="p">):</span>
            <span class="c1"># skip intra-maz demand</span>
            <span class="k">if</span> <span class="n">orig</span> <span class="o">==</span> <span class="n">dest</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">orig_node</span> <span class="o">=</span> <span class="n">maz_ids</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span>
            <span class="n">dest_node</span> <span class="o">=</span> <span class="n">maz_ids</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">_sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="n">dest_node</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">orig_node</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">dest_node</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">orig_node</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_dist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_max_dist</span> <span class="o">=</span> <span class="n">dist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_demand</span><span class="p">[</span><span class="n">orig_node</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;orig&quot;</span><span class="p">:</span> <span class="n">orig_node</span><span class="p">,</span>
                    <span class="s2">&quot;dest&quot;</span><span class="p">:</span> <span class="n">dest_node</span><span class="p">,</span>
                    <span class="s2">&quot;dem&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">orig</span><span class="p">][</span><span class="n">dest</span><span class="p">],</span>
                    <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_demand_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NumpyArray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load the demand from file with the specified time and index name.</span>

<span class="sd">        Args:</span>
<span class="sd">            time: time period name</span>
<span class="sd">            index: group index of the demand file, used to find the file by name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_path_tmplt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">demand_file</span><span class="p">)</span>
        <span class="n">omx_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span>
            <span class="n">file_path_tmplt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">OMXManager</span><span class="p">(</span><span class="n">omx_file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">omx_file</span><span class="p">:</span>
            <span class="n">demand_array</span> <span class="o">=</span> <span class="n">omx_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;M0&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">demand_array</span>

    <span class="k">def</span> <span class="nf">_group_demand</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">EmmeNode</span><span class="p">]]]]]]:</span>
        <span class="sd">&quot;&quot;&quot;Process the demand loaded from files and create groups based on the</span>
<span class="sd">        origin to the furthest destination with demand.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of dictionaries, containing the demand in the format</span>
<span class="sd">                {&quot;orig&quot;: EmmeNode, &quot;dest&quot;: EmmeNode, &quot;dem&quot;: float (demand value)}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># group demand from same origin into distance bins by furthest</span>
        <span class="c1"># distance destination to limit shortest path search radius</span>
        <span class="n">bin_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_edges</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_dist</span> <span class="o">/</span> <span class="mf">5280.0</span><span class="p">:</span>
            <span class="n">bin_edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_dist</span> <span class="o">/</span> <span class="mf">5280.0</span><span class="p">)</span>

        <span class="n">demand_groups</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="p">,</span> <span class="s2">&quot;demand&quot;</span><span class="p">:</span> <span class="p">[]}</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_demand</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">max_dist</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;dist&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="mf">5280.0</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">demand_groups</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">max_dist</span> <span class="o">&lt;</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;dist&quot;</span><span class="p">]:</span>
                    <span class="n">group</span><span class="p">[</span><span class="s2">&quot;demand&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">demand_groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_time</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;bin dist </span><span class="si">{</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, size </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Filter out groups without any demand</span>
        <span class="n">demand_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">demand_groups</span> <span class="k">if</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;demand&quot;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">demand_groups</span>

    <span class="k">def</span> <span class="nf">_find_roots_and_leaves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">demand</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">EmmeNode</span><span class="p">]]]):</span>
        <span class="sd">&quot;&quot;&quot;Label available MAZ root nodes and leaf nodes for the path calculation.</span>

<span class="sd">        The MAZ nodes which are found as origins in the demand are &quot;activated&quot;</span>
<span class="sd">        by setting @maz_root to non-zero, and similarly the leaves have @maz_leaf</span>
<span class="sd">        set to non-zero.</span>

<span class="sd">        Args:</span>
<span class="sd">            demand: list of dictionaries, containing the demand in the format</span>
<span class="sd">                {&quot;orig&quot;: EmmeNode, &quot;dest&quot;: EmmeNode, &quot;dem&quot;: float (demand value)}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network</span>
        <span class="n">attrs_to_init</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;NODE&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;@maz_root&quot;</span><span class="p">,</span> <span class="s2">&quot;@maz_leaf&quot;</span><span class="p">]),</span> <span class="p">(</span><span class="s2">&quot;LINK&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;maz_cost&quot;</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">domain</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">attrs_to_init</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span><span class="n">domain</span><span class="p">):</span>
                    <span class="n">network</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">network</span><span class="o">.</span><span class="n">create_attribute</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">root_maz_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">leaf_maz_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">demand</span><span class="p">:</span>
            <span class="n">o_node</span><span class="p">,</span> <span class="n">d_node</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orig&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dest&quot;</span><span class="p">]</span>
            <span class="n">root_maz_ids</span><span class="p">[</span><span class="n">o_node</span><span class="o">.</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="n">o_node</span><span class="p">[</span><span class="s2">&quot;@maz_root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o_node</span><span class="p">[</span><span class="s2">&quot;@maz_id&quot;</span><span class="p">]</span>
            <span class="n">leaf_maz_ids</span><span class="p">[</span><span class="n">d_node</span><span class="o">.</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_node</span><span class="p">[</span><span class="s2">&quot;@maz_leaf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_node</span><span class="p">[</span><span class="s2">&quot;@maz_id&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">root_maz_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">()))}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_leaf_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">q</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">leaf_maz_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">()))}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">copy_attr_values</span><span class="p">(</span>
            <span class="s2">&quot;NODE&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;@maz_root&quot;</span><span class="p">,</span> <span class="s2">&quot;@maz_leaf&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_link_cost_maz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set link cost used in the shortest path forbidden using unavailable connectors.</span>

<span class="sd">        Copy the pre-calculated cost @link_cost to @link_cost_maz,</span>
<span class="sd">        setting value to 1e20 on connectors to unused zone leaves / from</span>
<span class="sd">        unused roots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># forbid egress from MAZ nodes which are not demand roots /</span>
        <span class="c1">#        access to MAZ nodes which are not demand leafs</span>
        <span class="n">net_calc</span> <span class="o">=</span> <span class="n">NetworkCalculator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">)</span>
        <span class="n">net_calc</span><span class="o">.</span><span class="n">add_calc</span><span class="p">(</span><span class="s2">&quot;@link_cost_maz&quot;</span><span class="p">,</span> <span class="s2">&quot;@link_cost&quot;</span><span class="p">)</span>
        <span class="n">net_calc</span><span class="o">.</span><span class="n">add_calc</span><span class="p">(</span><span class="s2">&quot;@link_cost_maz&quot;</span><span class="p">,</span> <span class="s2">&quot;1e20&quot;</span><span class="p">,</span> <span class="s2">&quot;@maz_root=0 and !@maz_id=0&quot;</span><span class="p">)</span>
        <span class="n">net_calc</span><span class="o">.</span><span class="n">add_calc</span><span class="p">(</span><span class="s2">&quot;@link_cost_maz&quot;</span><span class="p">,</span> <span class="s2">&quot;1e20&quot;</span><span class="p">,</span> <span class="s2">&quot;@maz_leafj=0 and !@maz_idj=0&quot;</span><span class="p">)</span>
        <span class="n">net_calc</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_run_shortest_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bin_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the shortest path tool to generate paths between the marked nodes.</span>

<span class="sd">        Args:</span>
<span class="sd">            time: time period name</span>
<span class="sd">            bin_no: bin number (id) for this demand segment</span>
<span class="sd">            max_radius: max unit coordinate distance to limit search tree</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shortest_paths_tool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
            <span class="s2">&quot;inro.emme.network_calculation.shortest_path&quot;</span>
        <span class="p">)</span>
        <span class="n">max_radius</span> <span class="o">=</span> <span class="n">max_radius</span> <span class="o">*</span> <span class="mi">5280</span> <span class="o">+</span> <span class="mi">100</span>  <span class="c1"># add some buffer for rounding error</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;ebp&quot;</span> <span class="k">if</span> <span class="n">_USE_BINARY</span> <span class="k">else</span> <span class="s2">&quot;txt&quot;</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sp_</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bin_no</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">num_processors</span> <span class="o">=</span> <span class="n">parse_num_processors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">emme</span><span class="o">.</span><span class="n">num_processors</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;SHORTEST_PATH&quot;</span><span class="p">,</span>
            <span class="s2">&quot;modes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">mode_code</span><span class="p">],</span>
            <span class="s2">&quot;root_nodes&quot;</span><span class="p">:</span> <span class="s2">&quot;@maz_root&quot;</span><span class="p">,</span>
            <span class="s2">&quot;leaf_nodes&quot;</span><span class="p">:</span> <span class="s2">&quot;@maz_leaf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;link_cost&quot;</span><span class="p">:</span> <span class="s2">&quot;@link_cost_maz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;path_constraints&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;max_radius&quot;</span><span class="p">:</span> <span class="n">max_radius</span><span class="p">,</span>
                <span class="s2">&quot;uturn_allowed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;through_leaves&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;through_centroids&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;exclude_forbidden_turns&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;skim_output&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;return_numpy&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;analyses&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">},</span>
                <span class="s2">&quot;path_output&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;BINARY&quot;</span> <span class="k">if</span> <span class="n">_USE_BINARY</span> <span class="k">else</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eb_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;performance_settings&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;number_of_processors&quot;</span><span class="p">:</span> <span class="n">num_processors</span><span class="p">,</span>
                <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;FORWARD&quot;</span><span class="p">,</span>
                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;STANDARD&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">shortest_paths_tool</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_assign_flow</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bin_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">demand</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">EmmeNode</span><span class="p">]]]</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign the demand along the paths generated from the shortest path tool.</span>

<span class="sd">        Args:</span>
<span class="sd">            time: time period name</span>
<span class="sd">            bin_no: bin number (id) for this demand segment</span>
<span class="sd">            demand: list of dictionaries, containing the demand in the format</span>
<span class="sd">                {&quot;orig&quot;: EmmeNode, &quot;dest&quot;: EmmeNode, &quot;dem&quot;: float (demand value)}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_USE_BINARY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assign_flow_binary</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">bin_no</span><span class="p">,</span> <span class="n">demand</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assign_flow_text</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">bin_no</span><span class="p">,</span> <span class="n">demand</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_assign_flow_text</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bin_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">demand</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">EmmeNode</span><span class="p">]]]</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign the demand along the paths generated from the shortest path tool.</span>

<span class="sd">        The paths are read from a text format file, see Emme help for details.</span>
<span class="sd">        Demand is summed in self._network (in memory) using temp_flow attribute</span>
<span class="sd">        and written to scenario (Emmebank / disk) @maz_flow.</span>

<span class="sd">        Args:</span>
<span class="sd">            time: time period name</span>
<span class="sd">            bin_no: bin number (id) for this demand segment</span>
<span class="sd">            demand: list of dictionaries, containin the demand in the format</span>
<span class="sd">                {&quot;orig&quot;: EmmeNode, &quot;dest&quot;: EmmeNode, &quot;dem&quot;: float (demand value)}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_text_format_paths</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">bin_no</span><span class="p">)</span>
        <span class="n">not_assigned</span><span class="p">,</span> <span class="n">assigned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">demand</span><span class="p">:</span>
            <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">dem</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orig&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dest&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dem&quot;</span><span class="p">]</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">not_assigned</span> <span class="o">+=</span> <span class="n">dem</span>
                <span class="k">continue</span>
            <span class="n">i_node</span> <span class="o">=</span> <span class="n">orig</span>
            <span class="k">for</span> <span class="n">j_node</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">i_node</span><span class="p">,</span> <span class="n">j_node</span><span class="p">)</span>
                <span class="n">link</span><span class="p">[</span><span class="s2">&quot;temp_flow&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dem</span>
                <span class="n">i_node</span> <span class="o">=</span> <span class="n">j_node</span>
            <span class="n">assigned</span> <span class="o">+=</span> <span class="n">dem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_time</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ASSIGN bin </span><span class="si">{</span><span class="n">bin_no</span><span class="si">}</span><span class="s2">: total: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">demand</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_time</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;assigned: </span><span class="si">{</span><span class="n">assigned</span><span class="si">}</span><span class="s2">, not assigned: </span><span class="si">{</span><span class="n">not_assigned</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_text_format_paths</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bin_no</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
        <span class="sd">&quot;&quot;&quot;Load all paths from text file and return as nested dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            time: time period name</span>
<span class="sd">            bin_no: bin number (id) for this demand segment</span>

<span class="sd">        Returns:</span>
<span class="sd">            All paths as a nested dictionary, path = paths[origin][destination],</span>
<span class="sd">            using the node IDs as integers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">_defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{})</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eb_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sp_</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bin_no</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">),</span>
            <span class="s2">&quot;r&quot;</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">paths_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">paths_file</span><span class="p">:</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                <span class="n">paths</span><span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">paths</span>

    <span class="k">def</span> <span class="nf">_assign_flow_binary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bin_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">demand</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">EmmeNode</span><span class="p">]]]</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign the demand along the paths generated from the shortest path tool.</span>

<span class="sd">        The paths are read from a binary format file, see Emme help for details.</span>
<span class="sd">        Demand is summed in self._network (in memory) using temp_flow attribute</span>
<span class="sd">        and written to scenario (Emmebank / disk) @maz_flow.</span>

<span class="sd">        Args:</span>
<span class="sd">            time: time period name</span>
<span class="sd">            bin_no: bin number (id) for this demand segment</span>
<span class="sd">            demand: list of dictionaries, containin the demand in the format</span>
<span class="sd">                {&quot;orig&quot;: EmmeNode, &quot;dest&quot;: EmmeNode, &quot;dem&quot;: float (demand value)}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sp_</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bin_no</span><span class="si">}</span><span class="s2">.ebp&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eb_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">paths_file</span><span class="p">:</span>
            <span class="c1"># read set of path pointers by Orig-Dest sequence from file</span>
            <span class="n">offset</span><span class="p">,</span> <span class="n">leaves_nb</span><span class="p">,</span> <span class="n">path_indicies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_indices</span><span class="p">(</span><span class="n">paths_file</span><span class="p">)</span>
            <span class="n">assigned</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">not_assigned</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">bytes_read</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">*</span> <span class="mi">8</span>
            <span class="c1"># for all orig-dest pairs with demand, load path from file</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">demand</span><span class="p">:</span>
                <span class="c1"># get file position based on orig-dest index</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_location</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orig&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dest&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">leaves_nb</span><span class="p">,</span> <span class="n">path_indicies</span>
                <span class="p">)</span>
                <span class="c1"># no path found, disconnected zone</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
                    <span class="n">not_assigned</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dem&quot;</span><span class="p">]</span>
                    <span class="k">continue</span>
                <span class="n">paths_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_assign_path_flow</span><span class="p">(</span><span class="n">paths_file</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dem&quot;</span><span class="p">])</span>
                <span class="n">assigned</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dem&quot;</span><span class="p">]</span>
                <span class="n">bytes_read</span> <span class="o">+=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">copy_attr_values</span><span class="p">(</span>
            <span class="s2">&quot;LINK&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;temp_flow&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;@maz_flow&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_time</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ASSIGN bin </span><span class="si">{</span><span class="n">bin_no</span><span class="si">}</span><span class="s2">, total </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">demand</span><span class="p">)</span><span class="si">}</span><span class="s2">, assign &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">assigned</span><span class="si">}</span><span class="s2">, not assign </span><span class="si">{</span><span class="n">not_assigned</span><span class="si">}</span><span class="s2">, bytes </span><span class="si">{</span><span class="n">bytes_read</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_path_indices</span><span class="p">(</span><span class="n">paths_file</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">_array</span><span class="o">.</span><span class="n">array</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the path header indices.</span>

<span class="sd">        See the Emme Shortest path tool doc for additional details on reading</span>
<span class="sd">        this file.</span>

<span class="sd">        Args:</span>
<span class="sd">            paths_file: binary file access to the generated paths file</span>

<span class="sd">        Returns:</span>
<span class="sd">            2 ints + array of ints: offset, leafs_nb, path_indicies</span>
<span class="sd">            offset: starting index to read the paths</span>
<span class="sd">            leafs_nb: number of leafs in the shortest path file</span>
<span class="sd">            path_indicies: array of the start index for each root, leaf path in paths_file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># read first 4 integers from file (Q=64-bit unsigned integers)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">_array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;Q&quot;</span><span class="p">)</span>
        <span class="n">header</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">paths_file</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">roots_nb</span><span class="p">,</span> <span class="n">leaves_nb</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="c1"># Load sequence of path indices (positions by orig-dest index),</span>
        <span class="c1"># pointing to list of path node IDs in file</span>
        <span class="n">path_indicies</span> <span class="o">=</span> <span class="n">_array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;Q&quot;</span><span class="p">)</span>
        <span class="n">path_indicies</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">paths_file</span><span class="p">,</span> <span class="n">roots_nb</span> <span class="o">*</span> <span class="n">leaves_nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">roots_nb</span> <span class="o">*</span> <span class="n">leaves_nb</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">leaves_nb</span><span class="p">,</span> <span class="n">path_indicies</span>

    <span class="k">def</span> <span class="nf">_get_path_location</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">orig</span><span class="p">:</span> <span class="n">EmmeNode</span><span class="p">,</span>
        <span class="n">dest</span><span class="p">:</span> <span class="n">EmmeNode</span><span class="p">,</span>
        <span class="n">leaves_nb</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">path_indicies</span><span class="p">:</span> <span class="n">_array</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the location in the paths_file to read.</span>

<span class="sd">        Args:</span>
<span class="sd">            orig: Emme Node object, origin MAZ to query the path</span>
<span class="sd">            dest: Emme Node object, destination MAZ to query the path</span>
<span class="sd">            leaves_nb: number of leaves</span>
<span class="sd">            path_indicies: array of the start index for each root, leaf path in paths_file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Two integers, start, end</span>
<span class="sd">            start: starting index to read Node ID bytes from paths_file</span>
<span class="sd">            end: ending index to read bytes from paths_file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_index</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span>
        <span class="n">q_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leaf_index</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">p_index</span> <span class="o">*</span> <span class="n">leaves_nb</span> <span class="o">+</span> <span class="n">q_index</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">path_indicies</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">path_indicies</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span>

    <span class="k">def</span> <span class="nf">_assign_path_flow</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">paths_file</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">demand</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add demand to link temp_flow for the path.</span>

<span class="sd">        Args:</span>
<span class="sd">            paths_file: binary file access to read path from</span>
<span class="sd">            start: starting index to read Node ID bytes from paths_file</span>
<span class="sd">            end: ending index to read bytes from paths_file</span>
<span class="sd">            demand: flow demand to add on link</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># load sequence of Node IDs which define the path (L=32-bit unsigned integers)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">paths_file</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
        <span class="c1"># proccess path to sequence of links and add flow</span>
        <span class="n">path_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">i_node</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">path_iter</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j_node</span> <span class="ow">in</span> <span class="n">path_iter</span><span class="p">:</span>
            <span class="n">link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">i_node</span><span class="p">,</span> <span class="n">j_node</span><span class="p">)</span>
            <span class="n">link</span><span class="p">[</span><span class="s2">&quot;temp_flow&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">demand</span>
            <span class="n">i_node</span> <span class="o">=</span> <span class="n">j_node</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tm2py.components.network.highway.highway_maz.AssignMAZSPDemand.__init__" class="doc doc-heading">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#tm2py.components.network.highway.highway_maz.AssignMAZSPDemand.__init__" class="headerlink" title="Permanent link"> ¶</a></h7>

    <div class="doc doc-contents ">

      <p>MAZ-to-MAZ shortest-path highway assignment.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>controller</code></td>
        <td><code>RunController</code></td>
        <td><p>parent Controller object</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/highway/highway_maz.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">RunController</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MAZ-to-MAZ shortest-path highway assignment.</span>

<span class="sd">    Args:</span>
<span class="sd">        controller: parent Controller object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># bins: performance parameter: crow-fly distance bins</span>
    <span class="c1">#       to limit shortest path calculation by origin to furthest destination</span>
    <span class="c1">#       semi-exposed for performance testing</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_bin_edges</span> <span class="o">=</span> <span class="n">_default_bin_edges</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Internal attributes to track data through the sequence of steps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_eb_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_mazs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_demand</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_max_dist</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_network</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_root_index</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_leaf_index</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tm2py.components.network.highway.highway_maz.AssignMAZSPDemand.run" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.components.network.highway.highway_maz.AssignMAZSPDemand.run" class="headerlink" title="Permanent link"> ¶</a></h7>

    <div class="doc doc-contents ">

      <p>Run MAZ-to-MAZ shortest path assignment.</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/highway/highway_maz.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@LogStartEnd</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run MAZ-to-MAZ shortest path assignment.&quot;&quot;&quot;</span>
    <span class="n">emme_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span>
    <span class="n">emmebank</span> <span class="o">=</span> <span class="n">emme_manager</span><span class="o">.</span><span class="n">emmebank</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">emme</span><span class="o">.</span><span class="n">highway_database_path</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_eb_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">emmebank</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="n">county_groups</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">demand_county_groups</span><span class="p">:</span>
        <span class="n">county_groups</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">counties</span>
    <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_period_names</span><span class="p">():</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_start_end</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;period </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_emme_scenario</span><span class="p">(</span><span class="n">emmebank</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_network</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">county_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">maz_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_county_mazs</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">maz_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;warning: no mazs for counties </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_process_demand</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">maz_ids</span><span class="p">)</span>
                <span class="n">demand_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_demand</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">demand_group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">demand_bins</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_find_roots_and_leaves</span><span class="p">(</span><span class="n">demand_group</span><span class="p">[</span><span class="s2">&quot;demand&quot;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_link_cost_maz</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_run_shortest_path</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">demand_group</span><span class="p">[</span><span class="s2">&quot;dist&quot;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_assign_flow</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">demand_group</span><span class="p">[</span><span class="s2">&quot;demand&quot;</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h6 id="tm2py.components.network.highway.highway_maz.SkimMAZCosts" class="doc doc-heading">
        <code>
SkimMAZCosts            (<a class="autorefs autorefs-internal" title="tm2py.components.component.Component" href="#tm2py.components.component.Component">Component</a>)
        </code>



<a href="#tm2py.components.network.highway.highway_maz.SkimMAZCosts" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>MAZ-to-MAZ shortest-path skim of time, distance and toll</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/highway/highway_maz.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SkimMAZCosts</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MAZ-to-MAZ shortest-path skim of time, distance and toll&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">RunController</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;MAZ-to-MAZ shortest-path skim of time, distance and toll</span>
<span class="sd">        Args:</span>
<span class="sd">            controller: parent RunController object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@LogStartEnd</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run shortest path skims for all available MAZ-to-MAZ O-D pairs.</span>

<span class="sd">        Runs a shortest path builder for each county, using a maz_skim_cost</span>
<span class="sd">        to limit the search. The valid gen cost (time + cost), distance and toll (drive alone)</span>
<span class="sd">        are written to CSV at the output_skim_file path:</span>
<span class="sd">        FROM_ZONE, TO_ZONE, COST, DISTANCE, BRIDGETOLL</span>

<span class="sd">        The following config inputs are used directly in this component. Note also</span>
<span class="sd">        that the network mode_code is prepared in the highway_network component</span>
<span class="sd">        using the excluded_links.</span>

<span class="sd">        config.highway.maz_to_maz:</span>
<span class="sd">            skim_period: name of the period used for the skim, must match one the</span>
<span class="sd">                defined config.time_periods</span>
<span class="sd">            demand_county_groups: used for the list of counties, creates a list out</span>
<span class="sd">                of all listed counties under [].counties</span>
<span class="sd">            output_skim_file: relative path to save the skims</span>
<span class="sd">            value_of_time: value of time used to convert tolls and auto operating cost</span>
<span class="sd">            operating_cost_per_mile: auto operating cost</span>
<span class="sd">            max_skim_cost: max cost value used to limit the shortest path search</span>
<span class="sd">            mode_code:</span>

<span class="sd">        config.emme.num_processors</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ref_period</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ref_period_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">skim_period</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_periods</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">period</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ref_period_name</span><span class="p">:</span>
                <span class="n">ref_period</span> <span class="o">=</span> <span class="n">period</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">ref_period</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;highway.maz_to_maz.skim_period: is not the name of an existing time_period&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_emme_scenario</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">emme</span><span class="o">.</span><span class="n">highway_database_path</span><span class="p">,</span> <span class="n">ref_period</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="c1"># prepare output file and write header</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">output_skim_file</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;FROM_ZONE, TO_ZONE, COST, DISTANCE, BRIDGETOLL</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">counties</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">demand_county_groups</span><span class="p">:</span>
            <span class="n">counties</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">counties</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_network</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">county</span> <span class="ow">in</span> <span class="n">counties</span><span class="p">:</span>
                <span class="n">num_roots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mark_roots</span><span class="p">(</span><span class="n">county</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">num_roots</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">sp_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_shortest_path</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_export_results</span><span class="p">(</span><span class="n">sp_values</span><span class="p">)</span>

    <span class="nd">@_context</span>
    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates the temp attributes used in the component.&quot;&quot;&quot;</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;LINK&quot;</span><span class="p">,</span> <span class="s2">&quot;@link_cost&quot;</span><span class="p">,</span> <span class="s2">&quot;total cost MAZ-MAZ&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;NODE&quot;</span><span class="p">,</span> <span class="s2">&quot;@maz_root&quot;</span><span class="p">,</span> <span class="s2">&quot;selected roots (origins)&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">temp_attributes_and_restore</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">,</span> <span class="n">attributes</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_network</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># clear network obj ref to free memory</span>

    <span class="nd">@LogStartEnd</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_prepare_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates the link cost in @link_cost and loads the network to self._network&quot;&quot;&quot;</span>
        <span class="n">net_calc</span> <span class="o">=</span> <span class="n">NetworkCalculator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="o">.</span><span class="n">has_traffic_results</span><span class="p">:</span>
            <span class="n">time_attr</span> <span class="o">=</span> <span class="s2">&quot;(@free_flow_time.max.timau)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time_attr</span> <span class="o">=</span> <span class="s2">&quot;@free_flow_time&quot;</span>
        <span class="n">vot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">value_of_time</span>
        <span class="n">op_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">operating_cost_per_mile</span>
        <span class="n">net_calc</span><span class="p">(</span><span class="s2">&quot;@link_cost&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time_attr</span><span class="si">}</span><span class="s2"> + 0.6 / </span><span class="si">{</span><span class="n">vot</span><span class="si">}</span><span class="s2"> * (length * </span><span class="si">{</span><span class="n">op_cost</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">get_network</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;NODE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;@maz_id&quot;</span><span class="p">,</span> <span class="s2">&quot;#node_county&quot;</span><span class="p">]}</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mark_roots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">county</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Mark the available roots in the county.&quot;&quot;&quot;</span>
        <span class="n">count_roots</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;@maz_id&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;#node_county&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">county</span><span class="p">:</span>
                <span class="n">node</span><span class="p">[</span><span class="s2">&quot;@maz_root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;@maz_id&quot;</span><span class="p">]</span>
                <span class="n">count_roots</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node</span><span class="p">[</span><span class="s2">&quot;@maz_root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="o">.</span><span class="n">get_attribute_values</span><span class="p">(</span><span class="s2">&quot;NODE&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;@maz_root&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="o">.</span><span class="n">set_attribute_values</span><span class="p">(</span><span class="s2">&quot;NODE&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;@maz_root&quot;</span><span class="p">],</span> <span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">count_roots</span>

    <span class="k">def</span> <span class="nf">_run_shortest_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NumpyArray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Run shortest paths tool and return dictionary of skim results name, numpy arrays.</span>

<span class="sd">        O-D pairs are limited by a max cost value from config.highway.maz_to_maz.max_skim_cost,</span>
<span class="sd">        from roots marked by @maz_root to all available leaves at @maz_id.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary with keys &quot;COST&quot;, &quot;DISTANCE&quot;, and &quot;BRIDGETOLL&quot;, and numpy</span>
<span class="sd">            arrays of SP values for available O-D pairs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shortest_paths_tool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
            <span class="s2">&quot;inro.emme.network_calculation.shortest_path&quot;</span>
        <span class="p">)</span>
        <span class="n">num_processors</span> <span class="o">=</span> <span class="n">parse_num_processors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">emme</span><span class="o">.</span><span class="n">num_processors</span><span class="p">)</span>
        <span class="n">max_cost</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">max_skim_cost</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;SHORTEST_PATH&quot;</span><span class="p">,</span>
            <span class="s2">&quot;modes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">mode_code</span><span class="p">],</span>
            <span class="s2">&quot;root_nodes&quot;</span><span class="p">:</span> <span class="s2">&quot;@maz_root&quot;</span><span class="p">,</span>
            <span class="s2">&quot;leaf_nodes&quot;</span><span class="p">:</span> <span class="s2">&quot;@maz_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;link_cost&quot;</span><span class="p">:</span> <span class="s2">&quot;@link_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;path_constraints&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;max_cost&quot;</span><span class="p">:</span> <span class="n">max_cost</span><span class="p">,</span>
                <span class="s2">&quot;uturn_allowed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;through_leaves&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;through_centroids&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;exclude_forbidden_turns&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;skim_output&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;return_numpy&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;analyses&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;SHORTEST_PATH_COST&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;COST&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;length&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;DISTANCE&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;@bridgetoll_da&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;BRIDGETOLL&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;OMX&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s2">&quot;performance_settings&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;number_of_processors&quot;</span><span class="p">:</span> <span class="n">num_processors</span><span class="p">,</span>
                <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;FORWARD&quot;</span><span class="p">,</span>
                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;STANDARD&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">sp_values</span> <span class="o">=</span> <span class="n">shortest_paths_tool</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sp_values</span>

    <span class="k">def</span> <span class="nf">_export_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NumpyArray</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Write matrix skims to CSV.</span>

<span class="sd">        The matrices are filtered to omit rows for which the COST is</span>
<span class="sd">        &lt; 0 or &gt; 1e19 (Emme uses 1e20 to indicate inaccessible zone pairs).</span>

<span class="sd">        sp_values: dictionary of matrix costs, with the three keys</span>
<span class="sd">            &quot;COST&quot;, &quot;DISTANCE&quot;, and &quot;BRIDGETOLL&quot; and Numpy arrays of values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get list of MAZ IDS</span>
        <span class="n">roots</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">node</span><span class="p">[</span><span class="s2">&quot;@maz_root&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;@maz_root&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">leaves</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s2">&quot;@maz_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;@maz_id&quot;</span><span class="p">]]</span>
        <span class="c1"># build dataframe with output data and to/from MAZ ids</span>
        <span class="n">root_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">leaves</span><span class="p">))</span>
        <span class="n">leaf_ids</span> <span class="o">=</span> <span class="n">leaves</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span>
        <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;FROM_ZONE&quot;</span><span class="p">:</span> <span class="n">root_ids</span><span class="p">,</span>
                <span class="s2">&quot;TO_ZONE&quot;</span><span class="p">:</span> <span class="n">leaf_ids</span><span class="p">,</span>
                <span class="s2">&quot;COST&quot;</span><span class="p">:</span> <span class="n">sp_values</span><span class="p">[</span><span class="s2">&quot;COST&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="s2">&quot;DISTANCE&quot;</span><span class="p">:</span> <span class="n">sp_values</span><span class="p">[</span><span class="s2">&quot;DISTANCE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="s2">&quot;BRIDGETOLL&quot;</span><span class="p">:</span> <span class="n">sp_values</span><span class="p">[</span><span class="s2">&quot;BRIDGETOLL&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># drop 0&#39;s / 1e20</span>
        <span class="n">result_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;COST &gt; 0 &amp; COST &lt; 1e19&quot;</span><span class="p">)</span>
        <span class="c1"># write remaining values to text file</span>
        <span class="c1"># FROM_ZONE,TO_ZONE,COST,DISTANCE,BRIDGETOLL</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">output_skim_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
            <span class="n">result_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tm2py.components.network.highway.highway_maz.SkimMAZCosts.__init__" class="doc doc-heading">
<code class="codehilite language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#tm2py.components.network.highway.highway_maz.SkimMAZCosts.__init__" class="headerlink" title="Permanent link"> ¶</a></h7>

    <div class="doc doc-contents ">

      <p>MAZ-to-MAZ shortest-path skim of time, distance and toll</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>controller</code></td>
        <td><code>RunController</code></td>
        <td><p>parent RunController object</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/highway/highway_maz.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">RunController</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MAZ-to-MAZ shortest-path skim of time, distance and toll</span>
<span class="sd">    Args:</span>
<span class="sd">        controller: parent RunController object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_network</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="tm2py.components.network.highway.highway_maz.SkimMAZCosts.run" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.components.network.highway.highway_maz.SkimMAZCosts.run" class="headerlink" title="Permanent link"> ¶</a></h7>

    <div class="doc doc-contents ">

      <p>Run shortest path skims for all available MAZ-to-MAZ O-D pairs.</p>
<p>Runs a shortest path builder for each county, using a maz_skim_cost
to limit the search. The valid gen cost (time + cost), distance and toll (drive alone)
are written to CSV at the output_skim_file path:
FROM_ZONE, TO_ZONE, COST, DISTANCE, BRIDGETOLL</p>
<p>The following config inputs are used directly in this component. Note also
that the network mode_code is prepared in the highway_network component
using the excluded_links.</p>
<p>config.highway.maz_to_maz:
    !!! skim_period &ldquo;name of the period used for the skim, must match one the&rdquo;
        defined config.time_periods
    !!! demand_county_groups &ldquo;used for the list of counties, creates a list out&rdquo;
        of all listed counties under [].counties
    output_skim_file: relative path to save the skims
    value_of_time: value of time used to convert tolls and auto operating cost
    operating_cost_per_mile: auto operating cost
    max_skim_cost: max cost value used to limit the shortest path search
    mode_code:</p>
<p>config.emme.num_processors</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/highway/highway_maz.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@LogStartEnd</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run shortest path skims for all available MAZ-to-MAZ O-D pairs.</span>

<span class="sd">    Runs a shortest path builder for each county, using a maz_skim_cost</span>
<span class="sd">    to limit the search. The valid gen cost (time + cost), distance and toll (drive alone)</span>
<span class="sd">    are written to CSV at the output_skim_file path:</span>
<span class="sd">    FROM_ZONE, TO_ZONE, COST, DISTANCE, BRIDGETOLL</span>

<span class="sd">    The following config inputs are used directly in this component. Note also</span>
<span class="sd">    that the network mode_code is prepared in the highway_network component</span>
<span class="sd">    using the excluded_links.</span>

<span class="sd">    config.highway.maz_to_maz:</span>
<span class="sd">        skim_period: name of the period used for the skim, must match one the</span>
<span class="sd">            defined config.time_periods</span>
<span class="sd">        demand_county_groups: used for the list of counties, creates a list out</span>
<span class="sd">            of all listed counties under [].counties</span>
<span class="sd">        output_skim_file: relative path to save the skims</span>
<span class="sd">        value_of_time: value of time used to convert tolls and auto operating cost</span>
<span class="sd">        operating_cost_per_mile: auto operating cost</span>
<span class="sd">        max_skim_cost: max cost value used to limit the shortest path search</span>
<span class="sd">        mode_code:</span>

<span class="sd">    config.emme.num_processors</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ref_period</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ref_period_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">skim_period</span>
    <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_periods</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">period</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ref_period_name</span><span class="p">:</span>
            <span class="n">ref_period</span> <span class="o">=</span> <span class="n">period</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">ref_period</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;highway.maz_to_maz.skim_period: is not the name of an existing time_period&quot;</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_emme_scenario</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">emme</span><span class="o">.</span><span class="n">highway_database_path</span><span class="p">,</span> <span class="n">ref_period</span><span class="o">.</span><span class="n">name</span>
    <span class="p">)</span>
    <span class="c1"># prepare output file and write header</span>
    <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">output_skim_file</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;FROM_ZONE, TO_ZONE, COST, DISTANCE, BRIDGETOLL</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">counties</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">demand_county_groups</span><span class="p">:</span>
        <span class="n">counties</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">counties</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_network</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">county</span> <span class="ow">in</span> <span class="n">counties</span><span class="p">:</span>
            <span class="n">num_roots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mark_roots</span><span class="p">(</span><span class="n">county</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_roots</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">sp_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_shortest_path</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_export_results</span><span class="p">(</span><span class="n">sp_values</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h5 id="tm2py.components.network.highway.highway_network" class="doc doc-heading">
        <code>highway_network</code>



<a href="#tm2py.components.network.highway.highway_network" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Module for highway network preparation steps.</p>
<p>Creates required attributes and populates input values needed
for highway assignments. The toll values, VDFs, per-class cost
(tolls+operating costs), modes and skim link attributes are calculated.</p>
<p>The following link attributes are used as input:
    - &ldquo;@capclass&rdquo;: link capclass index
    - &ldquo;length&rdquo;: standard link length, in miles
    - &ldquo;@tollbooth&rdquo;: label to separate bridgetolls from valuetolls
    - &ldquo;@tollseg&rdquo;: toll segment, used to index toll value lookups from the toll file
        (under config.highway.tolls.file_path)
    - &ldquo;@ft&rdquo;: functional class, used to assign VDFs</p>
<p>The following keys and tables are used from the config:
    highway.tolls.file_path: relative path to input toll file
    highway.tolls.src_vehicle_group_names: names used in tolls file for
        toll class values
    highway.tolls.dst_vehicle_group_names: corresponding names used in
        network attributes toll classes
    highway.tolls.tollbooth_start_index: index to split point bridge tolls
        (&lt; this value) from distance value tolls (&gt;= this value)
    highway.classes: the list of assignment classes, see the notes under
        highway_assign for detailed explanation
    highway.capclass_lookup: the lookup table mapping the link @capclass setting
        to capacity (@capacity), free_flow_speed (@free_flow_speec) and
        critical_speed (used to calculate @ja for akcelik type functions)
    highway.generic_highway_mode_code: unique (with other mode_codes) single
        character used to label entire auto network in Emme
    highway.maz_to_maz.mode_code: unique (with other mode_codes) single
        character used to label MAZ local auto network including connectors</p>
<p>The following link attributes are created (overwritten) and are subsequently used in
the highway assignments.
    - &ldquo;@flow_XX&rdquo;: link PCE flows per class, where XX is the class name in the config
    - &ldquo;@maz_flow&rdquo;: Assigned MAZ-to-MAZ flow</p>
<p>The following attributes are calculated:
    - vdf: volume delay function to use
    - &ldquo;@capacity&rdquo;: total link capacity
    - &ldquo;@ja&rdquo;: akcelik delay parameter
    - &ldquo;@hov_length&rdquo;: length with HOV lanes
    - &ldquo;@toll_length&rdquo;: length with tolls
    - &ldquo;@bridgetoll_YY&rdquo;: the bridge toll for class subgroup YY
    - &ldquo;@valuetoll_YY&rdquo;: the &ldquo;value&rdquo;, non-bridge toll for class subgroup YY
    - &ldquo;@cost_YY&rdquo;: total cost for class YY</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h6 id="tm2py.components.network.highway.highway_network.PrepareNetwork" class="doc doc-heading">
        <code>
PrepareNetwork            (<a class="autorefs autorefs-internal" title="tm2py.components.component.Component" href="#tm2py.components.component.Component">Component</a>)
        </code>



<a href="#tm2py.components.network.highway.highway_network.PrepareNetwork" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Highway network preparation</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/highway/highway_network.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">PrepareNetwork</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Highway network preparation&quot;&quot;&quot;</span>

    <span class="nd">@LogStartEnd</span><span class="p">(</span><span class="s2">&quot;prepare network attributes and modes&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run network preparation step&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_period_names</span><span class="p">():</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">logbook_trace</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;prepare for highway assignment </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">):</span>
                <span class="n">scenario</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_emme_scenario</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">emme</span><span class="o">.</span><span class="n">highway_database_path</span><span class="p">,</span> <span class="n">time</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_class_attributes</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
                <span class="n">network</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_network</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_tolls</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_vdf_attributes</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_link_modes</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calc_link_skim_lengths</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calc_link_class_costs</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
                <span class="n">scenario</span><span class="o">.</span><span class="n">publish_network</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_class_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">EmmeScenario</span><span class="p">,</span> <span class="n">time_period</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create required network attributes including per-class cost and flow attributes.&quot;&quot;&quot;</span>
        <span class="n">create_attribute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
            <span class="s2">&quot;inro.emme.data.extra_attribute.create_extra_attribute&quot;</span>
        <span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;LINK&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;@capacity&quot;</span><span class="p">,</span> <span class="s2">&quot;total link capacity&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;@ja&quot;</span><span class="p">,</span> <span class="s2">&quot;akcelik delay parameter&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;@maz_flow&quot;</span><span class="p">,</span> <span class="s2">&quot;Assigned MAZ-to-MAZ flow&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;@hov_length&quot;</span><span class="p">,</span> <span class="s2">&quot;length with HOV lanes&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;@toll_length&quot;</span><span class="p">,</span> <span class="s2">&quot;length with tolls&quot;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="c1"># toll field attributes by bridge and value and toll definition</span>
        <span class="n">dst_veh_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">tolls</span><span class="o">.</span><span class="n">dst_vehicle_group_names</span>
        <span class="k">for</span> <span class="n">dst_veh</span> <span class="ow">in</span> <span class="n">dst_veh_groups</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">toll_type</span> <span class="ow">in</span> <span class="s2">&quot;bridge&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span>
                <span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;LINK&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">toll_type</span><span class="si">}</span><span class="s2">toll_</span><span class="si">{</span><span class="n">dst_veh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">toll_type</span><span class="si">}</span><span class="s2"> toll value for </span><span class="si">{</span><span class="n">dst_veh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="c1"># results for link cost and assigned flow</span>
        <span class="k">for</span> <span class="n">assign_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
            <span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;LINK&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;@cost_</span><span class="si">{</span><span class="n">assign_class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">time_period</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">assign_class</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> total costs&#39;</span><span class="p">[:</span><span class="mi">40</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;LINK&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;@flow_</span><span class="si">{</span><span class="n">assign_class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">time_period</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">assign_class</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> link volume&#39;</span><span class="p">[:</span><span class="mi">40</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">domain</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">create_attribute</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_tolls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="p">:</span> <span class="n">EmmeNetwork</span><span class="p">,</span> <span class="n">time_period</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the tolls in the network from the toll reference file.&quot;&quot;&quot;</span>
        <span class="n">toll_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_toll_indices</span><span class="p">()</span>
        <span class="n">src_veh_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">tolls</span><span class="o">.</span><span class="n">src_vehicle_group_names</span>
        <span class="n">dst_veh_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">tolls</span><span class="o">.</span><span class="n">dst_vehicle_group_names</span>
        <span class="n">tollbooth_start_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">tolls</span><span class="o">.</span><span class="n">tollbooth_start_index</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">links</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@tollbooth&quot;</span><span class="p">]:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@tollbooth&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>
                    <span class="o">+</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@tollseg&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
                    <span class="o">+</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@useclass&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">data_row</span> <span class="o">=</span> <span class="n">toll_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data_row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;set tolls failed index lookup </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">, link </span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">level</span><span class="o">=</span><span class="s2">&quot;TRACE&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>  <span class="c1"># tolls will remain at zero</span>
                <span class="c1"># if index is below tollbooth start index then this is a bridge</span>
                <span class="c1"># (point toll), available for all traffic assignment classes</span>
                <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@tollbooth&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tollbooth_start_index</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">src_veh</span><span class="p">,</span> <span class="n">dst_veh</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">src_veh_groups</span><span class="p">,</span> <span class="n">dst_veh_groups</span><span class="p">):</span>
                        <span class="n">link</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;@bridgetoll_</span><span class="si">{</span><span class="n">dst_veh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">data_row</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;toll</span><span class="si">{</span><span class="n">time_period</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">src_veh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># else, this is a tollway with a per-mile charge</span>
                    <span class="k">for</span> <span class="n">src_veh</span><span class="p">,</span> <span class="n">dst_veh</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">src_veh_groups</span><span class="p">,</span> <span class="n">dst_veh_groups</span><span class="p">):</span>
                        <span class="n">link</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;@valuetoll_</span><span class="si">{</span><span class="n">dst_veh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">data_row</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;toll</span><span class="si">{</span><span class="n">time_period</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">src_veh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                            <span class="o">*</span> <span class="n">link</span><span class="o">.</span><span class="n">length</span>
                            <span class="o">*</span> <span class="mi">100</span>
                        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_toll_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Get the mapping of toll lookup table from the toll reference file.&quot;&quot;&quot;</span>
        <span class="n">toll_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">tolls</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">tolls</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">toll_file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">toll_file</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">toll_file</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">toll_file</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span>
                <span class="n">tolls</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fac_index&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="n">tolls</span>

    <span class="k">def</span> <span class="nf">_set_vdf_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="p">:</span> <span class="n">EmmeNetwork</span><span class="p">,</span> <span class="n">time_period</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set capacity, VDF and critical speed on links&quot;&quot;&quot;</span>
        <span class="n">capacity_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">critical_speed_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">capclass_lookup</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capacity&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">capacity_map</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;capclass&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capacity&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;critical_speed&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">critical_speed_map</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;capclass&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;critical_speed&quot;</span><span class="p">)</span>
        <span class="n">tp_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tp</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">highway_capacity_factor</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_periods</span>
        <span class="p">}</span>
        <span class="n">period_capacity_factor</span> <span class="o">=</span> <span class="n">tp_mapping</span><span class="p">[</span><span class="n">time_period</span><span class="p">]</span>
        <span class="n">akcelik_vdfs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">links</span><span class="p">():</span>
            <span class="n">cap_lanehour</span> <span class="o">=</span> <span class="n">capacity_map</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="s2">&quot;@capclass&quot;</span><span class="p">]]</span>
            <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@capacity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cap_lanehour</span> <span class="o">*</span> <span class="n">period_capacity_factor</span> <span class="o">*</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@lanes&quot;</span><span class="p">]</span>
            <span class="n">link</span><span class="o">.</span><span class="n">volume_delay_func</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="s2">&quot;@ft&quot;</span><span class="p">])</span>
            <span class="c1"># re-mapping links with type 99 to type 7 &quot;local road of minor importance&quot;</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">volume_delay_func</span> <span class="o">==</span> <span class="mi">99</span><span class="p">:</span>
                <span class="n">link</span><span class="o">.</span><span class="n">volume_delay_func</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="c1"># num_lanes not used directly, but set for reference</span>
            <span class="n">link</span><span class="o">.</span><span class="n">num_lanes</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">9.9</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@lanes&quot;</span><span class="p">]),</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">volume_delay_func</span> <span class="ow">in</span> <span class="n">akcelik_vdfs</span> <span class="ow">and</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@free_flow_speed&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">length</span>
                <span class="n">critical_speed</span> <span class="o">=</span> <span class="n">critical_speed_map</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="s2">&quot;@capclass&quot;</span><span class="p">]]</span>
                <span class="n">t_c</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">/</span> <span class="n">critical_speed</span>
                <span class="n">t_o</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">/</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@free_flow_speed&quot;</span><span class="p">]</span>
                <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@ja&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_c</span> <span class="o">-</span> <span class="n">t_o</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">_set_link_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="p">:</span> <span class="n">EmmeNetwork</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the link modes based on the per-class &#39;excluded_links&#39; set.&quot;&quot;&quot;</span>
        <span class="c1"># first reset link modes (script run more than once)</span>
        <span class="c1"># &quot;generic_highway_mode_code&quot; must already be created (in import to Emme script)</span>
        <span class="n">auto_mode</span> <span class="o">=</span> <span class="p">{</span><span class="n">network</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">generic_highway_mode_code</span><span class="p">)}</span>
        <span class="n">used_modes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">network</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">assign_class</span><span class="o">.</span><span class="n">mode_code</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">assign_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">classes</span>
        <span class="p">}</span>
        <span class="n">used_modes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">mode_code</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">links</span><span class="p">():</span>
            <span class="n">link</span><span class="o">.</span><span class="n">modes</span> <span class="o">-=</span> <span class="n">used_modes</span>
            <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@drive_link&quot;</span><span class="p">]:</span>
                <span class="n">link</span><span class="o">.</span><span class="n">modes</span> <span class="o">|=</span> <span class="n">auto_mode</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">used_modes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">network</span><span class="o">.</span><span class="n">delete_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>

        <span class="c1"># Create special access/egress mode for MAZ connectors</span>
        <span class="n">maz_access_mode</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">create_mode</span><span class="p">(</span>
            <span class="s2">&quot;AUX_AUTO&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">mode_code</span>
        <span class="p">)</span>
        <span class="n">maz_access_mode</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;MAZ access&quot;</span>
        <span class="c1"># create modes from class spec</span>
        <span class="c1"># (duplicate mode codes allowed provided the excluded_links is the same)</span>
        <span class="n">mode_excluded_links</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">assign_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">assign_class</span><span class="o">.</span><span class="n">mode_code</span> <span class="ow">in</span> <span class="n">mode_excluded_links</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">assign_class</span><span class="o">.</span><span class="n">excluded_links</span>
                    <span class="o">!=</span> <span class="n">mode_excluded_links</span><span class="p">[</span><span class="n">assign_class</span><span class="o">.</span><span class="n">mode_code</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">ex_links1</span> <span class="o">=</span> <span class="n">mode_excluded_links</span><span class="p">[</span><span class="n">assign_class</span><span class="o">.</span><span class="n">mode_code</span><span class="p">]</span>
                    <span class="n">ex_links2</span> <span class="o">=</span> <span class="n">assign_class</span><span class="o">.</span><span class="n">excluded_links</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;config error: highway.classes, duplicated mode codes &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;(&#39;</span><span class="si">{</span><span class="n">assign_class</span><span class="o">.</span><span class="n">mode_code</span><span class="si">}</span><span class="s2">&#39;) with different excluded &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;links: </span><span class="si">{</span><span class="n">ex_links1</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">ex_links2</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">create_mode</span><span class="p">(</span><span class="s2">&quot;AUX_AUTO&quot;</span><span class="p">,</span> <span class="n">assign_class</span><span class="o">.</span><span class="n">mode_code</span><span class="p">)</span>
            <span class="n">mode</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">assign_class</span><span class="o">.</span><span class="n">name</span>
            <span class="n">mode_excluded_links</span><span class="p">[</span><span class="n">mode</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign_class</span><span class="o">.</span><span class="n">excluded_links</span>

        <span class="n">dst_veh_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">tolls</span><span class="o">.</span><span class="n">dst_vehicle_group_names</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">links</span><span class="p">():</span>
            <span class="n">modes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">modes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">i_node</span><span class="p">[</span><span class="s2">&quot;@maz_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">link</span><span class="o">.</span><span class="n">j_node</span><span class="p">[</span><span class="s2">&quot;@maz_id&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">modes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">maz_access_mode</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">link</span><span class="o">.</span><span class="n">modes</span> <span class="o">=</span> <span class="n">modes</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@drive_link&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">exclude_links_map</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;is_sr&quot;</span><span class="p">:</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@useclass&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                <span class="s2">&quot;is_sr2&quot;</span><span class="p">:</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@useclass&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;is_sr3&quot;</span><span class="p">:</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@useclass&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;is_auto_only&quot;</span><span class="p">:</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@useclass&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">dst_veh</span> <span class="ow">in</span> <span class="n">dst_veh_groups</span><span class="p">:</span>
                <span class="n">exclude_links_map</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;is_toll_</span><span class="si">{</span><span class="n">dst_veh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">link</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;@valuetoll_</span><span class="si">{</span><span class="n">dst_veh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_exclusions</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">maz_to_maz</span><span class="o">.</span><span class="n">excluded_links</span><span class="p">,</span>
                <span class="n">maz_access_mode</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">modes</span><span class="p">,</span>
                <span class="n">exclude_links_map</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">assign_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply_exclusions</span><span class="p">(</span>
                    <span class="n">assign_class</span><span class="o">.</span><span class="n">excluded_links</span><span class="p">,</span>
                    <span class="n">assign_class</span><span class="o">.</span><span class="n">mode_code</span><span class="p">,</span>
                    <span class="n">modes</span><span class="p">,</span>
                    <span class="n">exclude_links_map</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">link</span><span class="o">.</span><span class="n">modes</span> <span class="o">=</span> <span class="n">modes</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_apply_exclusions</span><span class="p">(</span>
        <span class="n">excluded_links_criteria</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">mode_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">modes_set</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">link_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply the exclusion criteria to set the link modes.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">criteria</span> <span class="ow">in</span> <span class="n">excluded_links_criteria</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link_values</span><span class="p">[</span><span class="n">criteria</span><span class="p">]:</span>
                <span class="k">return</span>
        <span class="n">modes_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mode_code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calc_link_skim_lengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="p">:</span> <span class="n">EmmeNetwork</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the length attributes used in the highway skims.&quot;&quot;&quot;</span>
        <span class="n">tollbooth_start_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">tolls</span><span class="o">.</span><span class="n">tollbooth_start_index</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">links</span><span class="p">():</span>
            <span class="c1"># distance in hov lanes / facilities</span>
            <span class="k">if</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@useclass&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@hov_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">length</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@hov_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># distance on non-bridge toll facilities</span>
            <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@tollbooth&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tollbooth_start_index</span><span class="p">:</span>
                <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@toll_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">length</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">link</span><span class="p">[</span><span class="s2">&quot;@toll_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_calc_link_class_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="p">:</span> <span class="n">EmmeNetwork</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the per-class link cost from the tolls and operating costs.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">assign_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highway</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
            <span class="n">cost_attr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;@cost_</span><span class="si">{</span><span class="n">assign_class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">op_cost</span> <span class="o">=</span> <span class="n">assign_class</span><span class="p">[</span><span class="s2">&quot;operating_cost_per_mile&quot;</span><span class="p">]</span>
            <span class="n">toll_factor</span> <span class="o">=</span> <span class="n">assign_class</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;toll_factor&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">toll_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">toll_factor</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">links</span><span class="p">():</span>
                <span class="n">toll_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="n">toll_attr</span><span class="p">]</span> <span class="k">for</span> <span class="n">toll_attr</span> <span class="ow">in</span> <span class="n">assign_class</span><span class="p">[</span><span class="s2">&quot;toll&quot;</span><span class="p">])</span>
                <span class="n">link</span><span class="p">[</span><span class="n">cost_attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">length</span> <span class="o">*</span> <span class="n">op_cost</span> <span class="o">+</span> <span class="n">toll_value</span> <span class="o">*</span> <span class="n">toll_factor</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="tm2py.components.network.highway.highway_network.PrepareNetwork.run" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.components.network.highway.highway_network.PrepareNetwork.run" class="headerlink" title="Permanent link"> ¶</a></h7>

    <div class="doc doc-contents ">

      <p>Run network preparation step</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/highway/highway_network.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@LogStartEnd</span><span class="p">(</span><span class="s2">&quot;prepare network attributes and modes&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run network preparation step&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_period_names</span><span class="p">():</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">emme_manager</span><span class="o">.</span><span class="n">logbook_trace</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;prepare for highway assignment </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">):</span>
            <span class="n">scenario</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_emme_scenario</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">emme</span><span class="o">.</span><span class="n">highway_database_path</span><span class="p">,</span> <span class="n">time</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_class_attributes</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="n">network</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_network</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_tolls</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_vdf_attributes</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_link_modes</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calc_link_skim_lengths</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calc_link_class_costs</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
            <span class="n">scenario</span><span class="o">.</span><span class="n">publish_network</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="tm2py.components.network.transit" class="doc doc-heading">
        <code>transit</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#tm2py.components.network.transit" class="headerlink" title="Permanent link"> ¶</a></h4>

    <div class="doc doc-contents ">

      <p>Transit assignment and skim module</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h5 id="tm2py.components.network.transit.transit_assign" class="doc doc-heading">
        <code>transit_assign</code>



<a href="#tm2py.components.network.transit.transit_assign" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Transit assignment module</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h6 id="tm2py.components.network.transit.transit_assign.TransitAssignment" class="doc doc-heading">
        <code>
TransitAssignment            (<a class="autorefs autorefs-internal" title="tm2py.components.component.Component" href="#tm2py.components.component.Component">Component</a>)
        </code>



<a href="#tm2py.components.network.transit.transit_assign.TransitAssignment" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Run transit assignment.</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/transit/transit_assign.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TransitAssignment</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run transit assignment.&quot;&quot;&quot;</span>
</code></pre></div>
        </details>


    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h5 id="tm2py.components.network.transit.transit_skim" class="doc doc-heading">
        <code>transit_skim</code>



<a href="#tm2py.components.network.transit.transit_skim" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Transit skims module</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h6 id="tm2py.components.network.transit.transit_skim.TransitSkim" class="doc doc-heading">
        <code>
TransitSkim            (<a class="autorefs autorefs-internal" title="tm2py.components.component.Component" href="#tm2py.components.component.Component">Component</a>)
        </code>



<a href="#tm2py.components.network.transit.transit_skim.TransitSkim" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Run transit skims</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/components/network/transit/transit_skim.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TransitSkim</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run transit skims&quot;&quot;&quot;</span>
</code></pre></div>
        </details>


    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>




  </div>

    </div>

  </div>

<h2 id="emme-wrappers">Emme Wrappers<a class="headerlink" href="#emme-wrappers" title="Permanent link"> ¶</a></h2>


  <div class="doc doc-object doc-module">



<h3 id="tm2py.emme" class="doc doc-heading">
        <code>tm2py.emme</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#tm2py.emme" class="headerlink" title="Permanent link"> ¶</a></h3>

    <div class="doc doc-contents first">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h4 id="tm2py.emme.manager" class="doc doc-heading">
        <code>manager</code>



<a href="#tm2py.emme.manager" class="headerlink" title="Permanent link"> ¶</a></h4>

    <div class="doc doc-contents ">

      <p>Module for Emme Manager for centralized management of Emme projects</p>
<p>Centralized location for Emme API imports, which are automatically replaced
by unittest.Mock / MagicMock to support testing where Emme is not installed.</p>
<p>Contains EmmeManager class for access to common Emme-related procedures
(common-code / utility-type methods) and caching access to Emme project,
and Modeller.</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-class">



<h5 id="tm2py.emme.manager.EmmeManager" class="doc doc-heading">
        <code>
EmmeManager        </code>



<a href="#tm2py.emme.manager.EmmeManager" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Centralized cache for Emme project and related calls for traffic and transit assignments.</p>
<p>Wraps Emme Desktop API (see Emme API Reference for additional details on the Emme objects).</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/emme/manager.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">EmmeManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Centralized cache for Emme project and related calls for traffic and transit assignments.</span>

<span class="sd">    Wraps Emme Desktop API (see Emme API Reference for additional details on the Emme objects).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># mapping of Emme project path to Emme Desktop API object for reference</span>
        <span class="c1"># (projects are opened only once)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project_cache</span> <span class="o">=</span> <span class="n">_EMME_PROJECT_REF</span>

    <span class="k">def</span> <span class="nf">close_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close all open cached Emme project(s).</span>

<span class="sd">        Should be called at the end of the model process / Emme assignments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_cache</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_cache</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
            <span class="n">app</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeDesktopApp</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create, open and return Emme project</span>

<span class="sd">        Args:</span>
<span class="sd">            project_dir: path to Emme root directory for new Emme project</span>
<span class="sd">            name: name for the Emme project</span>

<span class="sd">        Returns:</span>
<span class="sd">            Emme Desktop App object, see Emme API Reference, Desktop section for details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">emp_path</span> <span class="o">=</span> <span class="n">_app</span><span class="o">.</span><span class="n">create_project</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">emp_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeDesktopApp</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return already open Emme project, or open new Desktop session if not found.</span>

<span class="sd">        Args:</span>
<span class="sd">            project_path: valid path to Emme project *.emp file</span>

<span class="sd">        Returns:</span>
<span class="sd">            Emme Desktop App object, see Emme API Reference, Desktop section for details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">project_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">project_path</span><span class="p">))</span>
        <span class="n">emme_project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">emme_project</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># Check if the Emme window was closed</span>
                <span class="n">emme_project</span><span class="o">.</span><span class="n">current_window</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">_socket_error</span><span class="p">:</span>
                <span class="n">emme_project</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># if window is not opened in this process, start a new one</span>
        <span class="k">if</span> <span class="n">emme_project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">project_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Emme project path does not exist </span><span class="si">{</span><span class="n">project_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">emme_project</span> <span class="o">=</span> <span class="n">_app</span><span class="o">.</span><span class="n">start_dedicated</span><span class="p">(</span>
                <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user_initials</span><span class="o">=</span><span class="s2">&quot;inro&quot;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">project_path</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_project_cache</span><span class="p">[</span><span class="n">project_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">emme_project</span>
        <span class="k">return</span> <span class="n">emme_project</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">emmebank</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Emmebank</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Open and return the Emmebank at path.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: valid system path pointing to an Emmebank file</span>
<span class="sd">        Returns:</span>
<span class="sd">            Emmebank object, see Emme API Reference, Database section for details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;emmebank&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;emmebank&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Emmebank</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">change_emmebank_dimensions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">emmebank</span><span class="p">:</span> <span class="n">Emmebank</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the Emmebank dimensions as specified. See the Emme API help for details.</span>

<span class="sd">        Args:</span>
<span class="sd">            emmebank: the Emmebank object to change the dimensions</span>
<span class="sd">            dimensions: dictionary of the specified dimensions to set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">emmebank</span><span class="o">.</span><span class="n">dimensions</span>
        <span class="n">new_dims</span> <span class="o">=</span> <span class="n">dims</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_dims</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dims</span> <span class="o">!=</span> <span class="n">new_dims</span><span class="p">:</span>
            <span class="n">change_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
                <span class="s2">&quot;inro.emme.data.database.change_database_dimensions&quot;</span>
            <span class="p">)</span>
            <span class="n">change_dimensions</span><span class="p">(</span><span class="n">new_dims</span><span class="p">,</span> <span class="n">emmebank</span><span class="p">,</span> <span class="n">keep_backup</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">modeller</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emme_project</span><span class="p">:</span> <span class="n">EmmeDesktopApp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeModeller</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize and return Modeller object.</span>

<span class="sd">        If Modeller has not already been initialized it will do so on</span>
<span class="sd">        specified Emme project, or the first Emme project opened if not provided.</span>
<span class="sd">        If already initialized Modeller will reference whichever project was used</span>
<span class="sd">        first.</span>

<span class="sd">        Args:</span>
<span class="sd">            emme_project: open &#39;Emme Desktop&#39; application (inro.emme.desktop.app)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Emme Modeller object, see Emme API Reference, Modeller section for details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=E0611, E0401, E1101</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">EmmeModeller</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">emme_project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_cache</span><span class="p">:</span>
                    <span class="n">emme_project</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project_cache</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;modeller not yet initialized and no cached Emme project,&quot;</span>
                        <span class="s2">&quot; emme_project arg must be provided&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>
            <span class="k">return</span> <span class="n">EmmeModeller</span><span class="p">(</span><span class="n">emme_project</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the Modeller tool at namespace.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Corresponding Tool object, see Emme Help for full details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modeller</span><span class="p">()</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@_context</span>
    <span class="k">def</span> <span class="nf">temp_attributes_and_restore</span><span class="p">(</span>
        <span class="n">scenario</span><span class="p">:</span> <span class="n">EmmeScenario</span><span class="p">,</span> <span class="n">attributes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create temp extra attribute and network field, and backup values and state and restore.</span>

<span class="sd">        Allows the use of temporary attributes which may conflict with existing attributes.</span>
<span class="sd">        The temp created attributes are deleted at the end, and if there were pre-existing</span>
<span class="sd">        attributes with the same names the values are restored.</span>

<span class="sd">        Note that name conflicts may still arise in the shorthand inheritance systems</span>
<span class="sd">        for the network hierarchy tree (@node attribute reserves -&gt; @nodei, @nodej, etc,</span>
<span class="sd">        see Emme help Network calculations for full list) which will raise an error in the</span>
<span class="sd">        Emme API.</span>

<span class="sd">        Args:</span>
<span class="sd">            scenario: Emme scenario object</span>
<span class="sd">            attributes: list of attribute details, where details is a list of 3 items</span>
<span class="sd">                for extra attributes and 4 for network fields: domain, name, description[, atype]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attrs_to_delete</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fields_to_delete</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">attrs_to_restore</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;NODE&quot;</span><span class="p">,</span> <span class="s2">&quot;LINK&quot;</span><span class="p">,</span> <span class="s2">&quot;TURN&quot;</span><span class="p">,</span> <span class="s2">&quot;TRANSIT_LINE&quot;</span><span class="p">,</span> <span class="s2">&quot;TRANSIT_SEGMENT&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">details</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">extra_attribute</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">network_field</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">or</span> <span class="n">field</span><span class="p">:</span>
                <span class="n">attrs_to_restore</span><span class="p">[</span><span class="n">domain</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">):</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">create_extra_attribute</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">attr</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">desc</span>
                <span class="n">attrs_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atype</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">create_nertwork_field</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">atype</span><span class="p">)</span>
                <span class="n">field</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">desc</span>
                <span class="n">fields_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="n">backup</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">domain</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">attrs_to_restore</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">backup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_attribute_values</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">names</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">attrs_to_delete</span><span class="p">:</span>
                <span class="n">scenario</span><span class="o">.</span><span class="n">delete_extra_attribute</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">domain</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fields_to_delete</span><span class="p">:</span>
                <span class="n">scenario</span><span class="o">.</span><span class="n">delete_network_field</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">domain</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">backup</span><span class="p">:</span>
                <span class="n">scenario</span><span class="o">.</span><span class="n">set_attribute_values</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">copy_attr_values</span><span class="p">(</span>
        <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">src</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EmmeScenario</span><span class="p">,</span> <span class="n">EmmeNetwork</span><span class="p">],</span>
        <span class="n">dst</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EmmeScenario</span><span class="p">,</span> <span class="n">EmmeNetwork</span><span class="p">],</span>
        <span class="n">src_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">dst_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy attribute values between Emme scenario (on disk) and network (in memory).</span>

<span class="sd">        Args:</span>
<span class="sd">            domain: attribute domain, one of &quot;NODE&quot;, &quot;LINK&quot;, &quot;TURN&quot;, &quot;TRANSIT_LINE&quot;,</span>
<span class="sd">                &quot;TRANSIT_SEGMENT&quot;</span>
<span class="sd">            src: source Emme scenario or network to load values from</span>
<span class="sd">            dst: destination Emme scenario or network to save values to</span>
<span class="sd">            src_names: names of the attributes for loading values</span>
<span class="sd">            dst_names: optional, names of the attributes to save values as, defaults</span>
<span class="sd">                to using the src_names if not specified</span>

<span class="sd">        Returns:</span>
<span class="sd">            Emme Modeller object, see Emme API Reference, Modeller section for details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dst_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dst_names</span> <span class="o">=</span> <span class="n">src_names</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">get_attribute_values</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">src_names</span><span class="p">)</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">set_attribute_values</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">dst_names</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_network</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">EmmeScenario</span><span class="p">,</span> <span class="n">attributes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeNetwork</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read partial Emme network from the scenario for the domains and attributes specified.</span>

<span class="sd">        Optimized load of network object from scenario (disk / emmebank) for only the</span>
<span class="sd">        domains specified, and only reads the attributes specified. The attributes is a</span>
<span class="sd">        dictionary with keys for the required domains, and values as lists of the</span>
<span class="sd">        attributes required by domain.</span>

<span class="sd">        Wrapper for scenario.get_partial_network followed by scenario.get_attribute_values</span>
<span class="sd">        and network.set_attribute_values.</span>

<span class="sd">        Args:</span>
<span class="sd">            scenario: Emme scenario object, see Emme API reference</span>
<span class="sd">            attributes: dictionary of domain names to lists of attribute names</span>

<span class="sd">        Returns:</span>
<span class="sd">            Emme Network object, see Emme API Reference, Network section for details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attributes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_network</span><span class="p">()</span>
        <span class="n">network</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_partial_network</span><span class="p">(</span>
            <span class="n">attributes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">include_attributes</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">domain</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">copy_attr_values</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">network</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">logbook_write</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write an entry to the Emme Logbook at the current nesting level.</span>

<span class="sd">        Wrapper for inro.modeller.logbook_write.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The title of the logbook entry</span>
<span class="sd">            attributes: Optional. A Python dictionary of key-value pairs to be</span>
<span class="sd">                        displayed in the logbook entry detailed view.</span>
<span class="sd">            value: Optional. An HTML string value to be displayed in main detail</span>
<span class="sd">                   pane of the logbook entry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=E0611, E0401, E1101</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span> <span class="k">if</span> <span class="n">attributes</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">logbook_write</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attributes</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@_context</span>
    <span class="k">def</span> <span class="nf">logbook_trace</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write an entry to the Modeller logbook and create a nest in the Logbook.</span>

<span class="sd">        Wrapper for inro.modeller.logbook_trace. Used in the with statement, e.g.</span>

<span class="sd">        ```</span>
<span class="sd">        with _emme_tools.logbook_trace(&#39;My nest&#39;):</span>
<span class="sd">            _emme_tools.logbook_write(&#39;This entry is nested&#39;)</span>
<span class="sd">        ```</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The title of the logbook entry</span>
<span class="sd">            attributes: Optional. A Python dictionary of key-value pairs to be</span>
<span class="sd">                        displayed in the logbook entry detailed view.</span>
<span class="sd">            value: Optional. An HTML string value to be displayed in main detail</span>
<span class="sd">                   pane of the logbook entry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=E0611, E0401, E1101</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span> <span class="k">if</span> <span class="n">attributes</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="n">logbook_trace</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attributes</span><span class="p">):</span>
            <span class="k">yield</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.manager.EmmeManager.change_emmebank_dimensions" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">change_emmebank_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emmebank</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">)</span></code>


<a href="#tm2py.emme.manager.EmmeManager.change_emmebank_dimensions" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Change the Emmebank dimensions as specified. See the Emme API help for details.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>emmebank</code></td>
        <td><code>&lt;MagicMock name=&#39;mock.Emmebank&#39; id=&#39;140348569782016&#39;&gt;</code></td>
        <td><p>the Emmebank object to change the dimensions</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dimensions</code></td>
        <td><code>Dict[str, int]</code></td>
        <td><p>dictionary of the specified dimensions to set.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/manager.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">change_emmebank_dimensions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">emmebank</span><span class="p">:</span> <span class="n">Emmebank</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Change the Emmebank dimensions as specified. See the Emme API help for details.</span>

<span class="sd">    Args:</span>
<span class="sd">        emmebank: the Emmebank object to change the dimensions</span>
<span class="sd">        dimensions: dictionary of the specified dimensions to set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">emmebank</span><span class="o">.</span><span class="n">dimensions</span>
    <span class="n">new_dims</span> <span class="o">=</span> <span class="n">dims</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_dims</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dims</span> <span class="o">!=</span> <span class="n">new_dims</span><span class="p">:</span>
        <span class="n">change_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
            <span class="s2">&quot;inro.emme.data.database.change_database_dimensions&quot;</span>
        <span class="p">)</span>
        <span class="n">change_dimensions</span><span class="p">(</span><span class="n">new_dims</span><span class="p">,</span> <span class="n">emmebank</span><span class="p">,</span> <span class="n">keep_backup</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.manager.EmmeManager.close_all" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">close_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.emme.manager.EmmeManager.close_all" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Close all open cached Emme project(s).</p>
<p>Should be called at the end of the model process / Emme assignments.</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/emme/manager.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">close_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Close all open cached Emme project(s).</span>

<span class="sd">    Should be called at the end of the model process / Emme assignments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_cache</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_cache</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
        <span class="n">app</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.manager.EmmeManager.copy_attr_values" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">copy_attr_values</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src_names</span><span class="p">,</span> <span class="n">dst_names</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#tm2py.emme.manager.EmmeManager.copy_attr_values" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Copy attribute values between Emme scenario (on disk) and network (in memory).</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>domain</code></td>
        <td><code>str</code></td>
        <td><p>attribute domain, one of &ldquo;NODE&rdquo;, &ldquo;LINK&rdquo;, &ldquo;TURN&rdquo;, &ldquo;TRANSIT_LINE&rdquo;,
&ldquo;TRANSIT_SEGMENT&rdquo;</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>src</code></td>
        <td><code>Union[&lt;MagicMock name=&#39;mock.Scenario&#39; id=&#39;140348569830544&#39;&gt;, &lt;MagicMock name=&#39;mock.Network&#39; id=&#39;140348569818544&#39;&gt;]</code></td>
        <td><p>source Emme scenario or network to load values from</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dst</code></td>
        <td><code>Union[&lt;MagicMock name=&#39;mock.Scenario&#39; id=&#39;140348569830544&#39;&gt;, &lt;MagicMock name=&#39;mock.Network&#39; id=&#39;140348569818544&#39;&gt;]</code></td>
        <td><p>destination Emme scenario or network to save values to</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>src_names</code></td>
        <td><code>List[str]</code></td>
        <td><p>names of the attributes for loading values</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dst_names</code></td>
        <td><code>List[str]</code></td>
        <td><p>optional, names of the attributes to save values as, defaults
to using the src_names if not specified</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>Emme Modeller object, see Emme API Reference, Modeller section for details.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/manager.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">copy_attr_values</span><span class="p">(</span>
    <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">src</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EmmeScenario</span><span class="p">,</span> <span class="n">EmmeNetwork</span><span class="p">],</span>
    <span class="n">dst</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EmmeScenario</span><span class="p">,</span> <span class="n">EmmeNetwork</span><span class="p">],</span>
    <span class="n">src_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">dst_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Copy attribute values between Emme scenario (on disk) and network (in memory).</span>

<span class="sd">    Args:</span>
<span class="sd">        domain: attribute domain, one of &quot;NODE&quot;, &quot;LINK&quot;, &quot;TURN&quot;, &quot;TRANSIT_LINE&quot;,</span>
<span class="sd">            &quot;TRANSIT_SEGMENT&quot;</span>
<span class="sd">        src: source Emme scenario or network to load values from</span>
<span class="sd">        dst: destination Emme scenario or network to save values to</span>
<span class="sd">        src_names: names of the attributes for loading values</span>
<span class="sd">        dst_names: optional, names of the attributes to save values as, defaults</span>
<span class="sd">            to using the src_names if not specified</span>

<span class="sd">    Returns:</span>
<span class="sd">        Emme Modeller object, see Emme API Reference, Modeller section for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dst_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dst_names</span> <span class="o">=</span> <span class="n">src_names</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">get_attribute_values</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">src_names</span><span class="p">)</span>
    <span class="n">dst</span><span class="o">.</span><span class="n">set_attribute_values</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">dst_names</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.manager.EmmeManager.create_project" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">create_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></code>


<a href="#tm2py.emme.manager.EmmeManager.create_project" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Create, open and return Emme project</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>project_dir</code></td>
        <td><code>str</code></td>
        <td><p>path to Emme root directory for new Emme project</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>name</code></td>
        <td><code>str</code></td>
        <td><p>name for the Emme project</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>&lt;MagicMock name=&#39;mock.emme.desktop.app.App&#39; id=&#39;140348569438768&#39;&gt;</code></td>
      <td><p>Emme Desktop App object, see Emme API Reference, Desktop section for details.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/manager.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">create_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeDesktopApp</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create, open and return Emme project</span>

<span class="sd">    Args:</span>
<span class="sd">        project_dir: path to Emme root directory for new Emme project</span>
<span class="sd">        name: name for the Emme project</span>

<span class="sd">    Returns:</span>
<span class="sd">        Emme Desktop App object, see Emme API Reference, Desktop section for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">emp_path</span> <span class="o">=</span> <span class="n">_app</span><span class="o">.</span><span class="n">create_project</span><span class="p">(</span><span class="n">project_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">emp_path</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.manager.EmmeManager.emmebank" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">emmebank</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#tm2py.emme.manager.EmmeManager.emmebank" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Open and return the Emmebank at path.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>path</code></td>
        <td><code>str</code></td>
        <td><p>valid system path pointing to an Emmebank file</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>&lt;MagicMock name=&#39;mock.Emmebank&#39; id=&#39;140348569782016&#39;&gt;</code></td>
      <td><p>Emmebank object, see Emme API Reference, Database section for details.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/manager.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">emmebank</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Emmebank</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Open and return the Emmebank at path.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: valid system path pointing to an Emmebank file</span>
<span class="sd">    Returns:</span>
<span class="sd">        Emmebank object, see Emme API Reference, Database section for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;emmebank&quot;</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;emmebank&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Emmebank</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.manager.EmmeManager.get_network" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">get_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#tm2py.emme.manager.EmmeManager.get_network" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Read partial Emme network from the scenario for the domains and attributes specified.</p>
<p>Optimized load of network object from scenario (disk / emmebank) for only the
domains specified, and only reads the attributes specified. The attributes is a
dictionary with keys for the required domains, and values as lists of the
attributes required by domain.</p>
<p>Wrapper for scenario.get_partial_network followed by scenario.get_attribute_values
and network.set_attribute_values.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>scenario</code></td>
        <td><code>&lt;MagicMock name=&#39;mock.Scenario&#39; id=&#39;140348569830544&#39;&gt;</code></td>
        <td><p>Emme scenario object, see Emme API reference</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>attributes</code></td>
        <td><code>Dict[str, List[str]]</code></td>
        <td><p>dictionary of domain names to lists of attribute names</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>&lt;MagicMock name=&#39;mock.Network&#39; id=&#39;140348569818544&#39;&gt;</code></td>
      <td><p>Emme Network object, see Emme API Reference, Network section for details.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/manager.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_network</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">EmmeScenario</span><span class="p">,</span> <span class="n">attributes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeNetwork</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Read partial Emme network from the scenario for the domains and attributes specified.</span>

<span class="sd">    Optimized load of network object from scenario (disk / emmebank) for only the</span>
<span class="sd">    domains specified, and only reads the attributes specified. The attributes is a</span>
<span class="sd">    dictionary with keys for the required domains, and values as lists of the</span>
<span class="sd">    attributes required by domain.</span>

<span class="sd">    Wrapper for scenario.get_partial_network followed by scenario.get_attribute_values</span>
<span class="sd">    and network.set_attribute_values.</span>

<span class="sd">    Args:</span>
<span class="sd">        scenario: Emme scenario object, see Emme API reference</span>
<span class="sd">        attributes: dictionary of domain names to lists of attribute names</span>

<span class="sd">    Returns:</span>
<span class="sd">        Emme Network object, see Emme API Reference, Network section for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">attributes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_network</span><span class="p">()</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_partial_network</span><span class="p">(</span>
        <span class="n">attributes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">include_attributes</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">domain</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy_attr_values</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">network</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.manager.EmmeManager.logbook_trace" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">logbook_trace</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#tm2py.emme.manager.EmmeManager.logbook_trace" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Write an entry to the Modeller logbook and create a nest in the Logbook.</p>
<p>Wrapper for inro.modeller.logbook_trace. Used in the with statement, e.g.</p>
<div class="highlight"><pre><span></span><code>with _emme_tools.logbook_trace(&#39;My nest&#39;):
    _emme_tools.logbook_write(&#39;This entry is nested&#39;)
</code></pre></div>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>name</code></td>
        <td><code>str</code></td>
        <td><p>The title of the logbook entry</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>attributes</code></td>
        <td><code>Dict[str, Any]</code></td>
        <td><p>Optional. A Python dictionary of key-value pairs to be
        displayed in the logbook entry detailed view.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>value</code></td>
        <td><code>str</code></td>
        <td><p>Optional. An HTML string value to be displayed in main detail
   pane of the logbook entry.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/manager.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="nd">@_context</span>
<span class="k">def</span> <span class="nf">logbook_trace</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write an entry to the Modeller logbook and create a nest in the Logbook.</span>

<span class="sd">    Wrapper for inro.modeller.logbook_trace. Used in the with statement, e.g.</span>

<span class="sd">    ```</span>
<span class="sd">    with _emme_tools.logbook_trace(&#39;My nest&#39;):</span>
<span class="sd">        _emme_tools.logbook_write(&#39;This entry is nested&#39;)</span>
<span class="sd">    ```</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The title of the logbook entry</span>
<span class="sd">        attributes: Optional. A Python dictionary of key-value pairs to be</span>
<span class="sd">                    displayed in the logbook entry detailed view.</span>
<span class="sd">        value: Optional. An HTML string value to be displayed in main detail</span>
<span class="sd">               pane of the logbook entry.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=E0611, E0401, E1101</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span> <span class="k">if</span> <span class="n">attributes</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="n">logbook_trace</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attributes</span><span class="p">):</span>
        <span class="k">yield</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.manager.EmmeManager.logbook_write" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">logbook_write</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#tm2py.emme.manager.EmmeManager.logbook_write" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Write an entry to the Emme Logbook at the current nesting level.</p>
<p>Wrapper for inro.modeller.logbook_write.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>name</code></td>
        <td><code>str</code></td>
        <td><p>The title of the logbook entry</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>attributes</code></td>
        <td><code>Dict[str, Any]</code></td>
        <td><p>Optional. A Python dictionary of key-value pairs to be
        displayed in the logbook entry detailed view.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>value</code></td>
        <td><code>str</code></td>
        <td><p>Optional. An HTML string value to be displayed in main detail
   pane of the logbook entry</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/manager.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">logbook_write</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write an entry to the Emme Logbook at the current nesting level.</span>

<span class="sd">    Wrapper for inro.modeller.logbook_write.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The title of the logbook entry</span>
<span class="sd">        attributes: Optional. A Python dictionary of key-value pairs to be</span>
<span class="sd">                    displayed in the logbook entry detailed view.</span>
<span class="sd">        value: Optional. An HTML string value to be displayed in main detail</span>
<span class="sd">               pane of the logbook entry</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=E0611, E0401, E1101</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span> <span class="k">if</span> <span class="n">attributes</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">logbook_write</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attributes</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.manager.EmmeManager.modeller" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">modeller</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emme_project</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#tm2py.emme.manager.EmmeManager.modeller" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Initialize and return Modeller object.</p>
<p>If Modeller has not already been initialized it will do so on
specified Emme project, or the first Emme project opened if not provided.
If already initialized Modeller will reference whichever project was used
first.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>emme_project</code></td>
        <td><code>&lt;MagicMock name=&#39;mock.emme.desktop.app.App&#39; id=&#39;140348569438768&#39;&gt;</code></td>
        <td><p>open &lsquo;Emme Desktop&rsquo; application (inro.emme.desktop.app)</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>&lt;MagicMock name=&#39;mock.Modeller&#39; id=&#39;140348569394576&#39;&gt;</code></td>
      <td><p>Emme Modeller object, see Emme API Reference, Modeller section for details.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/manager.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">modeller</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emme_project</span><span class="p">:</span> <span class="n">EmmeDesktopApp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeModeller</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Initialize and return Modeller object.</span>

<span class="sd">    If Modeller has not already been initialized it will do so on</span>
<span class="sd">    specified Emme project, or the first Emme project opened if not provided.</span>
<span class="sd">    If already initialized Modeller will reference whichever project was used</span>
<span class="sd">    first.</span>

<span class="sd">    Args:</span>
<span class="sd">        emme_project: open &#39;Emme Desktop&#39; application (inro.emme.desktop.app)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Emme Modeller object, see Emme API Reference, Modeller section for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=E0611, E0401, E1101</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">EmmeModeller</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">emme_project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_cache</span><span class="p">:</span>
                <span class="n">emme_project</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project_cache</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;modeller not yet initialized and no cached Emme project,&quot;</span>
                    <span class="s2">&quot; emme_project arg must be provided&quot;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>
        <span class="k">return</span> <span class="n">EmmeModeller</span><span class="p">(</span><span class="n">emme_project</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.manager.EmmeManager.project" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_path</span><span class="p">)</span></code>


<a href="#tm2py.emme.manager.EmmeManager.project" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Return already open Emme project, or open new Desktop session if not found.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>project_path</code></td>
        <td><code>str</code></td>
        <td><p>valid path to Emme project *.emp file</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>&lt;MagicMock name=&#39;mock.emme.desktop.app.App&#39; id=&#39;140348569438768&#39;&gt;</code></td>
      <td><p>Emme Desktop App object, see Emme API Reference, Desktop section for details.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/manager.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeDesktopApp</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return already open Emme project, or open new Desktop session if not found.</span>

<span class="sd">    Args:</span>
<span class="sd">        project_path: valid path to Emme project *.emp file</span>

<span class="sd">    Returns:</span>
<span class="sd">        Emme Desktop App object, see Emme API Reference, Desktop section for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">project_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">project_path</span><span class="p">))</span>
    <span class="n">emme_project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">emme_project</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># Check if the Emme window was closed</span>
            <span class="n">emme_project</span><span class="o">.</span><span class="n">current_window</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">_socket_error</span><span class="p">:</span>
            <span class="n">emme_project</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># if window is not opened in this process, start a new one</span>
    <span class="k">if</span> <span class="n">emme_project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">project_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Emme project path does not exist </span><span class="si">{</span><span class="n">project_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">emme_project</span> <span class="o">=</span> <span class="n">_app</span><span class="o">.</span><span class="n">start_dedicated</span><span class="p">(</span>
            <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user_initials</span><span class="o">=</span><span class="s2">&quot;inro&quot;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">project_path</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project_cache</span><span class="p">[</span><span class="n">project_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">emme_project</span>
    <span class="k">return</span> <span class="n">emme_project</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.manager.EmmeManager.temp_attributes_and_restore" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">temp_attributes_and_restore</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#tm2py.emme.manager.EmmeManager.temp_attributes_and_restore" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Create temp extra attribute and network field, and backup values and state and restore.</p>
<p>Allows the use of temporary attributes which may conflict with existing attributes.
The temp created attributes are deleted at the end, and if there were pre-existing
attributes with the same names the values are restored.</p>
<p>Note that name conflicts may still arise in the shorthand inheritance systems
for the network hierarchy tree (@node attribute reserves -&gt; @nodei, @nodej, etc,
see Emme help Network calculations for full list) which will raise an error in the
Emme API.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>scenario</code></td>
        <td><code>&lt;MagicMock name=&#39;mock.Scenario&#39; id=&#39;140348569830544&#39;&gt;</code></td>
        <td><p>Emme scenario object</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>attributes</code></td>
        <td><code>List[List[str]]</code></td>
        <td><p>list of attribute details, where details is a list of 3 items
for extra attributes and 4 for network fields: domain, name, description[, atype]</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/manager.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="nd">@_context</span>
<span class="k">def</span> <span class="nf">temp_attributes_and_restore</span><span class="p">(</span>
    <span class="n">scenario</span><span class="p">:</span> <span class="n">EmmeScenario</span><span class="p">,</span> <span class="n">attributes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create temp extra attribute and network field, and backup values and state and restore.</span>

<span class="sd">    Allows the use of temporary attributes which may conflict with existing attributes.</span>
<span class="sd">    The temp created attributes are deleted at the end, and if there were pre-existing</span>
<span class="sd">    attributes with the same names the values are restored.</span>

<span class="sd">    Note that name conflicts may still arise in the shorthand inheritance systems</span>
<span class="sd">    for the network hierarchy tree (@node attribute reserves -&gt; @nodei, @nodej, etc,</span>
<span class="sd">    see Emme help Network calculations for full list) which will raise an error in the</span>
<span class="sd">    Emme API.</span>

<span class="sd">    Args:</span>
<span class="sd">        scenario: Emme scenario object</span>
<span class="sd">        attributes: list of attribute details, where details is a list of 3 items</span>
<span class="sd">            for extra attributes and 4 for network fields: domain, name, description[, atype]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attrs_to_delete</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fields_to_delete</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">attrs_to_restore</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;NODE&quot;</span><span class="p">,</span> <span class="s2">&quot;LINK&quot;</span><span class="p">,</span> <span class="s2">&quot;TURN&quot;</span><span class="p">,</span> <span class="s2">&quot;TRANSIT_LINE&quot;</span><span class="p">,</span> <span class="s2">&quot;TRANSIT_SEGMENT&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
        <span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">details</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">extra_attribute</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">network_field</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">or</span> <span class="n">field</span><span class="p">:</span>
            <span class="n">attrs_to_restore</span><span class="p">[</span><span class="n">domain</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">create_extra_attribute</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">desc</span>
            <span class="n">attrs_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atype</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">create_nertwork_field</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">atype</span><span class="p">)</span>
            <span class="n">field</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">desc</span>
            <span class="n">fields_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="n">backup</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">domain</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">attrs_to_restore</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">backup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_attribute_values</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">names</span><span class="p">))</span>
            <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">attrs_to_delete</span><span class="p">:</span>
            <span class="n">scenario</span><span class="o">.</span><span class="n">delete_extra_attribute</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">domain</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fields_to_delete</span><span class="p">:</span>
            <span class="n">scenario</span><span class="o">.</span><span class="n">delete_network_field</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">domain</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">backup</span><span class="p">:</span>
            <span class="n">scenario</span><span class="o">.</span><span class="n">set_attribute_values</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.manager.EmmeManager.tool" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span></code>


<a href="#tm2py.emme.manager.EmmeManager.tool" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Return the Modeller tool at namespace.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>Corresponding Tool object, see Emme Help for full details.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/manager.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the Modeller tool at namespace.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Corresponding Tool object, see Emme Help for full details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modeller</span><span class="p">()</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="tm2py.emme.matrix" class="doc doc-heading">
        <code>matrix</code>



<a href="#tm2py.emme.matrix" class="headerlink" title="Permanent link"> ¶</a></h4>

    <div class="doc doc-contents ">

      <p>Module for Emme-related matrix management.</p>
<p>Contains the MatrixCache class for write through matrix data management of Emme
matrices (in Emmebank) to avoid repeated read-from-disk of skim matrices
during post-assignment processing and export to OMX.</p>
<p>Contains the OMXManager which is a thin wrapper on the openmatrix (OMX)
library for transfer between Emme (emmebank) &lt;-&gt; OMX files. Integrates with
the MatrixCache to support easy write from Emmebank without re-reading data
from disk.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="tm2py.emme.matrix.MatrixCache" class="doc doc-heading">
        <code>
MatrixCache        </code>



<a href="#tm2py.emme.matrix.MatrixCache" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Write through cache of Emme matrix data via Numpy arrays</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>scenario</code></td>
        <td><code>&lt;MagicMock name=&#39;mock.Scenario&#39; id=&#39;140348569830544&#39;&gt;</code></td>
        <td><p>reference scenario for the active Emmebank and matrix zone system</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/matrix.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MatrixCache</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Write through cache of Emme matrix data via Numpy arrays</span>

<span class="sd">    Args:</span>
<span class="sd">        scenario: reference scenario for the active Emmebank and matrix zone system</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">EmmeScenario</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span> <span class="o">=</span> <span class="n">scenario</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">emmebank</span>
        <span class="c1"># mapping from matrix object to last read/write timestamp for cache invalidation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># cache of Emme matrix data, key: matrix object, value: numpy array of data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EmmeMatrix</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NumpyArray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get Emme matrix data as numpy array.</span>

<span class="sd">        Args:</span>
<span class="sd">            matrix: Emme matrix object or unique name / ID for Emme matrix in Emmebank</span>

<span class="sd">        Returns:</span>
<span class="sd">            The Numpy array of values for this matrix / matrix ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">timestamp</span>
        <span class="n">prev_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prev_timestamp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">!=</span> <span class="n">prev_timestamp</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">[</span><span class="n">matrix</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">timestamp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">matrix</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">get_numpy_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">matrix</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EmmeMatrix</span><span class="p">],</span> <span class="n">data</span><span class="p">:</span> <span class="n">NumpyArray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set numpy array to Emme matrix (write through cache).</span>

<span class="sd">        Args:</span>
<span class="sd">            matrix: Emme matrix object or unique name / ID for Emme matrix in Emmebank</span>
<span class="sd">            data: Numpy array, must match the scenario zone system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">matrix</span><span class="o">.</span><span class="n">set_numpy_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">[</span><span class="n">matrix</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">matrix</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear the cache.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.matrix.MatrixCache.clear" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.emme.matrix.MatrixCache.clear" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Clear the cache.</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/emme/matrix.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clear the cache.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.matrix.MatrixCache.get_data" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span></code>


<a href="#tm2py.emme.matrix.MatrixCache.get_data" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Get Emme matrix data as numpy array.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>matrix</code></td>
        <td><code>Union[str, &lt;MagicMock name=&#39;mock.Matrix&#39; id=&#39;140348569846640&#39;&gt;]</code></td>
        <td><p>Emme matrix object or unique name / ID for Emme matrix in Emmebank</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>&lt;built-in function array&gt;</code></td>
      <td><p>The Numpy array of values for this matrix / matrix ID.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/matrix.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EmmeMatrix</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NumpyArray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get Emme matrix data as numpy array.</span>

<span class="sd">    Args:</span>
<span class="sd">        matrix: Emme matrix object or unique name / ID for Emme matrix in Emmebank</span>

<span class="sd">    Returns:</span>
<span class="sd">        The Numpy array of values for this matrix / matrix ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">timestamp</span>
    <span class="n">prev_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prev_timestamp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">!=</span> <span class="n">prev_timestamp</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">[</span><span class="n">matrix</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">matrix</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">get_numpy_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">matrix</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.matrix.MatrixCache.set_data" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>


<a href="#tm2py.emme.matrix.MatrixCache.set_data" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Set numpy array to Emme matrix (write through cache).</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>matrix</code></td>
        <td><code>Union[str, &lt;MagicMock name=&#39;mock.Matrix&#39; id=&#39;140348569846640&#39;&gt;]</code></td>
        <td><p>Emme matrix object or unique name / ID for Emme matrix in Emmebank</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>data</code></td>
        <td><code>&lt;built-in function array&gt;</code></td>
        <td><p>Numpy array, must match the scenario zone system</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/matrix.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EmmeMatrix</span><span class="p">],</span> <span class="n">data</span><span class="p">:</span> <span class="n">NumpyArray</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set numpy array to Emme matrix (write through cache).</span>

<span class="sd">    Args:</span>
<span class="sd">        matrix: Emme matrix object or unique name / ID for Emme matrix in Emmebank</span>
<span class="sd">        data: Numpy array, must match the scenario zone system</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emmebank</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="n">matrix</span><span class="o">.</span><span class="n">set_numpy_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">[</span><span class="n">matrix</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">timestamp</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">matrix</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="tm2py.emme.matrix.OMXManager" class="doc doc-heading">
        <code>
OMXManager        </code>



<a href="#tm2py.emme.matrix.OMXManager" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Wrapper for the OMX interface to write from Emme matrices and numpy arrays.</p>
<p>Write from Emmebank or Matrix Cache to OMX file, or read from OMX to Numpy.
Also supports with statement.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>file_path</code></td>
        <td><code>str</code></td>
        <td><p>path of OMX file</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>mode</code></td>
        <td><code>str</code></td>
        <td><p>&ldquo;r&rdquo;, &ldquo;w&rdquo; or &ldquo;a&rdquo;</p></td>
        <td><code>&#39;r&#39;</code></td>
      </tr>
      <tr>
        <td><code>scenario</code></td>
        <td><code>&lt;MagicMock name=&#39;mock.Scenario&#39; id=&#39;140348569830544&#39;&gt;</code></td>
        <td><p>Emme scenario object for zone system and reference
Emmebank</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>omx_key</code></td>
        <td><code>str</code></td>
        <td><p>&ldquo;ID_NAME&rdquo;, &ldquo;NAME&rdquo;, &ldquo;ID&rdquo;, format for generating
OMX key from Emme matrix data</p></td>
        <td><code>&#39;NAME&#39;</code></td>
      </tr>
      <tr>
        <td><code>matrix_cache</code></td>
        <td><code>MatrixCache</code></td>
        <td><p>optional, Matrix Cache to support write data
from cache (instead of always reading from Emmmebank)</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>mask_max_value</code></td>
        <td><code>float</code></td>
        <td><p>optional, max value above which to write
zero instead (&ldquo;big to zero&rdquo; behavior)</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/matrix.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">OMXManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Wrapper for the OMX interface to write from Emme matrices and numpy arrays.</span>

<span class="sd">    Write from Emmebank or Matrix Cache to OMX file, or read from OMX to Numpy.</span>
<span class="sd">    Also supports with statement.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path: path of OMX file</span>
<span class="sd">        mode: &quot;r&quot;, &quot;w&quot; or &quot;a&quot;</span>
<span class="sd">        scenario: Emme scenario object for zone system and reference</span>
<span class="sd">            Emmebank</span>
<span class="sd">        omx_key: &quot;ID_NAME&quot;, &quot;NAME&quot;, &quot;ID&quot;, format for generating</span>
<span class="sd">            OMX key from Emme matrix data</span>
<span class="sd">        matrix_cache: optional, Matrix Cache to support write data</span>
<span class="sd">            from cache (instead of always reading from Emmmebank)</span>
<span class="sd">        mask_max_value: optional, max value above which to write</span>
<span class="sd">            zero instead (&quot;big to zero&quot; behavior)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span>
        <span class="n">scenario</span><span class="p">:</span> <span class="n">EmmeScenario</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">omx_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NAME&quot;</span><span class="p">,</span>
        <span class="n">matrix_cache</span><span class="p">:</span> <span class="n">MatrixCache</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mask_max_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># pylint: disable=R0913</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span> <span class="o">=</span> <span class="n">file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span> <span class="o">=</span> <span class="n">scenario</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_omx_key</span> <span class="o">=</span> <span class="n">omx_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_max_value</span> <span class="o">=</span> <span class="n">mask_max_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emme_matrix_cache</span> <span class="o">=</span> <span class="n">matrix_cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_generate_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">EmmeMatrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omx_key</span> <span class="o">==</span> <span class="s2">&quot;ID_NAME&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">matrix</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">matrix</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omx_key</span> <span class="o">==</span> <span class="s2">&quot;NAME&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">matrix</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omx_key</span> <span class="o">==</span> <span class="s2">&quot;ID&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">matrix</span><span class="o">.</span><span class="n">id</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid omx_key: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_omx_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the OMX file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span> <span class="o">=</span> <span class="n">_omx</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the OMX file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span><span class="o">.</span><span class="n">create_mapping</span><span class="p">(</span>
                    <span class="s2">&quot;zone_number&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="o">.</span><span class="n">zone_numbers</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">EmmeMatrix</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]):</span>
        <span class="sd">&quot;&quot;&quot;Write the list of emme matrices to OMX file.</span>

<span class="sd">        Args:</span>
<span class="sd">            matrices: list of Emme matrix objects or names / IDs</span>
<span class="sd">                of matrices in Emmebank, or dictionary of</span>
<span class="sd">                name: Emme matrix object/ Emme matrix ID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matrices</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">matrices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">matrices</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EmmeMatrix</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write Emme matrix (as name or ID or Emme matrix object).</span>

<span class="sd">        Args:</span>
<span class="sd">            matrix: Emme matrix object or name / ID of matrix in Emmebank</span>
<span class="sd">            name: optional name to use for OMX key, if not specified the</span>
<span class="sd">                omx_key format will be used to generate a name from the</span>
<span class="sd">                Emme matrix data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="si">}</span><span class="s2">: open in read-only mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="o">.</span><span class="n">emmebank</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_name</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emme_matrix_cache</span><span class="p">:</span>
            <span class="n">numpy_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emme_matrix_cache</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">get_numpy_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">matrix</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;DESTINATION&quot;</span><span class="p">:</span>
            <span class="n">n_zones</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">)</span>
            <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_zones</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">matrix</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;ORIGIN&quot;</span><span class="p">:</span>
            <span class="n">n_zones</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">)</span>
            <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">,</span> <span class="p">(</span><span class="n">n_zones</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">matrix</span><span class="o">.</span><span class="n">description</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_clipped_array</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">numpy_array</span><span class="p">:</span> <span class="n">NumpyArray</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">a_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">a_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># pylint: disable=R0913</span>
        <span class="sd">&quot;&quot;&quot;Write array with min and max values capped.</span>

<span class="sd">        Args:</span>
<span class="sd">            numpy_array: Numpy array</span>
<span class="sd">            name: name to use for the OMX key</span>
<span class="sd">            a_min: minimum value to clip array data</span>
<span class="sd">            a_max: optional maximum value to clip array data</span>
<span class="sd">            attrs: additional attribute key value pairs to write to OMX file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">a_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">numpy_array</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">a_min</span><span class="p">,</span> <span class="n">a_max</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">numpy_array</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">a_min</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_array</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">numpy_array</span><span class="p">:</span> <span class="n">NumpyArray</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write array with name and optional attrs to OMX file.</span>

<span class="sd">        Args:</span>
<span class="sd">            numpy_array:: Numpy array</span>
<span class="sd">            name: name to use for the OMX key</span>
<span class="sd">            attrs: additional attribute key value pairs to write to OMX file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="si">}</span><span class="s2">: open in read-only mode&quot;</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">numpy_array</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">chunkshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chunkshape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_max_value</span><span class="p">:</span>
            <span class="n">numpy_array</span><span class="p">[</span><span class="n">numpy_array</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_max_value</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">numpy_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span><span class="o">.</span><span class="n">create_matrix</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">numpy_array</span><span class="p">,</span> <span class="n">chunkshape</span><span class="o">=</span><span class="n">chunkshape</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NumpyArray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read OMX data as numpy array (standard interface).</span>

<span class="sd">        Caches matrix data (arrays) already read from disk.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: name of OMX matrix</span>

<span class="sd">        Returns:</span>
<span class="sd">            Numpy array from OMX file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">read_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NumpyArray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read data directly from PyTables interface.</span>

<span class="sd">        Support for hdf5 formats that don&#39;t have full OMX compatibility.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: hdf5 reference path to matrix data</span>

<span class="sd">        Returns:</span>
<span class="sd">            Numpy array from OMX file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">












  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.matrix.OMXManager.close" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.emme.matrix.OMXManager.close" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Close the OMX file.</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/emme/matrix.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Close the OMX file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_read_cache</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.matrix.OMXManager.open" class="doc doc-heading">
<code class="codehilite language-python"><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.emme.matrix.OMXManager.open" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Open the OMX file.</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/emme/matrix.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Open the OMX file.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span> <span class="o">=</span> <span class="n">_omx</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.matrix.OMXManager.read" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></code>


<a href="#tm2py.emme.matrix.OMXManager.read" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Read OMX data as numpy array (standard interface).</p>
<p>Caches matrix data (arrays) already read from disk.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>name</code></td>
        <td><code>str</code></td>
        <td><p>name of OMX matrix</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>&lt;built-in function array&gt;</code></td>
      <td><p>Numpy array from OMX file</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/matrix.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NumpyArray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Read OMX data as numpy array (standard interface).</span>

<span class="sd">    Caches matrix data (arrays) already read from disk.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: name of OMX matrix</span>

<span class="sd">    Returns:</span>
<span class="sd">        Numpy array from OMX file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_cache</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_read_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">return</span> <span class="n">data</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.matrix.OMXManager.read_hdf5" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">read_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></code>


<a href="#tm2py.emme.matrix.OMXManager.read_hdf5" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Read data directly from PyTables interface.</p>
<p>Support for hdf5 formats that don&rsquo;t have full OMX compatibility.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>path</code></td>
        <td><code>str</code></td>
        <td><p>hdf5 reference path to matrix data</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>&lt;built-in function array&gt;</code></td>
      <td><p>Numpy array from OMX file</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/matrix.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">read_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NumpyArray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Read data directly from PyTables interface.</span>

<span class="sd">    Support for hdf5 formats that don&#39;t have full OMX compatibility.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: hdf5 reference path to matrix data</span>

<span class="sd">    Returns:</span>
<span class="sd">        Numpy array from OMX file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.matrix.OMXManager.write_array" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">write_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numpy_array</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#tm2py.emme.matrix.OMXManager.write_array" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Write array with name and optional attrs to OMX file.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>numpy_array</code></td>
        <td><code>&lt;built-in function array&gt;</code></td>
        <td><p>: Numpy array</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>name</code></td>
        <td><code>str</code></td>
        <td><p>name to use for the OMX key</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>attrs</code></td>
        <td><code>Dict[str, str]</code></td>
        <td><p>additional attribute key value pairs to write to OMX file</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/matrix.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">write_array</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">numpy_array</span><span class="p">:</span> <span class="n">NumpyArray</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write array with name and optional attrs to OMX file.</span>

<span class="sd">    Args:</span>
<span class="sd">        numpy_array:: Numpy array</span>
<span class="sd">        name: name to use for the OMX key</span>
<span class="sd">        attrs: additional attribute key value pairs to write to OMX file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="si">}</span><span class="s2">: open in read-only mode&quot;</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">numpy_array</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">chunkshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chunkshape</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_max_value</span><span class="p">:</span>
        <span class="n">numpy_array</span><span class="p">[</span><span class="n">numpy_array</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_max_value</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">numpy_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_omx_file</span><span class="o">.</span><span class="n">create_matrix</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">numpy_array</span><span class="p">,</span> <span class="n">chunkshape</span><span class="o">=</span><span class="n">chunkshape</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.matrix.OMXManager.write_clipped_array" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">write_clipped_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numpy_array</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">a_min</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#tm2py.emme.matrix.OMXManager.write_clipped_array" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Write array with min and max values capped.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>numpy_array</code></td>
        <td><code>&lt;built-in function array&gt;</code></td>
        <td><p>Numpy array</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>name</code></td>
        <td><code>str</code></td>
        <td><p>name to use for the OMX key</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>a_min</code></td>
        <td><code>float</code></td>
        <td><p>minimum value to clip array data</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>a_max</code></td>
        <td><code>float</code></td>
        <td><p>optional maximum value to clip array data</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>attrs</code></td>
        <td><code>Dict[str, str]</code></td>
        <td><p>additional attribute key value pairs to write to OMX file</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/matrix.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">write_clipped_array</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">numpy_array</span><span class="p">:</span> <span class="n">NumpyArray</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">a_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">a_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># pylint: disable=R0913</span>
    <span class="sd">&quot;&quot;&quot;Write array with min and max values capped.</span>

<span class="sd">    Args:</span>
<span class="sd">        numpy_array: Numpy array</span>
<span class="sd">        name: name to use for the OMX key</span>
<span class="sd">        a_min: minimum value to clip array data</span>
<span class="sd">        a_max: optional maximum value to clip array data</span>
<span class="sd">        attrs: additional attribute key value pairs to write to OMX file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">a_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">numpy_array</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">a_min</span><span class="p">,</span> <span class="n">a_max</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">numpy_array</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">a_min</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.matrix.OMXManager.write_matrices" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">write_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrices</span><span class="p">)</span></code>


<a href="#tm2py.emme.matrix.OMXManager.write_matrices" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Write the list of emme matrices to OMX file.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>matrices</code></td>
        <td><code>List[Union[&lt;MagicMock name=&#39;mock.Matrix&#39; id=&#39;140348569846640&#39;&gt;, str]]</code></td>
        <td><p>list of Emme matrix objects or names / IDs
of matrices in Emmebank, or dictionary of
name: Emme matrix object/ Emme matrix ID</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/matrix.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">write_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">EmmeMatrix</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]):</span>
    <span class="sd">&quot;&quot;&quot;Write the list of emme matrices to OMX file.</span>

<span class="sd">    Args:</span>
<span class="sd">        matrices: list of Emme matrix objects or names / IDs</span>
<span class="sd">            of matrices in Emmebank, or dictionary of</span>
<span class="sd">            name: Emme matrix object/ Emme matrix ID</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matrices</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">matrices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">matrices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.matrix.OMXManager.write_matrix" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">write_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#tm2py.emme.matrix.OMXManager.write_matrix" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Write Emme matrix (as name or ID or Emme matrix object).</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>matrix</code></td>
        <td><code>[&lt;class &#39;str&#39;&gt;, &lt;MagicMock name=&#39;mock.Matrix&#39; id=&#39;140348569846640&#39;&gt;]</code></td>
        <td><p>Emme matrix object or name / ID of matrix in Emmebank</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>name</code></td>
        <td></td>
        <td><p>optional name to use for OMX key, if not specified the
omx_key format will be used to generate a name from the
Emme matrix data</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/matrix.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">write_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EmmeMatrix</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write Emme matrix (as name or ID or Emme matrix object).</span>

<span class="sd">    Args:</span>
<span class="sd">        matrix: Emme matrix object or name / ID of matrix in Emmebank</span>
<span class="sd">        name: optional name to use for OMX key, if not specified the</span>
<span class="sd">            omx_key format will be used to generate a name from the</span>
<span class="sd">            Emme matrix data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="si">}</span><span class="s2">: open in read-only mode&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="o">.</span><span class="n">emmebank</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_name</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emme_matrix_cache</span><span class="p">:</span>
        <span class="n">numpy_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emme_matrix_cache</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">get_numpy_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">matrix</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;DESTINATION&quot;</span><span class="p">:</span>
        <span class="n">n_zones</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">)</span>
        <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_zones</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">matrix</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;ORIGIN&quot;</span><span class="p">:</span>
        <span class="n">n_zones</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">)</span>
        <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">,</span> <span class="p">(</span><span class="n">n_zones</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">matrix</span><span class="o">.</span><span class="n">description</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="tm2py.emme.network" class="doc doc-heading">
        <code>network</code>



<a href="#tm2py.emme.network" class="headerlink" title="Permanent link"> ¶</a></h4>

    <div class="doc doc-contents ">

      <p>Module for Emme network calculations.</p>
<p>Contains NetworkCalculator class to generate Emme format specifications for
the Network calculator.</p>



  <div class="doc doc-children">









  <div class="doc doc-object doc-class">



<h5 id="tm2py.emme.network.NetworkCalculator" class="doc doc-heading">
        <code>
NetworkCalculator        </code>



<a href="#tm2py.emme.network.NetworkCalculator" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Simple wrapper interface to the Emme Network calculator</p>
<p>Used to generate the standard network calculator specification (dictionary)
from argument inputs. Useful when NOT (commonly) using selection or
aggregation options, and mostly running link expression calculations</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>scenario</code></td>
        <td><code>&lt;MagicMock name=&#39;mock.Scenario&#39; id=&#39;140348569830544&#39;&gt;</code></td>
        <td><p>Emme scenario object</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/network.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">NetworkCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simple wrapper interface to the Emme Network calculator</span>

<span class="sd">    Used to generate the standard network calculator specification (dictionary)</span>
<span class="sd">    from argument inputs. Useful when NOT (commonly) using selection or</span>
<span class="sd">    aggregation options, and mostly running link expression calculations</span>

<span class="sd">    Args:</span>
<span class="sd">        scenario: Emme scenario object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">EmmeScenario</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span> <span class="o">=</span> <span class="n">scenario</span>
        <span class="n">emme_manager</span> <span class="o">=</span> <span class="n">_manager</span><span class="o">.</span><span class="n">EmmeManager</span><span class="p">()</span>
        <span class="n">modeller</span> <span class="o">=</span> <span class="n">emme_manager</span><span class="o">.</span><span class="n">modeller</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network_calc</span> <span class="o">=</span> <span class="n">modeller</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span>
            <span class="s2">&quot;inro.emme.network_calculation.network_calculator&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">selections</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">aggregation</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Run a network calculation in the scenario, see the Emme help for more.</span>

<span class="sd">        Args:</span>
<span class="sd">            result: Name of network attribute</span>
<span class="sd">            expression: Calculation expression</span>
<span class="sd">            selections: Selection expression nest. Defaults to {&quot;link&quot;: &quot;all&quot;} if</span>
<span class="sd">                        not specified, and is used as a link selection expression</span>
<span class="sd">                        if specified as a string.</span>
<span class="sd">            aggregation: Aggregation operators if aggregating between network domains.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary report with min, max, average and sum of the calculation</span>
<span class="sd">            expression. See Emme help &#39;Network calculator&#39; for more.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_spec</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">selections</span><span class="p">,</span> <span class="n">aggregation</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network_calc</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_calc</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">selections</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">aggregation</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add calculation to list of network calculations to run.</span>

<span class="sd">        Args:</span>
<span class="sd">            result: Name of network attribute</span>
<span class="sd">            expression: Calculation expression</span>
<span class="sd">            selections: Selection expression nest. Defaults to {&quot;link&quot;: &quot;all&quot;} if</span>
<span class="sd">                        not specified, and is used as a link selection expression</span>
<span class="sd">                        if specified as a string.</span>
<span class="sd">            aggregation: Aggregation operators if aggregating between network domains.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_format_spec</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">selections</span><span class="p">,</span> <span class="n">aggregation</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Run accumulated network calculations all at once.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of dictionary reports with min, max, average and sum of the</span>
<span class="sd">            calculation expression. See Emme help &#39;Network calculator&#39; for more.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network_calc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">reports</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_format_spec</span><span class="p">(</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">selections</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
        <span class="n">aggregation</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmmeNetworkCalcSpecification</span><span class="p">:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
            <span class="s2">&quot;expression&quot;</span><span class="p">:</span> <span class="n">expression</span><span class="p">,</span>
            <span class="s2">&quot;aggregation&quot;</span><span class="p">:</span> <span class="n">aggregation</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;NETWORK_CALCULATION&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">selections</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selections</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">selections</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="n">selections</span><span class="p">}</span>
            <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;selections&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selections</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;selections&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="s2">&quot;all&quot;</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">spec</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.network.NetworkCalculator.__call__" class="doc doc-heading">
<code class="codehilite language-python"><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">selections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#tm2py.emme.network.NetworkCalculator.__call__" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Run a network calculation in the scenario, see the Emme help for more.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>result</code></td>
        <td><code>str</code></td>
        <td><p>Name of network attribute</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>expression</code></td>
        <td><code>str</code></td>
        <td><p>Calculation expression</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>selections</code></td>
        <td><code>Union[str, Dict[str, str]]</code></td>
        <td><p>Selection expression nest. Defaults to {&ldquo;link&rdquo;: &ldquo;all&rdquo;} if
        not specified, and is used as a link selection expression
        if specified as a string.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>aggregation</code></td>
        <td><code>Dict[str, str]</code></td>
        <td><p>Aggregation operators if aggregating between network domains.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Dict[str, float]</code></td>
      <td><p>A dictionary report with min, max, average and sum of the calculation
expression. See Emme help &lsquo;Network calculator&rsquo; for more.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/network.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">result</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">selections</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">aggregation</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Run a network calculation in the scenario, see the Emme help for more.</span>

<span class="sd">    Args:</span>
<span class="sd">        result: Name of network attribute</span>
<span class="sd">        expression: Calculation expression</span>
<span class="sd">        selections: Selection expression nest. Defaults to {&quot;link&quot;: &quot;all&quot;} if</span>
<span class="sd">                    not specified, and is used as a link selection expression</span>
<span class="sd">                    if specified as a string.</span>
<span class="sd">        aggregation: Aggregation operators if aggregating between network domains.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary report with min, max, average and sum of the calculation</span>
<span class="sd">        expression. See Emme help &#39;Network calculator&#39; for more.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_spec</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">selections</span><span class="p">,</span> <span class="n">aggregation</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network_calc</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.network.NetworkCalculator.add_calc" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">add_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">selections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#tm2py.emme.network.NetworkCalculator.add_calc" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Add calculation to list of network calculations to run.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>result</code></td>
        <td><code>str</code></td>
        <td><p>Name of network attribute</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>expression</code></td>
        <td><code>str</code></td>
        <td><p>Calculation expression</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>selections</code></td>
        <td><code>Union[str, Dict[str, str]]</code></td>
        <td><p>Selection expression nest. Defaults to {&ldquo;link&rdquo;: &ldquo;all&rdquo;} if
        not specified, and is used as a link selection expression
        if specified as a string.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>aggregation</code></td>
        <td><code>Dict[str, str]</code></td>
        <td><p>Aggregation operators if aggregating between network domains.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/network.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">add_calc</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">result</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">selections</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">aggregation</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add calculation to list of network calculations to run.</span>

<span class="sd">    Args:</span>
<span class="sd">        result: Name of network attribute</span>
<span class="sd">        expression: Calculation expression</span>
<span class="sd">        selections: Selection expression nest. Defaults to {&quot;link&quot;: &quot;all&quot;} if</span>
<span class="sd">                    not specified, and is used as a link selection expression</span>
<span class="sd">                    if specified as a string.</span>
<span class="sd">        aggregation: Aggregation operators if aggregating between network domains.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_format_spec</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">selections</span><span class="p">,</span> <span class="n">aggregation</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="tm2py.emme.network.NetworkCalculator.run" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#tm2py.emme.network.NetworkCalculator.run" class="headerlink" title="Permanent link"> ¶</a></h6>

    <div class="doc doc-contents ">

      <p>Run accumulated network calculations all at once.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[Dict[str, float]]</code></td>
      <td><p>A list of dictionary reports with min, max, average and sum of the
calculation expression. See Emme help &lsquo;Network calculator&rsquo; for more.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/emme/network.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Run accumulated network calculations all at once.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of dictionary reports with min, max, average and sum of the</span>
<span class="sd">        calculation expression. See Emme help &#39;Network calculator&#39; for more.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network_calc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_specs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenario</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_specs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">reports</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>

<h2 id="errata">Errata<a class="headerlink" href="#errata" title="Permanent link"> ¶</a></h2>


  <div class="doc doc-object doc-module">



<h3 id="tm2py.logger" class="doc doc-heading">
        <code>tm2py.logger</code>



<a href="#tm2py.logger" class="headerlink" title="Permanent link"> ¶</a></h3>

    <div class="doc doc-contents first">

      <p>Logging module</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="tm2py.logger.LogStartEnd" class="doc doc-heading">
        <code>
LogStartEnd        </code>



<a href="#tm2py.logger.LogStartEnd" class="headerlink" title="Permanent link"> ¶</a></h4>

    <div class="doc doc-contents ">

      <p>Log the start and end time with optional message.</p>
<p>Used as a Component method decorator. If msg is not provided a default message
is generated with the object class and method name.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>msg</code></td>
        <td><code>str</code></td>
        <td><p>message text to use in the start and end record</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>level</code></td>
        <td><code>str</code></td>
        <td><p>logging level</p></td>
        <td><code>&#39;INFO&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/logger.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">LogStartEnd</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Log the start and end time with optional message.</span>

<span class="sd">    Used as a Component method decorator. If msg is not provided a default message</span>
<span class="sd">    is generated with the object class and method name.</span>

<span class="sd">    Args:</span>
<span class="sd">        msg (str): message text to use in the start and end record</span>
<span class="sd">        level (str): logging level</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="tm2py.logger.Logger" class="doc doc-heading">
        <code>
Logger        </code>



<a href="#tm2py.logger.Logger" class="headerlink" title="Permanent link"> ¶</a></h4>

    <div class="doc doc-contents ">

      <p>Logger</p>

        <details class="quote">
          <summary>Source code in <code>tm2py/logger.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Logger</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Logger&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="o">=</span> <span class="n">controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Placeholder logging method</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str): text to log</span>
<span class="sd">            level (str): logging level of the message text</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">level</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log message with timestamp</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (str): message text</span>
<span class="sd">            level (str): logging level</span>
<span class="sd">            indent (bool): if true indent any messages based on the number of open contexts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%b-%Y (%H:%M:%S)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">indent</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">indent</span><span class="si">}{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log message with timestamp and &#39;Start&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (str): message text</span>
<span class="sd">            level (str): logging level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">log_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log message with timestamp and &#39;End&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (str): message text</span>
<span class="sd">            level (str): logging level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;End </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@_context</span>
    <span class="k">def</span> <span class="nf">log_start_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use with &#39;with&#39; statement to log the start and end time with message.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (str): message text</span>
<span class="sd">            level (str): logging level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="k">yield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h5 id="tm2py.logger.Logger.log" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">log</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#tm2py.logger.Logger.log" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Placeholder logging method</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>text</code></td>
        <td><code>str</code></td>
        <td><p>text to log</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>level</code></td>
        <td><code>str</code></td>
        <td><p>logging level of the message text</p></td>
        <td><code>&#39;INFO&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/logger.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Placeholder logging method</span>

<span class="sd">    Args:</span>
<span class="sd">        text (str): text to log</span>
<span class="sd">        level (str): logging level of the message text</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">level</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tm2py.logger.Logger.log_end" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">log_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span></code>


<a href="#tm2py.logger.Logger.log_end" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Log message with timestamp and &lsquo;End&rsquo;.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>msg</code></td>
        <td><code>str</code></td>
        <td><p>message text</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>level</code></td>
        <td><code>str</code></td>
        <td><p>logging level</p></td>
        <td><code>&#39;INFO&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/logger.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">log_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Log message with timestamp and &#39;End&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        msg (str): message text</span>
<span class="sd">        level (str): logging level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;End </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tm2py.logger.Logger.log_start" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">log_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span></code>


<a href="#tm2py.logger.Logger.log_start" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Log message with timestamp and &lsquo;Start&rsquo;.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>msg</code></td>
        <td><code>str</code></td>
        <td><p>message text</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>level</code></td>
        <td><code>str</code></td>
        <td><p>logging level</p></td>
        <td><code>&#39;INFO&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/logger.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">log_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Log message with timestamp and &#39;Start&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        msg (str): message text</span>
<span class="sd">        level (str): logging level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tm2py.logger.Logger.log_start_end" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">log_start_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span></code>


<a href="#tm2py.logger.Logger.log_start_end" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Use with &lsquo;with&rsquo; statement to log the start and end time with message.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>msg</code></td>
        <td><code>str</code></td>
        <td><p>message text</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>level</code></td>
        <td><code>str</code></td>
        <td><p>logging level</p></td>
        <td><code>&#39;INFO&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/logger.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@_context</span>
<span class="k">def</span> <span class="nf">log_start_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use with &#39;with&#39; statement to log the start and end time with message.</span>

<span class="sd">    Args:</span>
<span class="sd">        msg (str): message text</span>
<span class="sd">        level (str): logging level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_start</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_end</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="tm2py.logger.Logger.log_time" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">log_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


<a href="#tm2py.logger.Logger.log_time" class="headerlink" title="Permanent link"> ¶</a></h5>

    <div class="doc doc-contents ">

      <p>Log message with timestamp</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>msg</code></td>
        <td><code>str</code></td>
        <td><p>message text</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>level</code></td>
        <td><code>str</code></td>
        <td><p>logging level</p></td>
        <td><code>&#39;INFO&#39;</code></td>
      </tr>
      <tr>
        <td><code>indent</code></td>
        <td><code>bool</code></td>
        <td><p>if true indent any messages based on the number of open contexts</p></td>
        <td><code>True</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/logger.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">log_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Log message with timestamp</span>

<span class="sd">    Args:</span>
<span class="sd">        msg (str): message text</span>
<span class="sd">        level (str): logging level</span>
<span class="sd">        indent (bool): if true indent any messages based on the number of open contexts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%b-%Y (%H:%M:%S)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">indent</span><span class="p">:</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">indent</span><span class="si">}{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tm2py.tools" class="doc doc-heading">
        <code>tm2py.tools</code>



<a href="#tm2py.tools" class="headerlink" title="Permanent link"> ¶</a></h3>

    <div class="doc doc-contents first">

      <p>Tools module for common resources / shared code and &ldquo;utilities&rdquo; in the tm2py package.</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h4 id="tm2py.tools.download_unzip" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">download_unzip</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">out_base_dir</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">,</span> <span class="n">zip_filename</span><span class="o">=</span><span class="s1">&#39;test_data.zip&#39;</span><span class="p">)</span></code>


<a href="#tm2py.tools.download_unzip" class="headerlink" title="Permanent link"> ¶</a></h4>

    <div class="doc doc-contents ">

      <p>Downloads and unzips a file from a URL. The zip file is removed after extraction.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>url</code></td>
        <td><code>str</code></td>
        <td><p>Full URL do download from.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>out_base_dir</code></td>
        <td><code>str</code></td>
        <td><p>Where to unzip the file.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>target_dir</code></td>
        <td><code>str</code></td>
        <td><p>What to unzip the file as.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>zip_filename</code></td>
        <td><code>str</code></td>
        <td><p>Filename to store zip file as. Defaults to &ldquo;test_data.zip&rdquo;.</p></td>
        <td><code>&#39;test_data.zip&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/tools.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">download_unzip</span><span class="p">(</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">out_base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">zip_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;test_data.zip&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Downloads and unzips a file from a URL. The zip file is removed after extraction.</span>

<span class="sd">    Args:</span>
<span class="sd">        url (str): Full URL do download from.</span>
<span class="sd">        out_base_dir (str): Where to unzip the file.</span>
<span class="sd">        target_dir (str): What to unzip the file as.</span>
<span class="sd">        zip_filename (str, optional): Filename to store zip file as. Defaults to &quot;test_data.zip&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target_zip</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_base_dir</span><span class="p">,</span> <span class="n">zip_filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">out_base_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_base_dir</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">_download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">target_zip</span><span class="p">)</span>
    <span class="n">_unzip</span><span class="p">(</span><span class="n">target_zip</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target_zip</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h4 id="tm2py.tools.parse_num_processors" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">parse_num_processors</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>


<a href="#tm2py.tools.parse_num_processors" class="headerlink" title="Permanent link"> ¶</a></h4>

    <div class="doc doc-contents ">

      <p>Convert input value (parse if string) to number of processors.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>value</code></td>
        <td><code>Union[str, int, float]</code></td>
        <td><p>an int, float or string; string value can be &ldquo;X&rdquo; or &ldquo;MAX-X&rdquo;</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>An int of the number of processors to use</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>Exception</code></td>
        <td><p>Input value exceeds number of available processors</p></td>
      </tr>
      <tr>
        <td><code>Exception</code></td>
        <td><p>Input value less than 1 processors</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/tools.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">parse_num_processors</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Convert input value (parse if string) to number of processors.</span>
<span class="sd">    Args:</span>
<span class="sd">        value: an int, float or string; string value can be &quot;X&quot; or &quot;MAX-X&quot;</span>
<span class="sd">    Returns:</span>
<span class="sd">        An int of the number of processors to use</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: Input value exceeds number of available processors</span>
<span class="sd">        Exception: Input value less than 1 processors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_processors</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;MAX&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">max_processors</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[0-9]+$&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^MAX[\s]*-[\s]*&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_processors</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input value </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> is an int or string as &#39;MAX-X&#39;&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="n">max_processors</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input value </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> greater than available processors&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input value </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> less than 1 processors&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="tm2py.examples" class="doc doc-heading">
        <code>tm2py.examples</code>



<a href="#tm2py.examples" class="headerlink" title="Permanent link"> ¶</a></h3>

    <div class="doc doc-contents first">

      <p>Download and unzip examples for tm2py, used in tests</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h4 id="tm2py.examples.get_example" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">get_example</span><span class="p">(</span><span class="n">example_name</span><span class="o">=</span><span class="s1">&#39;UnionCity&#39;</span><span class="p">,</span> <span class="n">example_subdir</span><span class="o">=</span><span class="s1">&#39;examples&#39;</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">retrieval_url</span><span class="o">=</span><span class="s1">&#39;https://mtcdrive.box.com/shared/static/3entr016e9teq2wt46x1os3fjqylfoge.zip&#39;</span><span class="p">)</span></code>


<a href="#tm2py.examples.get_example" class="headerlink" title="Permanent link"> ¶</a></h4>

    <div class="doc doc-contents ">

      <p>Returns example directory; downloads if necessary from retrieval URL.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>example_name</code></td>
        <td><code>str</code></td>
        <td><p>Used to retrieve sub-folder or create it if doesn&rsquo;t exist.
Defaults to _DEFAULT_EXAMPLE_NAME.</p></td>
        <td><code>&#39;UnionCity&#39;</code></td>
      </tr>
      <tr>
        <td><code>example_subdir</code></td>
        <td><code>str</code></td>
        <td><p>Where to find examples within root dir. Defaults
to _DEFAULT_EXAMPLE_SUBDIR.</p></td>
        <td><code>&#39;examples&#39;</code></td>
      </tr>
      <tr>
        <td><code>root_dir</code></td>
        <td><code>str</code></td>
        <td><p>Root dir of project. Defaults to _ROOT_DIR.</p></td>
        <td><code>&#39;..&#39;</code></td>
      </tr>
      <tr>
        <td><code>retrieval_url</code></td>
        <td><code>str</code></td>
        <td><p>URL to retrieve example data zip from. Defaults
to _DEFAULT_EXAMPLE_URL.</p></td>
        <td><code>&#39;https://mtcdrive.box.com/shared/static/3entr016e9teq2wt46x1os3fjqylfoge.zip&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>FileNotFoundError</code></td>
        <td><p>If can&rsquo;t find the files after trying to download it.</p></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>str</code></td>
      <td><p>Path to example data.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>tm2py/examples.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_example</span><span class="p">(</span>
    <span class="n">example_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_DEFAULT_EXAMPLE_NAME</span><span class="p">,</span>
    <span class="n">example_subdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_DEFAULT_EXAMPLE_SUBDIR</span><span class="p">,</span>
    <span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_ROOT_DIR</span><span class="p">,</span>
    <span class="n">retrieval_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_DEFAULT_EXAMPLE_URL</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Returns example directory; downloads if necessary from retrieval URL.</span>

<span class="sd">    Args:</span>
<span class="sd">        example_name (str, optional): Used to retrieve sub-folder or create it if doesn&#39;t exist.</span>
<span class="sd">            Defaults to _DEFAULT_EXAMPLE_NAME.</span>
<span class="sd">        example_subdir (str, optional): Where to find examples within root dir. Defaults</span>
<span class="sd">            to _DEFAULT_EXAMPLE_SUBDIR.</span>
<span class="sd">        root_dir (str, optional): Root dir of project. Defaults to _ROOT_DIR.</span>
<span class="sd">        retrieval_url (str, optional): URL to retrieve example data zip from. Defaults</span>
<span class="sd">            to _DEFAULT_EXAMPLE_URL.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If can&#39;t find the files after trying to download it.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to example data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_example_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">example_subdir</span><span class="p">)</span>
    <span class="n">_this_example_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_example_dir</span><span class="p">,</span> <span class="n">example_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">_this_example_dir</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_this_example_dir</span>

    <span class="n">download_unzip</span><span class="p">(</span><span class="n">retrieval_url</span><span class="p">,</span> <span class="n">_example_dir</span><span class="p">,</span> <span class="n">_this_example_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">_this_example_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;example </span><span class="si">{</span><span class="n">_this_example_dir</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_this_example_dir</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href=".." class="md-footer__link md-footer__link--prev" aria-label="Previous: Home" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Home
            </div>
          </div>
        </a>
      
      
        
        <a href="../architecture/" class="md-footer__link md-footer__link--next" aria-label="Next: Architecture" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Architecture
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs"], "search": "../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ed9748b7.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@8.5.0/dist/mermaid.min.js"></script>
      
    
  </body>
</html>